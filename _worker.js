// <!--GAMFC-->version base on commit: 20fea20e0b84aec73346333600949ec1ecfe2781 - last update: 2025-12-22 20:19:25 UTC <!--GAMFC-END-->.

import{connect}from'cloudflare:sockets';const Config={'userID':'d342d11e-d424-4583-b36e-524ab1f0afa4','proxyIPs':['nima.nscl.ir:443','bpb.yousef.isegaro.com:443'],'scamalytics':{'username':'victoriacrossn','apiKey':'ed89b4fef21aba43c15cdd15cff2138dd8d3bbde5aaaa4690ad8e94990448516','baseUrl':'https://api12.scamalytics.com/v3/'},'socks5':{'enabled':![],'relayMode':![],'address':''},async 'fromEnv'(a){let b=null;if(a['DB'])try{const {results:i}=await a['DB']['prepare']('SELECT\x20ip_port\x20FROM\x20proxy_health\x20WHERE\x20is_healthy\x20=\x201\x20ORDER\x20BY\x20latency_ms\x20ASC\x20LIMIT\x201')['all']();b=i[0x0]?.['ip_port']||null;}catch(j){console['error'](j['message']);}!b&&(b=a['PROXYIP']);!b&&(b=this['proxyIPs'][Math['floor'](Math['random']()*this['proxyIPs']['length'])]);!b&&(b=this['proxyIPs'][0x0]||'127.0.0.1:443');const [c,d='443']=b['split'](':'),f=a['SOCKS5']||this['socks5']['address'];let g=!!a['SOCKS5']||this['socks5']['enabled'],h=null;if(g&&f)try{h=socks5AddressParser(f);}catch(k){console['error'](k['message']),g=![];}return{'userID':a['UUID']||this['userID'],'proxyIP':c,'proxyPort':parseInt(d,0xa),'proxyAddress':b,'scamalytics':{'username':a['SCAMALYTICS_USERNAME']||this['scamalytics']['username'],'apiKey':a['SCAMALYTICS_API_KEY']||this['scamalytics']['apiKey'],'baseUrl':a['SCAMALYTICS_BASEURL']||this['scamalytics']['baseUrl']},'socks5':{'enabled':g,'relayMode':a['SOCKS5_RELAY']==='true'||this['socks5']['relayMode'],'address':f},'parsedSocks5Address':h};}},CONST={'ED_PARAMS':{'ed':0xa00,'eh':'Sec-WebSocket-Protocol'},'VLESS_PROTOCOL':'vless','WS_READY_STATE_OPEN':0x1,'WS_READY_STATE_CLOSING':0x2,'ADMIN_LOGIN_FAIL_LIMIT':0x5,'ADMIN_LOGIN_LOCK_TTL':0x258,'ADMIN_SESSION_TTL':0x15180,'SCAMALYTICS_THRESHOLD':0x32,'USER_PATH_RATE_LIMIT':0x14,'USER_PATH_RATE_TTL':0x3c,'IP_BLACKLIST_TTL':0xe10,'BRUTE_FORCE_LOGIN_ATTEMPTS':0xa,'BRUTE_FORCE_LOGIN_TTL':0x12c,'INVALID_UUID_ATTEMPTS':0x32,'INVALID_UUID_TTL':0x3c,'PORT_SCAN_THRESHOLD':0xa,'PORT_SCAN_TTL':0x1e,'ADMIN_AUTO_REFRESH_INTERVAL':0xea60,'IP_CLEANUP_AGE_DAYS':0x1e,'HEALTH_CHECK_INTERVAL':0x493e0,'HEALTH_CHECK_TIMEOUT':0x1388,'DB_CACHE_TTL':0xe10};function generateNonce(){const a=new Uint8Array(0x10);return crypto['getRandomValues'](a),btoa(String['fromCharCode']['apply'](null,a));}function addSecurityHeaders(a,b,c={}){const d=b?'script-src\x20\x27self\x27\x20\x27nonce-'+b+'\x27\x20\x27unsafe-inline\x27\x20https://cdnjs.cloudflare.com\x20https://unpkg.com\x20https://chart.googleapis.com':'script-src\x20\x27self\x27\x20https://cdnjs.cloudflare.com\x20https://unpkg.com\x20https://chart.googleapis.com\x20\x27unsafe-inline\x27',e='style-src\x20\x27self\x27\x20\x27unsafe-inline\x27\x20\x27unsafe-hashes\x27',f=['default-src\x20\x27self\x27','form-action\x20\x27self\x27','object-src\x20\x27none\x27','frame-ancestors\x20\x27none\x27','base-uri\x20\x27self\x27',d,e,('img-src\x20\x27self\x27\x20data:\x20blob:\x20https:\x20'+(c['img']||''))['trim'](),('connect-src\x20\x27self\x27\x20https:\x20wss:\x20'+(c['connect']||''))['trim'](),'worker-src\x20\x27self\x27\x20blob:','child-src\x20\x27self\x27\x20blob:','frame-src\x20\x27none\x27','font-src\x20\x27self\x27\x20https:\x20data:'];a['set']('Content-Security-Policy',f['join'](';\x20')),a['set']('Strict-Transport-Security','max-age=63072000;\x20includeSubDomains;\x20preload'),a['set']('X-Content-Type-Options','nosniff'),a['set']('X-Frame-Options','SAMEORIGIN'),a['set']('Referrer-Policy','strict-origin-when-cross-origin'),a['set']('Permissions-Policy','camera=(),\x20microphone=(),\x20geolocation=(),\x20payment=(),\x20usb=()'),a['set']('alt-svc','h3=\x22:443\x22;\x20ma=0'),a['set']('Cross-Origin-Opener-Policy','same-origin'),a['set']('Cross-Origin-Embedder-Policy','unsafe-none'),a['set']('Cross-Origin-Resource-Policy','cross-origin'),a['set']('X-XSS-Protection','1;\x20mode=block');}function timingSafeEqual(c,d){if(typeof c!=='string'||typeof d!=='string')return![];const e=c['length'],f=d['length'];let g=0x0;if(e!==f){for(let h=0x0;h<e;h++){g|=c['charCodeAt'](h)^c['charCodeAt'](h);}return![];}for(let j=0x0;j<e;j++){g|=c['charCodeAt'](j)^d['charCodeAt'](j);}return g===0x0;}function escapeHTML(a){if(typeof a!=='string')return'';const b={'&':'&amp;','<':'&lt;','>':'&gt;','\x22':'&quot;','\x27':'&#39;'};return a['replace'](/[&<>"']/g,c=>b[c]);}function safeBase64Encode(a){try{const b=new TextEncoder(),c=b['encode'](a);let d='';for(let f=0x0;f<c['length'];f++){d+=String['fromCharCode'](c[f]);}return btoa(d);}catch(g){return btoa(unescape(encodeURIComponent(a)));}}function generateUUID(){return crypto['randomUUID']();}function isValidUUID(a){if(typeof a!=='string')return![];const b=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;return b['test'](a);}function isExpired(a,b){if(!a||!b)return!![];const c=b['includes'](':')&&b['split'](':')['length']===0x2?b+':00':b['split']('.')[0x0],d=new Date(a+'T'+c+'Z');return isNaN(d['getTime']())||d<=new Date();}async function formatBytes(a){if(a===0x0||a===null||a===undefined)return'0\x20Bytes';const b=0x400,c=['Bytes','KB','MB','GB','TB','PB','EB'],d=Math['floor'](Math['log'](a)/Math['log'](b));return parseFloat(a/Math['pow'](b,d))['toFixed'](0x2)+'\x20'+c[d];}function base32ToBuffer(a){const b='ABCDEFGHIJKLMNOPQRSTUVWXYZ234567',c=a['toUpperCase']()['replace'](/=+$/,'');let d=0x0,e=0x0,f=0x0;const g=new Uint8Array(Math['floor'](c['length']*0x5/0x8));for(let h=0x0;h<c['length'];h++){const j=c[h],k=b['indexOf'](j);if(k===-0x1)throw new Error('Invalid\x20Base32\x20character');e=e<<0x5|k,d+=0x5,d>=0x8&&(g[f++]=e>>>d-0x8&0xff,d-=0x8);}return g['buffer']['slice'](0x0,f);}async function generateHOTP(a,b){const c=new ArrayBuffer(0x8);new DataView(c)['setBigUint64'](0x0,BigInt(b),![]);const d=await crypto['subtle']['importKey']('raw',a,{'name':'HMAC','hash':'SHA-1'},![],['sign']),e=await crypto['subtle']['sign']('HMAC',d,c),f=new Uint8Array(e),g=f[f['length']-0x1]&0xf,h=(f[g]&0x7f)<<0x18|(f[g+0x1]&0xff)<<0x10|(f[g+0x2]&0xff)<<0x8|f[g+0x3]&0xff,i=h%0xf4240;return i['toString']()['padStart'](0x6,'0');}async function validateTOTP(a,b){if(!a||!b||b['length']!==0x6||!/^\d{6}$/['test'](b))return![];let c;try{c=base32ToBuffer(a);}catch(i){return console['error'](i['message']),![];}const d=0x1e,f=Math['floor'](Date['now']()/0x3e8),g=Math['floor'](f/d),h=[g,g-0x1,g+0x1];for(const j of h){const k=await generateHOTP(c,j);if(timingSafeEqual(b,k))return!![];}return![];}async function hashSHA256(a){const b=new TextEncoder(),c=b['encode'](a),d=await crypto['subtle']['digest']('SHA-256',c),e=Array['from'](new Uint8Array(d));return e['map'](f=>f['toString'](0x10)['padStart'](0x2,'0'))['join']('');}async function d1KvGet(a,b,c='text'){if(!a)return null;try{const d=a['prepare']('SELECT\x20value,\x20expiration\x20FROM\x20key_value\x20WHERE\x20key\x20=\x20?')['bind'](b),f=await d['first']();if(!f)return null;if(f['expiration']&&f['expiration']<Math['floor'](Date['now']()/0x3e8))return a['prepare']('DELETE\x20FROM\x20key_value\x20WHERE\x20key\x20=\x20?')['bind'](b)['run']()['catch'](g=>console['error'](g['message'])),null;if(c==='json')try{return JSON['parse'](f['value']);}catch(g){return console['error'](g['message']),null;}return f['value'];}catch(h){return console['error'](h['message'],h['stack']),null;}}async function d1KvPut(a,b,c,d={}){if(!a)return;try{let f=c;typeof c==='object'&&c!==null&&(f=JSON['stringify'](c));const g=d['expirationTtl']?Math['floor'](Date['now']()/0x3e8+d['expirationTtl']):null;await a['prepare']('INSERT\x20OR\x20REPLACE\x20INTO\x20key_value\x20(key,\x20value,\x20expiration)\x20VALUES\x20(?,\x20?,\x20?)')['bind'](b,f,g)['run']();}catch(h){console['error'](h['message']);}}async function d1KvDelete(a,b){if(!a)return;try{await a['prepare']('DELETE\x20FROM\x20key_value\x20WHERE\x20key\x20=\x20?')['bind'](b)['run']();}catch(c){console['error'](c['message']);}}async function checkRateLimit(a,b,c,d){if(!a)return![];try{const f=await d1KvGet(a,b),g=parseInt(f,0xa)||0x0;if(g>=c)return!![];return await d1KvPut(a,b,(g+0x1)['toString'](),{'expirationTtl':d}),![];}catch(h){return console['error'](h['message']),![];}}async function logSecurityEvent(a,b,c,d,f,g=null){if(!a)return;try{const h=Math['floor'](Date['now']()/0x3e8),i=a['prepare']('INSERT\x20INTO\x20security_events\x20(timestamp,\x20ip,\x20type,\x20details,\x20uuid)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?)')['bind'](h,c,d,f,g);b['waitUntil'](i['run']()['catch'](j=>console['error'](j['message'])));}catch(j){console['error'](j['message'],j['stack']);}}async function addIpToBlacklist(a,b,c,d,f=CONST['IP_BLACKLIST_TTL']){if(!a)return;try{const g=f===0x0?Math['floor'](Date['now']()/0x3e8)+0x16d*0x18*0xe10*0x64:Math['floor'](Date['now']()/0x3e8+f),h=a['prepare']('INSERT\x20OR\x20REPLACE\x20INTO\x20ip_blacklist\x20(ip,\x20expiration,\x20reason,\x20timestamp)\x20VALUES\x20(?,\x20?,\x20?,\x20?)')['bind'](c,g,d,Math['floor'](Date['now']()/0x3e8));b['waitUntil'](h['run']()['then'](()=>{logSecurityEvent(a,b,c,'IP_BLACKLISTED','IP\x20blacklisted\x20for\x20'+d+'.\x20TTL:\x20'+f+'s.',null);})['catch'](i=>console['error'](i['message'])));}catch(i){console['error'](i['message'],i['stack']);}}async function checkBlockedIP(a,b){if(!a)return null;try{const c=Math['floor'](Date['now']()/0x3e8),d=a['prepare']('SELECT\x20*\x20FROM\x20ip_blacklist\x20WHERE\x20ip\x20=\x20?')['bind'](b),f=await d['first']();if(f&&f['expiration']>c)return f;else f&&f['expiration']<=c&&a['prepare']('DELETE\x20FROM\x20ip_blacklist\x20WHERE\x20ip\x20=\x20?')['bind'](b)['run']()['catch'](g=>console['error'](g['message']));return null;}catch(g){return console['error'](g['message']),null;}}const byteToHex=Array['from']({'length':0x100},(a,b)=>(b+0x100)['toString'](0x10)['slice'](0x1));function unsafeStringify(a,b=0x0){return(byteToHex[a[b]]+byteToHex[a[b+0x1]]+byteToHex[a[b+0x2]]+byteToHex[a[b+0x3]]+'-'+byteToHex[a[b+0x4]]+byteToHex[a[b+0x5]]+'-'+byteToHex[a[b+0x6]]+byteToHex[a[b+0x7]]+'-'+byteToHex[a[b+0x8]]+byteToHex[a[b+0x9]]+'-'+byteToHex[a[b+0xa]]+byteToHex[a[b+0xb]]+byteToHex[a[b+0xc]]+byteToHex[a[b+0xd]]+byteToHex[a[b+0xe]]+byteToHex[a[b+0xf]])['toLowerCase']();}function stringify(a,b=0x0){const c=unsafeStringify(a,b);if(!isValidUUID(c))throw new TypeError('Stringified\x20UUID\x20is\x20invalid\x20or\x20malformed:\x20'+c);return c;}async function getUserData(a,b,c){if(!isValidUUID(b))return console['warn']('Invalid\x20UUID\x20format:\x20'+b),null;if(!a['DB'])return console['error']('D1\x20binding\x20missing.\x20Cannot\x20retrieve\x20user\x20data.'),null;const d='user:'+b;let f=null;try{f=await d1KvGet(a['DB'],d,'json');if(f&&f['uuid'])return f;}catch(i){console['error'](i['message']);}const g=await a['DB']['prepare']('SELECT\x20*\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](b)['first']();if(!g)return f&&c['waitUntil'](d1KvDelete(a['DB'],d)),null;const h=d1KvPut(a['DB'],d,g,{'expirationTtl':CONST['DB_CACHE_TTL']});return c?c['waitUntil'](h['catch'](j=>console['error'](j['message']))):await h['catch'](j=>console['error'](j['message'])),g;}async function updateUsage(a,b,c,d){if(c<=0x0||!b)return;if(!a['DB']){console['error']('D1\x20binding\x20missing.\x20Cannot\x20update\x20user\x20usage.');return;}const f='usage_lock:'+b;let g=![];const h=0x5;try{const j=0x5;for(let n=0x0;n<j;n++){const o=await d1KvGet(a['DB'],f);if(!o){await d1KvPut(a['DB'],f,'locked',{'expirationTtl':h}),g=!![];break;}else await new Promise(p=>setTimeout(p,0x64*(n+0x1)));}if(!g){console['warn']('Failed\x20to\x20acquire\x20lock\x20for\x20'+b+'\x20after\x20attempts.\x20Skipping\x20usage\x20update.');return;}const k=Math['round'](c),l=a['DB']['prepare']('UPDATE\x20users\x20SET\x20traffic_used\x20=\x20traffic_used\x20+\x20?\x20WHERE\x20uuid\x20=\x20?')['bind'](k,b)['run'](),m=d1KvDelete(a['DB'],'user:'+b);d?d['waitUntil'](Promise['all']([l,m])['catch'](p=>console['error'](p))):await Promise['all']([l,m])['catch'](p=>console['error'](p));}catch(p){console['error'](p['message'],p['stack']);}finally{if(g)try{d['waitUntil'](d1KvDelete(a['DB'],f)['catch'](q=>console['error'](q['message'])));}catch(q){console['error'](q['message']);}}}async function resolveProxyIP(a){const b=/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/,c=/^\[?([0-9a-fA-F:.]+)\]?$/;if(b['test'](a)||c['test'](a))return a;const d=[{'url':'https://cloudflare-dns.com/dns-query?name='+encodeURIComponent(a)+'&type=A','parse':f=>f['Answer']?.['find'](g=>g['type']===0x1)?.['data']},{'url':'https://dns.google/resolve?name='+encodeURIComponent(a)+'&type=A','parse':f=>f['Answer']?.['find'](g=>g['type']===0x1)?.['data']},{'url':'https://dns.quad9.net/dns-query?name='+encodeURIComponent(a)+'&type=A','parse':f=>f['Answer']?.['find'](g=>g['type']===0x1)?.['data']}];for(const f of d){try{const g=new AbortController(),h=setTimeout(()=>g['abort'](),0xbb8),i=await fetch(f['url'],{'headers':{'accept':'application/dns-json'},'signal':g['signal']});clearTimeout(h);if(i['ok']){const j=await i['json'](),k=f['parse'](j);if(k&&b['test'](k))return k;}}catch(l){}}return console['warn']('Failed\x20to\x20resolve\x20IP\x20for\x20'+a+'\x20after\x20trying\x20all\x20DNS\x20providers.\x20Using\x20original\x20hostname\x20as\x20fallback.'),a;}async function getGeo(a,b=null){if(b&&(b['city']||b['country']||b['asOrganization']))return{'city':b['city']||'','country':b['country']||'','isp':b['asOrganization']||''};const c=[{'url':'https://ip-api.com/json/'+a+'?fields=status,message,city,country,isp','parse':async d=>{const f=await d['json']();if(f['status']==='fail')throw new Error(f['message']||'API\x20Error');return{'city':f['city']||'','country':f['country']||'','isp':f['isp']||''};}},{'url':'https://ipapi.co/'+a+'/json/','parse':async d=>{const f=await d['json']();if(f['error'])throw new Error(f['reason']||'API\x20Error');return{'city':f['city']||'','country':f['country_name']||'','isp':f['org']||''};}},{'url':'https://ipwho.is/'+a,'parse':async d=>{const f=await d['json']();if(!f['success'])throw new Error('API\x20Error');return{'city':f['city']||'','country':f['country']||'','isp':f['connection']?.['isp']||''};}},{'url':'https://ipinfo.io/'+a+'/json','parse':async d=>{const f=await d['json']();if(f['bogon'])throw new Error('Bogon\x20IP');return{'city':f['city']||'','country':f['country']||'','isp':f['org']||''};}},{'url':'https://freeipapi.com/api/json/'+a,'parse':async d=>{const f=await d['json']();if(f['message'])throw new Error(f['message']);return{'city':f['cityName']||'','country':f['countryName']||'','isp':''};}}];for(const d of c){try{const f=new AbortController(),g=setTimeout(()=>f['abort'](),0xbb8),h=await fetch(d['url'],{'signal':f['signal'],'headers':{'Accept':'application/json'}});clearTimeout(g);if(h['ok']){const i=await d['parse'](h);if(i&&(i['city']||i['country']||i['isp']))return i;}}catch(j){}}return console['warn']('Failed\x20to\x20get\x20geo-location\x20for\x20IP\x20'+a+'\x20after\x20trying\x20all\x20providers.'),{'city':'Unknown','country':'Global','isp':'Unknown'};}function generateRandomPath(a=0xc){const b='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';let c='';for(let d=0x0;d<a;d++){c+=b['charAt'](Math['floor'](Math['random']()*b['length']));}return'/'+c;}const CORE_PRESETS={'xray':{'tls':{'path':()=>generateRandomPath(0xc),'security':'tls','fp':'chrome','alpn':'http/1.1','extra':{'ed':'2560'}},'tcp':{'path':()=>generateRandomPath(0xc),'security':'none','fp':'chrome','extra':{'ed':'2560'}}},'sb':{'tls':{'path':()=>generateRandomPath(0x12),'security':'tls','fp':'firefox','alpn':'h3','extra':CONST['ED_PARAMS']},'tcp':{'path':()=>generateRandomPath(0x12),'security':'none','fp':'firefox','extra':CONST['ED_PARAMS']}}};function makeName(a,b){return a+'-'+b['toUpperCase']();}function randomizeCase(a){if(!a)return a;let b='';for(let c=0x0;c<a['length'];c++){b+=Math['random']()<0.5?a[c]['toUpperCase']():a[c]['toLowerCase']();}return b;}function createVlessLink({userID:a,address:b,port:c,host:d,path:e,security:f,sni:g,fp:h,alpn:i,extra:extra={},name:j}){const l=new URLSearchParams({'encryption':'none','type':'ws','host':d,'path':e});f&&l['set']('security',f);if(g)l['set']('sni',g);if(h)l['set']('fp',h);if(i)l['set']('alpn',i);for(const [m,n]of Object['entries'](extra)){l['set'](m,n);}return'vless://'+a+'@'+b+':'+c+'?'+l['toString']()+'#'+encodeURIComponent(j);}function buildLink({core:a,proto:b,userID:c,hostName:d,address:e,port:f,tag:g}){const h=CORE_PRESETS[a]?.[b];if(!h)return console['error']('Invalid\x20core\x20or\x20protocol\x20preset\x20requested:\x20core='+a+',\x20proto='+b+'.\x20Falling\x20back\x20to\x20default\x20TLS\x20config.'),createVlessLink({'userID':c,'address':e,'port':f,'host':d,'path':generateRandomPath(0xc),'security':'tls','sni':d,'fp':'chrome','alpn':'http/1.1','name':makeName(g,'DEFAULT_TLS')});const i=h['security']==='tls'?randomizeCase(d):undefined;return createVlessLink({'userID':c,'address':e,'port':f,'host':d,'path':h['path'](),'security':h['security'],'sni':i,'fp':h['fp'],'alpn':h['alpn'],'extra':h['extra'],'name':makeName(g,b)});}const pick=a=>a[Math['floor'](Math['random']()*a['length'])];async function handleIpSubscription(a,b,c,d){const f=[c,'www.visa.com','www.wto.org','creativecommons.org','www.speedtest.net','sky.rethinkdns.com','cdnjs.com','zula.ir','go.inmobi.com','mail.tm','temp-mail.org','ipaddress.my','mdbmax.com','check-host.net','kodambroker.com','iplocation.io','whatismyip.org','www.linkedin.com','exir.io','arzex.io','ok-ex.io','arzdigital.com','pouyanit.com','auth.grok.com','grok.com','maxmind.com','whatsmyip.com','iplocation.net','ipchicken.com','showmyip.com','router-network.com','whatismyipaddress.com','www.apple.com','www.microsoft.com','www.amazon.com','www.cloudflare.com','www.google.com','github.com','gitlab.com','wikipedia.org','developer.mozilla.org','www.nginx.com','www.apache.org','telegram.org','bale.ai','ir.linkedin.com','divar.ir','snapp.ir','jiring.ir','shaparak.ir','pishgaman.net','asriran.com','varzesh3.com','isna.ir','farsnews.ir','mehrnews.com','tasnimnews.com']['sort'](()=>0.5-Math['random']()),g=[0x1bb,0x20fb,0x805,0x823,0x827,0x830,0x114e,0x114f,0x1150,0x1151,0x1152,0x1153,0x1154,0x1155,0x1156,0x1157],h=[0x50,0x1f90,0x22b0,0x804,0x822,0x826,0x82f,0x1f40,0x1f48,0x1f49,0x1f4a,0x1f4b,0x1f4c,0x1f4d,0x1f4e,0x1f4f];let i=[];const j=c['endsWith']('.pages.dev');f['slice'](0x0,0xf)['forEach']((n,o)=>{i['push'](buildLink({'core':a,'proto':'tls','userID':b,'hostName':c,'address':n,'port':pick(g),'tag':'D'+(o+0x1)+'-TLS-1'}),buildLink({'core':a,'proto':'tls','userID':b,'hostName':c,'address':n,'port':pick(g),'tag':'D'+(o+0x1)+'-TLS-2'})),!j&&i['push'](buildLink({'core':a,'proto':'tcp','userID':b,'hostName':c,'address':n,'port':pick(h),'tag':'D'+(o+0x1)+'-TCP-1'}),buildLink({'core':a,'proto':'tcp','userID':b,'hostName':c,'address':n,'port':pick(h),'tag':'D'+(o+0x1)+'-TCP-2'}));});let k=[];if(d['DB'])try{const {results:n}=await d['DB']['prepare']('SELECT\x20ip_port,\x20latency_ms\x20FROM\x20proxy_health\x20WHERE\x20is_healthy\x20=\x201\x20ORDER\x20BY\x20latency_ms\x20ASC\x20LIMIT\x2020')['all']();k=n['map'](o=>o['ip_port']['split'](':')[0x0]);}catch(o){console['error'](o['message']);}if(k['length']===0x0)try{const p=await fetch('https://raw.githubusercontent.com/NiREvil/vless/refs/heads/main/Cloudflare-IPs.json');if(p['ok']){const q=await p['json']();k=[...q['ipv4']||[],...q['ipv6']||[]]['slice'](0x0,0x1e)['map'](s=>s['ip']);}else console['warn']('Failed\x20to\x20fetch\x20Cloudflare\x20IPs:\x20HTTP\x20Status\x20'+p['status']);}catch(s){console['error'](s['message'],s['stack']);}k['slice'](0x0,0x14)['forEach']((t,u)=>{const v=t['includes'](':')?'['+t+']':t;i['push'](buildLink({'core':a,'proto':'tls','userID':b,'hostName':c,'address':v,'port':pick(g),'tag':'IP'+(u+0x1)+'-TLS-1'}),buildLink({'core':a,'proto':'tls','userID':b,'hostName':c,'address':v,'port':pick(g),'tag':'IP'+(u+0x1)+'-TLS-2'})),!j&&i['push'](buildLink({'core':a,'proto':'tcp','userID':b,'hostName':c,'address':v,'port':pick(h),'tag':'IP'+(u+0x1)+'-TCP-1'}),buildLink({'core':a,'proto':'tcp','userID':b,'hostName':c,'address':v,'port':pick(h),'tag':'IP'+(u+0x1)+'-TCP-2'}));});const l=Array['from'](new Set(i))['sort'](()=>0.5-Math['random']()),m=new Headers({'Content-Type':'text/plain;charset=utf-8','Profile-Update-Interval':'6','Cache-Control':'no-cache,\x20no-store,\x20must-revalidate','Pragma':'no-cache','Expires':'0'});return addSecurityHeaders(m,null,{}),new Response(safeBase64Encode(l['join']('\x0a')),{'headers':m});}async function ensureTablesExist(a,b){if(!a['DB']){console['warn']('D1\x20binding\x20not\x20available.\x20Skipping\x20table\x20creation.');return;}try{const c=['CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20users\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20uuid\x20TEXT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20created_at\x20DATETIME\x20DEFAULT\x20CURRENT_TIMESTAMP,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20expiration_date\x20TEXT\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20expiration_time\x20TEXT\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20notes\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20traffic_limit\x20INTEGER,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20traffic_used\x20INTEGER\x20DEFAULT\x200,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ip_limit\x20INTEGER\x20DEFAULT\x20-1\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20user_ips\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20uuid\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ip\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20last_seen\x20DATETIME\x20DEFAULT\x20CURRENT_TIMESTAMP,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20PRIMARY\x20KEY\x20(uuid,\x20ip),\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20FOREIGN\x20KEY\x20(uuid)\x20REFERENCES\x20users(uuid)\x20ON\x20DELETE\x20CASCADE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20key_value\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20key\x20TEXT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20value\x20TEXT\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20expiration\x20INTEGER\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20proxy_health\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ip_port\x20TEXT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20is_healthy\x20INTEGER\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20latency_ms\x20INTEGER,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20last_check\x20INTEGER\x20DEFAULT\x20(strftime(\x27%s\x27,\x20\x27now\x27))\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20security_events\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20id\x20INTEGER\x20PRIMARY\x20KEY\x20AUTOINCREMENT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20timestamp\x20INTEGER\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ip\x20TEXT\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20type\x20TEXT\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20details\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20uuid\x20TEXT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20ip_blacklist\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ip\x20TEXT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20expiration\x20INTEGER\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20reason\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20timestamp\x20INTEGER\x20NOT\x20NULL\x20DEFAULT\x20(strftime(\x27%s\x27,\x20\x27now\x27))\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)'],d=c['map'](k=>a['DB']['prepare'](k));await a['DB']['batch'](d);const f=a['UUID']||Config['userID'],g=new Date();g['setMonth'](g['getMonth']()+0x1);const h=g['toISOString']()['split']('T')[0x0],i='23:59:59',j=a['DB']['prepare']('INSERT\x20OR\x20IGNORE\x20INTO\x20users\x20(uuid,\x20expiration_date,\x20expiration_time,\x20notes,\x20traffic_limit,\x20traffic_used,\x20ip_limit)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)')['bind'](f,h,i,'Test\x20User\x20-\x20Development',null,0x40000000,-0x1);await j['run'](),console['log']('D1\x20tables\x20initialized\x20successfully\x20and\x20test\x20user\x20ensured.');}catch(k){console['error'](k['message'],k['stack']);throw new Error('Database\x20initialization\x20failed.\x20Critical\x20error:\x20'+k['message']);}}async function performHealthCheck(a,b){if(!a['DB']){console['warn']('D1\x20binding\x20not\x20available.\x20Skipping\x20health\x20checks.');return;}const c=a['PROXYIPS']?a['PROXYIPS']['split'](',')['map'](g=>g['trim']()):Config['proxyIPs'],d=[],f=await Promise['allSettled'](c['map'](async g=>{const [h,i='443']=g['split'](':');let j=null,k=0x0;const l=Date['now']();try{const m=new AbortController(),n=setTimeout(()=>m['abort'](),CONST['HEALTH_CHECK_TIMEOUT']),o=await fetch('https://'+h+':'+i,{'method':'HEAD','signal':m['signal'],'redirect':'manual'});clearTimeout(n),o['ok']||o['status']>=0x190&&o['status']<0x1f4?(j=Date['now']()-l,k=0x1):console['warn']('Health\x20check\x20for\x20'+g+'\x20failed:\x20HTTP\x20Status\x20'+o['status']+'.');}catch(p){p['name']==='AbortError'?console['error']('Health\x20check\x20for\x20'+g+'\x20timed\x20out\x20after\x20'+CONST['HEALTH_CHECK_TIMEOUT']+'ms.'):console['error']('Health\x20check\x20failed\x20for\x20'+g+':\x20'+p['message']+'.');}finally{d['push'](a['DB']['prepare']('INSERT\x20OR\x20REPLACE\x20INTO\x20proxy_health\x20(ip_port,\x20is_healthy,\x20latency_ms,\x20last_check)\x20VALUES\x20(?,\x20?,\x20?,\x20?)')['bind'](g,k,j,Math['floor'](Date['now']()/0x3e8)));}}));f['filter'](g=>g['status']==='rejected')['forEach'](g=>console['error'](g['reason']));try{await a['DB']['batch'](d),console['log']('Proxy\x20health\x20check\x20and\x20database\x20update\x20completed.');}catch(g){console['error'](g['message'],g['stack']);throw new Error('Failed\x20to\x20batch\x20update\x20proxy\x20health\x20status\x20in\x20D1:\x20'+g['message']);}}async function cleanupOldIps(a,b){if(!a['DB']){console['warn']('D1\x20binding\x20not\x20available.\x20Skipping\x20data\x20cleanup.');return;}try{const c=[];c['push'](a['DB']['prepare']('DELETE\x20FROM\x20user_ips\x20WHERE\x20last_seen\x20<\x20datetime(\x27now\x27,\x20?)')['bind']('-'+CONST['IP_CLEANUP_AGE_DAYS']+'\x20days')['run']()),c['push'](a['DB']['prepare']('DELETE\x20FROM\x20ip_blacklist\x20WHERE\x20expiration\x20<=\x20?')['bind'](Math['floor'](Date['now']()/0x3e8))['run']()),c['push'](a['DB']['prepare']('DELETE\x20FROM\x20key_value\x20WHERE\x20expiration\x20<=\x20?')['bind'](Math['floor'](Date['now']()/0x3e8))['run']()),await Promise['all'](c['map'](d=>d['catch'](f=>console['error'](f['message'])))),console['log']('Cleaned\x20up\x20user_ips\x20records\x20older\x20than\x20'+CONST['IP_CLEANUP_AGE_DAYS']+'\x20days\x20and\x20expired\x20blacklist/key_value\x20entries.');}catch(d){console['error'](d['message'],d['stack']);throw new Error('Failed\x20to\x20perform\x20scheduled\x20database\x20cleanup:\x20'+d['message']);}}async function ProtocolOverWSHandler(a,b,c,d){let f=null;try{const g=a['headers']['get']('CF-Connecting-IP'),h=await checkBlockedIP(c['DB'],g);if(h)return console['warn']('VLESS\x20connection\x20denied\x20for\x20blacklisted\x20IP:\x20'+g+'\x20(Reason:\x20'+(h['reason']||'Generic')+').'),d['waitUntil'](logSecurityEvent(c['DB'],d,g,'VLESS_ACCESS_DENIED','Attempted\x20VLESS\x20connection\x20from\x20blacklisted\x20IP:\x20'+g+'.')),new Response('Access\x20Denied:\x20Your\x20IP\x20address\x20is\x20currently\x20blocked\x20due\x20to\x20suspicious\x20activity.\x20Please\x20contact\x20support.',{'status':0x193});if(b['scamalytics']['username']&&b['scamalytics']['apiKey']){if(await isSuspiciousIP(g,b['scamalytics'],c['SCAMALYTICS_THRESHOLD']||CONST['SCAMALYTICS_THRESHOLD']))return console['warn']('VLESS\x20connection\x20denied\x20for\x20suspicious\x20IP:\x20'+g+'\x20(Scamalytics).'),d['waitUntil'](logSecurityEvent(c['DB'],d,g,'VLESS_ACCESS_DENIED','Scamalytics\x20score\x20too\x20high.\x20IP:\x20'+g+'.')),d['waitUntil'](addIpToBlacklist(c['DB'],d,g,'Scamalytics\x20High\x20Score',CONST['IP_BLACKLIST_TTL'])),new Response('Access\x20Denied:\x20Suspicious\x20IP\x20detected.',{'status':0x193});}const i=new WebSocketPair(),[j,k]=Object['values'](i);f=k,f['accept']();let l='',m=0x0,n=0x0,o='',p=null;const q=(x,y=null)=>{const z=o?o['substring'](0x0,0x8):'unknown',A=l&&m?l+':'+m:'unknown_target';console['log']('['+z+']['+A+']\x20'+x,y);},r=()=>{if(n>0x0&&o){const x=n,y=o;n=0x0,d['waitUntil'](updateUsage(c,y,x,d)['catch'](z=>console['error'](z)));}},s=setInterval(r,0x2710),t=()=>{clearInterval(s),r(),q('WebSocket\x20session\x20ended.\x20Final\x20usage\x20logged\x20and\x20resources\x20cleaned.');};f['addEventListener']('close',t,{'once':!![]}),f['addEventListener']('error',t,{'once':!![]});const u=a['headers']['get']('Sec-WebSocket-Protocol')||'',v=MakeReadableWebSocketStream(f,u,q);let w={'value':null};return v['pipeTo'](new WritableStream({async 'write'(x,y){n+=x['byteLength'];if(p)return p['write'](x);if(w['value']){const K=w['value']['writable']['getWriter']();await K['write'](x),K['releaseLock']();return;}const {user:z,hasError:A,message:B,addressType:C,portRemote:D,addressRemote:E,rawDataIndex:F,ProtocolVersion:G,isUDP:H}=await ProcessProtocolHeader(x,c,d);if(A||!z){q('Authentication/Protocol\x20Error:\x20'+B,A?new Error(B):undefined);if(B?.['includes']('invalid\x20UUID')||B?.['includes']('user\x20not\x20found')){const L='invalid_uuid_attempt:'+g,M=parseInt(await d1KvGet(c['DB'],L)||'0',0xa)+0x1;d['waitUntil'](d1KvPut(c['DB'],L,M['toString'](),{'expirationTtl':CONST['INVALID_UUID_TTL']})),d['waitUntil'](logSecurityEvent(c['DB'],d,g,'INVALID_UUID_ATTEMPT','Invalid\x20or\x20unknown\x20UUID\x20in\x20VLESS\x20header.\x20UUID:\x20'+(z?.['uuid']||'N/A')+'.')),M>=CONST['INVALID_UUID_ATTEMPTS']&&(console['warn']('Too\x20many\x20invalid\x20UUID\x20attempts\x20from\x20'+g+'.\x20Blacklisting.'),d['waitUntil'](addIpToBlacklist(c['DB'],d,g,'Repeated\x20invalid\x20UUID\x20attempts',CONST['IP_BLACKLIST_TTL'])));}y['error'](new Error(B||'Authentication\x20failed.')),safeCloseWebSocket(f);return;}o=z['uuid'],l=E,m=D;if(isExpired(z['expiration_date'],z['expiration_time'])){q('Account\x20expired.'),d['waitUntil'](logSecurityEvent(c['DB'],d,g,'ACCOUNT_EXPIRED','Expired\x20account\x20attempting\x20VLESS\x20connection.\x20UUID:\x20'+o+'.')),y['error'](new Error('Account\x20expired.')),safeCloseWebSocket(f);return;}if(z['traffic_limit']&&z['traffic_limit']>0x0){const N=(z['traffic_used']||0x0)+n;if(N>=z['traffic_limit']){q('Traffic\x20limit\x20exceeded.'),d['waitUntil'](logSecurityEvent(c['DB'],d,g,'TRAFFIC_LIMIT_EXCEEDED','Traffic\x20limit\x20exceeded\x20for\x20VLESS\x20connection.\x20UUID:\x20'+o+'.')),y['error'](new Error('Traffic\x20limit\x20exceeded.')),safeCloseWebSocket(f);return;}}if(z['ip_limit']&&z['ip_limit']>-0x1){const O=await c['DB']['prepare']('SELECT\x20COUNT(DISTINCT\x20ip)\x20as\x20count\x20FROM\x20user_ips\x20WHERE\x20uuid\x20=\x20?')['bind'](o)['first']('count'),P=O?.['count']||0x0;if(P>=z['ip_limit']){const Q=await c['DB']['prepare']('SELECT\x20ip\x20FROM\x20user_ips\x20WHERE\x20uuid\x20=\x20?\x20AND\x20ip\x20=\x20?')['bind'](o,g)['first']();if(!Q){q('IP\x20limit\x20exceeded\x20for\x20user\x20'+o+'.\x20Current\x20IP:\x20'+g+'.'),d['waitUntil'](logSecurityEvent(c['DB'],d,g,'IP_LIMIT_EXCEEDED','IP\x20limit\x20exceeded\x20for\x20VLESS\x20connection.\x20UUID:\x20'+o+'.\x20IP:\x20'+g+'.')),y['error'](new Error('IP\x20limit\x20exceeded.')),safeCloseWebSocket(f);return;}}d['waitUntil'](c['DB']['prepare']('INSERT\x20OR\x20REPLACE\x20INTO\x20user_ips\x20(uuid,\x20ip,\x20last_seen)\x20VALUES\x20(?,\x20?,\x20CURRENT_TIMESTAMP)')['bind'](o,g)['run']()['catch'](R=>console['error'](R['message'])));}if(D&&![0x50,0x1bb,0x20fb,0x805,0x823,0x827,0x830,0x35]['includes'](D)){const R='port_scan:'+g,S=await d1KvGet(c['DB'],R)||'',T=new Set(S['split'](',')['filter'](Boolean)['map'](Number));if(!T['has'](D)){T['add'](D),d['waitUntil'](d1KvPut(c['DB'],R,Array['from'](T)['join'](','),{'expirationTtl':CONST['PORT_SCAN_TTL']})),d['waitUntil'](logSecurityEvent(c['DB'],d,g,'PORT_SCAN_ATTEMPT','Attempted\x20to\x20access\x20non-standard\x20port:\x20'+D+'.\x20Unique\x20ports\x20in\x20window:\x20'+T['size']+'.',o));if(T['size']>=CONST['PORT_SCAN_THRESHOLD']){console['warn']('Port\x20scan\x20detected\x20from\x20'+g+'.\x20Blacklisting.'),d['waitUntil'](addIpToBlacklist(c['DB'],d,g,'Port\x20scanning\x20activity\x20detected',CONST['IP_BLACKLIST_TTL'])),y['error'](new Error('Port\x20scan\x20detected.\x20Connection\x20denied.')),safeCloseWebSocket(f);return;}}}const I=new Uint8Array([G[0x0],0x0]),J=x['slice'](F);if(H){if(m===0x35){const U=await createDnsPipeline(f,I,q,V=>{n+=V;});p=U['write'],await p(J);}else q('UDP\x20command\x20to\x20unsupported\x20port\x20'+m+'.\x20Closing\x20connection.'),d['waitUntil'](logSecurityEvent(c['DB'],d,g,'UNSUPPORTED_UDP','Attempted\x20UDP\x20connection\x20to\x20unsupported\x20port:\x20'+m+'.',o)),y['error'](new Error('UDP\x20only\x20supported\x20for\x20DNS\x20(port\x2053).')),safeCloseWebSocket(f);return;}await HandleTCPOutBound(w,C,E,D,J,f,I,q,b,V=>{n+=V;});},'close'(){q('Readable\x20WebSocket\x20stream\x20closed.'),t();},'abort'(x){q('Readable\x20WebSocket\x20stream\x20aborted.',x),t();}}))['catch'](x=>{console['error'](x['stack']||x),safeCloseWebSocket(f),t();}),new Response(null,{'status':0x65,'webSocket':j});}catch(x){console['error'](x['message'],x['stack']);if(f)try{safeCloseWebSocket(f);}catch(z){console['error'](z);}const y=new Headers();return addSecurityHeaders(y,null,{}),new Response('Internal\x20Server\x20Error.',{'status':0x1f4,'headers':y});}}async function ProcessProtocolHeader(a,b,c){try{if(a['byteLength']<0x18)return{'hasError':!![],'message':'Invalid\x20data\x20length\x20in\x20VLESS\x20header:\x20'+a['byteLength']+'\x20bytes.\x20Too\x20short.'};const d=new DataView(a['buffer']||a),f=d['getUint8'](0x0);if(f!==0x0)return{'hasError':!![],'message':'Unsupported\x20VLESS\x20protocol\x20version:\x20'+f+'.\x20Expected\x200x00.'};let g;try{g=stringify(new Uint8Array(a['slice'](0x1,0x11)));}catch(u){return{'hasError':!![],'message':'Invalid\x20UUID\x20format\x20in\x20VLESS\x20header:\x20'+u['message']+'.'};}const h=await getUserData(b,g,c);if(!h)return{'hasError':!![],'message':'User\x20'+g+'\x20not\x20found\x20or\x20invalid.'};const i=0x11,j=d['getUint8'](i),k=i+0x1+j;if(a['byteLength']<k+0x1)return{'hasError':!![],'message':'Invalid\x20data\x20length\x20(command\x20field\x20missing\x20in\x20VLESS\x20header).'};const l=d['getUint8'](k);if(l!==0x1&&l!==0x2)return{'hasError':!![],'message':'Unsupported\x20command\x20type:\x20'+l+'.\x20Only\x20TCP\x20(1)\x20and\x20UDP\x20(2)\x20are\x20supported.'};const m=k+0x1;if(a['byteLength']<m+0x2)return{'hasError':!![],'message':'Invalid\x20data\x20length\x20(port\x20field\x20missing\x20in\x20VLESS\x20header).'};const n=d['getUint16'](m,![]),o=m+0x2;if(a['byteLength']<o+0x1)return{'hasError':!![],'message':'Invalid\x20data\x20length\x20(address\x20type\x20field\x20missing\x20in\x20VLESS\x20header).'};const p=d['getUint8'](o);let q,r,s;switch(p){case 0x1:r=0x4,s=o+0x1;if(a['byteLength']<s+r)return{'hasError':!![],'message':'Invalid\x20data\x20length\x20(IPv4\x20address\x20bytes\x20missing\x20in\x20VLESS\x20header).'};q=new Uint8Array(a['slice'](s,s+r))['join']('.');break;case 0x2:if(a['byteLength']<o+0x2)return{'hasError':!![],'message':'Invalid\x20data\x20length\x20(domain\x20name\x20length\x20byte\x20missing\x20in\x20VLESS\x20header).'};r=d['getUint8'](o+0x1),s=o+0x2;if(a['byteLength']<s+r)return{'hasError':!![],'message':'Invalid\x20data\x20length\x20(domain\x20name\x20bytes\x20missing\x20in\x20VLESS\x20header).'};q=new TextDecoder()['decode'](a['slice'](s,s+r));break;case 0x3:r=0x10,s=o+0x1;if(a['byteLength']<s+r)return{'hasError':!![],'message':'Invalid\x20data\x20length\x20(IPv6\x20address\x20bytes\x20missing\x20in\x20VLESS\x20header).'};q=Array['from']({'length':0x8},(v,w)=>d['getUint16'](s+w*0x2,![])['toString'](0x10))['join'](':');break;default:return{'hasError':!![],'message':'Unsupported\x20address\x20type:\x20'+p+'.\x20Expected\x200x01\x20(IPv4),\x200x02\x20(Domain),\x20or\x200x03\x20(IPv6).'};}const t=s+r;if(a['byteLength']<t)return{'hasError':!![],'message':'Invalid\x20data\x20length\x20(raw\x20data\x20missing\x20after\x20VLESS\x20header).'};return{'user':h,'hasError':![],'addressRemote':q,'addressType':p,'portRemote':n,'rawDataIndex':t,'ProtocolVersion':new Uint8Array([f]),'isUDP':l===0x2};}catch(v){return console['error'](v['message'],v['stack']),{'hasError':!![],'message':'Protocol\x20header\x20processing\x20error:\x20'+v['message']+'.'};}}async function HandleTCPOutBound(a,b,c,d,e,f,g,h,i,j){async function k(m,n,o=![]){let p;o&&i['socks5']['enabled']&&i['parsedSocks5Address']?p=await socks5Connect(b,m,n,h,i['parsedSocks5Address']):p=connect({'hostname':m,'port':n,'secureTransport':'on'});a['value']=p,h('Connected\x20to\x20remote\x20TCP:\x20'+m+':'+n+(o?'\x20(via\x20SOCKS5)':'')+'.');const q=p['writable']['getWriter']();return await q['write'](e),q['releaseLock'](),p;}async function l(){h('Attempting\x20to\x20retry\x20TCP\x20connection\x20(e.g.,\x20due\x20to\x20proxy\x20health\x20switch\x20or\x20initial\x20failure).');try{const m=await Config['fromEnv'](env),n=m['socks5']['enabled']?await k(c,d,!![]):await k(m['proxyIP']||c,m['proxyPort']||d,![]);n['closed']['catch'](o=>{console['log']('Retry:\x20new\x20remote\x20TCP\x20socket\x20closed\x20with\x20error:',o);})['finally'](()=>{safeCloseWebSocket(f);}),RemoteSocketToWS(n,f,g,null,h,j);}catch(o){h('Retry\x20connection\x20failed:\x20'+o['message']+'.\x20Closing\x20WebSocket.',o),safeCloseWebSocket(f);}}try{const m=i['socks5']['enabled']?await k(c,d,!![]):await k(i['proxyIP']||c,i['proxyPort']||d,![]);m['closed']['catch'](n=>{h('Remote\x20TCP\x20socket\x20closed\x20with\x20error:',n);})['finally'](()=>{safeCloseWebSocket(f);}),await RemoteSocketToWS(m,f,g,l,h,j);}catch(n){h('Failed\x20to\x20establish\x20initial\x20TCP\x20connection:\x20'+n['message']+'.\x20Closing\x20WebSocket.',n),safeCloseWebSocket(f);}}function MakeReadableWebSocketStream(a,b,c){return new ReadableStream({'start'(d){a['addEventListener']('message',g=>{if(g['data']instanceof ArrayBuffer)d['enqueue'](g['data']);else g['data']instanceof Blob?g['data']['arrayBuffer']()['then'](h=>d['enqueue'](h))['catch'](h=>{console['error'](h),d['error'](h);}):(console['error']('Received\x20unexpected\x20WebSocket\x20data\x20type:',typeof g['data']),d['error'](new Error('Unsupported\x20WebSocket\x20data\x20type\x20received.')));}),a['addEventListener']('close',()=>{safeCloseWebSocket(a),d['close'](),c('WebSocket\x20server\x20stream\x20closed.');}),a['addEventListener']('error',g=>{c('WebSocket\x20server\x20stream\x20encountered\x20error:',g),d['error'](g);});const {earlyData:e,error:f}=base64ToArrayBuffer(b);if(f)console['error'](f),d['error'](f);else e&&(d['enqueue'](e),c('Enqueued\x20'+e['byteLength']+'\x20bytes\x20of\x20early\x20data.'));},'pull'(d){},'cancel'(d){c('ReadableStream\x20canceled:\x20'+d),safeCloseWebSocket(a);}});}async function RemoteSocketToWS(a,b,c,d,e,f){let g=![];try{await a['readable']['pipeTo'](new WritableStream({async 'write'(h,i){if(b['readyState']!==CONST['WS_READY_STATE_OPEN']){i['error'](new Error('WebSocket\x20is\x20not\x20open,\x20cannot\x20write\x20remote\x20data.'));return;}g=!![],c?(await b['send'](await new Blob([c,h])['arrayBuffer']()),c=null):await b['send'](h),f&&f(h['byteLength']);},'close'(){e('Remote\x20socket\x20readable\x20stream\x20closed.\x20Has\x20incoming\x20data:\x20'+g),safeCloseWebSocket(b);},'abort'(h){e('Remote\x20socket\x20readable\x20stream\x20aborted:\x20'+h),safeCloseWebSocket(b);}}))['catch'](h=>{console['error'](h),safeCloseWebSocket(b);});}catch(h){console['error'](h),safeCloseWebSocket(b);}if(!g&&d&&b['readyState']===CONST['WS_READY_STATE_OPEN'])e('No\x20incoming\x20data\x20received\x20from\x20remote\x20socket,\x20attempting\x20retry.'),await d();else!g&&!d&&(e('No\x20incoming\x20data\x20received\x20and\x20no\x20retry\x20mechanism.\x20Closing\x20WebSocket.'),safeCloseWebSocket(b));}function base64ToArrayBuffer(a){if(!a)return{'earlyData':null,'error':null};try{const b=atob(a['replace'](/-/g,'+')['replace'](/_/g,'/')),c=new ArrayBuffer(b['length']),d=new Uint8Array(c);for(let e=0x0;e<b['length'];e++){d[e]=b['charCodeAt'](e);}return{'earlyData':c,'error':null};}catch(f){return{'earlyData':null,'error':new Error('Failed\x20to\x20decode\x20base64\x20early\x20data:\x20'+f['message'])};}}function safeCloseWebSocket(a){try{a&&(a['readyState']===CONST['WS_READY_STATE_OPEN']||a['readyState']===CONST['WS_READY_STATE_CLOSING'])&&a['close'](0x3e8,'Normal\x20Closure');}catch(b){console['error'](b);}}async function createDnsPipeline(a,b,c,d){let e=![];const f=new TransformStream({'transform'(h,i){let j=0x0;while(j+0x2<=h['byteLength']){const k=h['slice'](j,j+0x2),l=new DataView(k['buffer'],k['byteOffset'],k['byteLength'])['getUint16'](0x0,![]);if(j+0x2+l>h['byteLength']){c('Warning:\x20Partial\x20UDP\x20packet\x20received.\x20Dropping.\x20Current\x20index:\x20'+j+',\x20Expected\x20packet\x20length:\x20'+l+',\x20Remaining\x20chunk:\x20'+(h['byteLength']-j)+'.');break;}const m=h['slice'](j+0x2,j+0x2+l);i['enqueue'](m),j+=0x2+l;}}});f['readable']['pipeTo'](new WritableStream({async 'write'(h){try{const i=await fetch('https://1.1.1.1/dns-query',{'method':'POST','headers':{'content-type':'application/dns-message','accept':'application/dns-message'},'body':h});if(!i['ok'])throw new Error('DNS-over-HTTPS\x20request\x20failed\x20with\x20status:\x20'+i['status']);const j=await i['arrayBuffer'](),k=j['byteLength'],l=new Uint8Array(0x2);new DataView(l['buffer'])['setUint16'](0x0,k,![]);if(a['readyState']===CONST['WS_READY_STATE_OPEN']){c('DNS\x20query\x20success,\x20response\x20length:\x20'+k);let m;!e?(m=await new Blob([b,l,j])['arrayBuffer'](),e=!![]):m=await new Blob([l,j])['arrayBuffer'](),d&&d(m['byteLength']),a['send'](m);}}catch(n){c('DNS\x20query\x20error:\x20'+n['message'],n),safeCloseWebSocket(a);}},'close'(){c('DNS\x20WritableStream\x20closed.');},'abort'(h){c('DNS\x20WritableStream\x20aborted:\x20'+h),safeCloseWebSocket(a);}}))['catch'](h=>{c('DNS\x20stream\x20pipeline\x20error:\x20'+h['message'],h),safeCloseWebSocket(a);});const g=f['writable']['getWriter']();return{'write':h=>g['write'](h)};}function parseIPv6(a){const b=new ArrayBuffer(0x10),c=new DataView(b),d=a['split']('::');let e=d[0x0]?d[0x0]['split'](':'):[],f=d[0x1]?d[0x1]['split'](':'):[];if(e['length']===0x1&&e[0x0]==='')e=[];if(f['length']===0x1&&f[0x0]==='')f=[];const g=0x8-(e['length']+f['length']),h=[];if(g>0x0)for(let k=0x0;k<g;k++){h['push']('0000');}const j=[...e,...h,...f];if(j['length']!==0x8)throw new Error('Invalid\x20IPv6\x20address\x20format:\x20'+a+'.\x20Expected\x208\x20hextets\x20after\x20expansion.');for(let l=0x0;l<0x8;l++){const m=parseInt(j[l]||'0',0x10);if(isNaN(m))throw new Error('Invalid\x20IPv6\x20hextet:\x20\x27'+j[l]+'\x27\x20in\x20address\x20'+a+'.');c['setUint16'](l*0x2,m,![]);}return new Uint8Array(b);}async function socks5Connect(a,b,c,d,f){const {username:g,password:h,hostname:i,port:j}=f;let k=null,l=null,m=null,n=![];try{k=connect({'hostname':i,'port':j,'secureTransport':'on'}),l=k['readable']['getReader'](),m=k['writable']['getWriter']();const o=new TextEncoder();await m['write'](new Uint8Array([0x5,0x2,0x0,0x2]));let p=(await l['read']())['value'];if(!p||p[0x0]!==0x5||p[0x1]!==0x0&&p[0x1]!==0x2)throw new Error('SOCKS5\x20handshake\x20failed:\x20Proxy\x20selected\x20unsupported\x20authentication\x20method\x20(0x'+(p?.[0x1]?.['toString'](0x10)||'??')+').');if(p[0x1]===0x2){if(!g||!h)throw new Error('SOCKS5\x20proxy\x20requires\x20username/password,\x20but\x20none\x20provided\x20in\x20configuration.');const s=new Uint8Array([0x1,g['length'],...o['encode'](g),h['length'],...o['encode'](h)]);await m['write'](s),p=(await l['read']())['value'];if(!p||p[0x0]!==0x1||p[0x1]!==0x0)throw new Error('SOCKS5\x20authentication\x20failed\x20with\x20proxy\x20(Reply\x20Code:\x200x'+(p?.[0x1]?.['toString'](0x10)||'??')+').');d('SOCKS5\x20proxy\x20authenticated\x20with\x20username/password.');}else p[0x1]===0x0&&d('SOCKS5\x20proxy\x20selected\x20No\x20Authentication.');let q;switch(a){case 0x1:q=new Uint8Array([0x1,...b['split']('.')['map'](Number)]);break;case 0x2:q=new Uint8Array([0x3,b['length'],...o['encode'](b)]);break;case 0x3:const t=parseIPv6(b);q=new Uint8Array(0x1+0x10),q[0x0]=0x4,q['set'](t,0x1);break;default:throw new Error('Unsupported\x20SOCKS5\x20destination\x20address\x20type:\x20'+a+'.');}const r=new Uint8Array([0x5,0x1,0x0,...q,c>>0x8&0xff,c&0xff]);await m['write'](r),p=(await l['read']())['value'];if(!p||p[0x0]!==0x5||p[0x1]!==0x0)throw new Error('SOCKS5\x20connection\x20to\x20'+b+':'+c+'\x20failed\x20(Reply\x20Code:\x200x'+(p?.[0x1]?.['toString'](0x10)||'??')+').');return d('SOCKS5\x20tunnel\x20to\x20'+b+':'+c+'\x20established\x20successfully.'),n=!![],k;}catch(u){d('SOCKS5\x20connection\x20error:\x20'+u['message'],u);throw u;}finally{if(m)m['releaseLock']();if(l)l['releaseLock']();if(!n&&k)try{k['abort']();}catch(v){d('Error\x20aborting\x20SOCKS5\x20socket\x20in\x20finally\x20block:',v);}}}function socks5AddressParser(a){if(!a||typeof a!=='string')throw new Error('Invalid\x20SOCKS5\x20address\x20format:\x20Must\x20be\x20a\x20non-empty\x20string.');let b,c,d=a;const e=a['indexOf']('@');if(e!==-0x1){const j=a['substring'](0x0,e);d=a['substring'](e+0x1);const k=j['split'](':');if(k['length']===0x2)b=k[0x0],c=k[0x1];else throw new Error('Invalid\x20SOCKS5\x20address:\x20Malformed\x20username/password\x20credentials.');}const f=d['lastIndexOf'](':');if(f===-0x1)throw new Error('Invalid\x20SOCKS5\x20address:\x20Missing\x20port\x20in\x20hostname:port\x20format.');let g;if(d['startsWith']('[')&&d['indexOf'](']')<f){const l=d['indexOf'](']');if(l===-0x1||l>f)throw new Error('Invalid\x20SOCKS5\x20address:\x20Malformed\x20IPv6\x20address\x20with\x20brackets.');g=d['substring'](0x1,l);}else g=d['substring'](0x0,f);const h=d['substring'](f+0x1),i=parseInt(h,0xa);if(!g||g['length']===0x0||isNaN(i)||i<=0x0||i>0xffff)throw new Error('Invalid\x20SOCKS5\x20address:\x20Malformed\x20hostname\x20or\x20port\x20value\x20\x27'+h+'\x27.');return{'username':b,'password':c,'hostname':g,'port':i};}function parseAddrFromBuffer(a,b=0x0){const c=a instanceof Uint8Array?a:new Uint8Array(a);let d=b;if(c['length']<d+0x1)throw new Error('short');const e=c[d++];let f='';if(e===0x1){if(c['length']<d+0x4)throw new Error('short\x20ipv4');f=Array['from'](c['slice'](d,d+0x4))['join']('.'),d+=0x4;}else{if(e===0x3){const h=c[d++];if(c['length']<d+h)throw new Error('short\x20domain');f=new TextDecoder()['decode'](c['slice'](d,d+h)),d+=h;}else{if(e===0x4){if(c['length']<d+0x10)throw new Error('short\x20ipv6');const j=[];for(let k=0x0;k<0x8;k++){j['push']((c[d+k*0x2]<<0x8|c[d+k*0x2+0x1])['toString'](0x10));}f=j['join'](':'),d+=0x10;}else throw new Error('unknown\x20atyp');}}if(c['length']<d+0x2)throw new Error('short\x20port');const g=c[d]<<0x8|c[d+0x1];return d+=0x2,{'address':f,'port':g,'offset':d,'bytesRead':d-b};}async function handleUDPOverWS(a,b,c,d){try{const f=a['readable']['getReader'](),g=a['writable']['getWriter'](),h=await f['read']();if(h['done']){try{g['releaseLock'](),f['releaseLock']();}catch(l){}await safeCloseWebSocket(a);return;}const i=new Uint8Array(h['value']),j=await ProcessProtocolHeader(i,c,d);if(j['hasError']||!j['isUDP']){await safeCloseWebSocket(a);return;}const k=i['slice'](j['rawDataIndex']);if(k&&k['length']){const m=k;try{const n=parseAddrFromBuffer(m,0x0),o=m['slice'](n['offset']);if(n['port']===0x35){const q=await fetch('https://1.1.1.1/dns-query',{'method':'POST','headers':{'content-type':'application/dns-message','accept':'application/dns-message'},'body':o});if(q['ok']){const s=new Uint8Array(await q['arrayBuffer']());await g['write'](s);}}}catch(t){console['error']('UDP\x20initial\x20handling\x20error:',t);}}while(!![]){const {done:u,value:v}=await f['read']();if(u)break;const x=new Uint8Array(v);try{const y=parseAddrFromBuffer(x,0x0),z=x['slice'](y['offset']);if(y['port']===0x35){const A=await fetch('https://1.1.1.1/dns-query',{'method':'POST','headers':{'content-type':'application/dns-message','accept':'application/dns-message'},'body':z});if(A['ok']){const B=new Uint8Array(await A['arrayBuffer']());await g['write'](B);}}}catch(C){console['error']('UDP\x20packet\x20handling\x20error:',C);}}try{f['releaseLock']();}catch(D){}try{g['releaseLock']();}catch(E){}await safeCloseWebSocket(a);}catch(F){console['error']('handleUDPOverWS\x20error:',F),await safeCloseWebSocket(a);}}async function handleUpgradeRequest(a,b,c,d){if(!a||!a['headers'])return new Response('Bad\x20Request',{'status':0x190});if((a['headers']['get']('upgrade')||'')['toLowerCase']()!=='websocket')return new Response('Upgrade\x20header\x20required',{'status':0x190});const e=new URL(a['url']),f=e['pathname']||'/';if(f==='/vless')return await ProtocolOverWSHandler(a,b,c,d);if(f==='/udp'){const g=new WebSocketPair(),[h,i]=g;return i['accept'](),handleUDPOverWS(i,b,c,d),new Response(null,{'status':0x65,'webSocket':h});}return new Response('Not\x20Found',{'status':0x194});}