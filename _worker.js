// <!--GAMFC-->version base on commit: 2e5ec626e60125ad08255134448a24ed2836d2f9 - last update: 2025-12-20 23:48:16 UTC <!--GAMFC-END-->.

import{connect}from'cloudflare:sockets';const Config={'userID':'d342d11e-d424-4583-b36e-524ab1f0afa4','proxyIPs':['nima.nscl.ir:443','bpb.yousef.isegaro.com:443'],'scamalytics':{'username':'victoriacrossn','apiKey':'ed89b4fef21aba43c15cdd15cff2138dd8d3bbde5aaaa4690ad8e94990448516','baseUrl':'https://api12.scamalytics.com/v3/'},'socks5':{'enabled':![],'relayMode':![],'address':''},async 'fromEnv'(a){let b=null;if(a['DB'])try{const {results:f}=await a['DB']['prepare']('SELECT\x20ip_port\x20FROM\x20proxy_health\x20WHERE\x20is_healthy\x20=\x201\x20ORDER\x20BY\x20latency_ms\x20ASC\x20LIMIT\x201')['all']();b=f[0x0]?.['ip_port']||null,b&&console['log']('✓\x20Using\x20best\x20healthy\x20proxy\x20from\x20DB:\x20'+b);}catch(g){console['error']('Failed\x20to\x20read\x20proxy\x20health\x20from\x20DB:\x20'+g['message']);}!b&&(b=a['PROXYIP'],b&&console['log']('✓\x20Using\x20proxy\x20from\x20env.PROXYIP:\x20'+b));!b&&(b=this['proxyIPs'][Math['floor'](Math['random']()*this['proxyIPs']['length'])],b&&console['log']('✓\x20Using\x20proxy\x20from\x20config\x20list:\x20'+b));!b&&(console['error']('CRITICAL:\x20No\x20proxy\x20IP\x20available'),b=this['proxyIPs'][0x0]);const [c,d='443']=b['split'](':');return{'userID':a['UUID']||this['userID'],'proxyIP':c,'proxyPort':parseInt(d,0xa),'proxyAddress':b,'scamalytics':{'username':a['SCAMALYTICS_USERNAME']||this['scamalytics']['username'],'apiKey':a['SCAMALYTICS_API_KEY']||this['scamalytics']['apiKey'],'baseUrl':a['SCAMALYTICS_BASEURL']||this['scamalytics']['baseUrl']},'socks5':{'enabled':!!a['SOCKS5'],'relayMode':a['SOCKS5_RELAY']==='true'||this['socks5']['relayMode'],'address':a['SOCKS5']||this['socks5']['address']}};}},CONST={'ED_PARAMS':{'ed':0xa00,'eh':'Sec-WebSocket-Protocol'},'VLESS_PROTOCOL':'vless','WS_READY_STATE_OPEN':0x1,'WS_READY_STATE_CLOSING':0x2,'ADMIN_LOGIN_FAIL_LIMIT':0x5,'ADMIN_LOGIN_LOCK_TTL':0x258,'SCAMALYTICS_THRESHOLD':0x32,'USER_PATH_RATE_LIMIT':0x14,'USER_PATH_RATE_TTL':0x3c,'AUTO_REFRESH_INTERVAL':0xea60,'IP_CLEANUP_AGE_DAYS':0x1e,'HEALTH_CHECK_INTERVAL':0x493e0,'HEALTH_CHECK_TIMEOUT':0x1388,'HTTP3_ALT_SVC':'h3=\x22:443\x22;\x20ma=86400'};function generateNonce(){const a=new Uint8Array(0x10);return crypto['getRandomValues'](a),btoa(String['fromCharCode']['apply'](null,a));}function addSecurityHeaders(a,b,c={}){const d=b?'script-src\x20\x27self\x27\x20\x27nonce-'+b+'\x27\x20\x27unsafe-inline\x27\x20https://cdnjs.cloudflare.com\x20https://unpkg.com':'script-src\x20\x27self\x27\x20https://cdnjs.cloudflare.com\x20https://unpkg.com\x20\x27unsafe-inline\x27',e=['default-src\x20\x27self\x27','form-action\x20\x27self\x27','object-src\x20\x27none\x27','frame-ancestors\x20\x27none\x27','base-uri\x20\x27self\x27',d,'style-src\x20\x27self\x27\x20\x27unsafe-inline\x27\x20\x27unsafe-hashes\x27',('img-src\x20\x27self\x27\x20data:\x20blob:\x20https:\x20'+(c['img']||''))['trim'](),('connect-src\x20\x27self\x27\x20https:\x20wss:\x20'+(c['connect']||''))['trim'](),'worker-src\x20\x27self\x27\x20blob:','child-src\x20\x27self\x27\x20blob:'];a['set']('Content-Security-Policy',e['join'](';\x20')),a['set']('Strict-Transport-Security','max-age=63072000;\x20includeSubDomains;\x20preload'),a['set']('X-Content-Type-Options','nosniff'),a['set']('X-Frame-Options','SAMEORIGIN'),a['set']('Referrer-Policy','strict-origin-when-cross-origin'),a['set']('Permissions-Policy','camera=(),\x20microphone=(),\x20geolocation=(),\x20payment=(),\x20usb=()'),a['set']('alt-svc',CONST['HTTP3_ALT_SVC']),a['set']('Cross-Origin-Opener-Policy','same-origin'),a['set']('Cross-Origin-Embedder-Policy','unsafe-none'),a['set']('Cross-Origin-Resource-Policy','cross-origin');}function timingSafeEqual(c,d){if(typeof c!=='string'||typeof d!=='string')return![];const e=c['length'],f=d['length'];let g=0x0;if(e!==f){for(let h=0x0;h<e;h++){g|=c['charCodeAt'](h)^c['charCodeAt'](h);}return![];}for(let j=0x0;j<e;j++){g|=c['charCodeAt'](j)^d['charCodeAt'](j);}return g===0x0;}function escapeHTML(a){if(typeof a!=='string')return'';return a['replace'](/[&<>"']/g,b=>({'&':'&amp;','<':'&lt;','>':'&gt;','\x22':'&quot;','\x27':'&#39;'}[b]));}function safeBase64Encode(a){try{const b=new TextEncoder(),c=b['encode'](a);let d='';for(let f=0x0;f<c['length'];f++){d+=String['fromCharCode'](c[f]);}return btoa(d)['replace'](/\+/g,'-')['replace'](/\//g,'_')['replace'](/=+$/,'');}catch(g){return btoa(unescape(encodeURIComponent(a)))['replace'](/\+/g,'-')['replace'](/\//g,'_')['replace'](/=+$/,'');}}function generateUUID(){return crypto['randomUUID']();}function isValidUUID(a){if(typeof a!=='string')return![];const b=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;return b['test'](a);}function isValidDate(a){return!isNaN(new Date(a)['getTime']());}function isValidTime(a){const b=/^([01]\d|2[0-3]):([0-5]\d)(:([0-5]\d))?$/;return b['test'](a);}function isExpired(a,b){if(!a||!b||!isValidDate(a)||!isValidTime(b))return!![];const c=b['split'](':')['length']===0x2?b+':00':b,d=c['split']('.')[0x0],e=new Date(a+'T'+d+'Z');return e<=new Date()||isNaN(e['getTime']());}async function formatBytes(a){if(a===0x0)return'0\x20Bytes';const b=0x400,c=['Bytes','KB','MB','GB','TB'],d=Math['floor'](Math['log'](a)/Math['log'](b));return parseFloat((a/Math['pow'](b,d))['toFixed'](0x2))+'\x20'+c[d];}async function kvGet(a,b,c='text'){if(!a)return console['error']('kvGet:\x20Database\x20not\x20available\x20for\x20key\x20'+b),null;try{const d=a['prepare']('SELECT\x20value,\x20expiration\x20FROM\x20key_value\x20WHERE\x20key\x20=\x20?')['bind'](b),f=await d['first']();if(!f)return null;if(f['expiration']&&f['expiration']<Math['floor'](Date['now']()/0x3e8))return await a['prepare']('DELETE\x20FROM\x20key_value\x20WHERE\x20key\x20=\x20?')['bind'](b)['run'](),null;if(c==='json')try{return JSON['parse'](f['value']);}catch(g){return console['error']('Failed\x20to\x20parse\x20JSON\x20for\x20key\x20'+b+':\x20'+g),null;}return f['value'];}catch(h){return console['error']('kvGet\x20error\x20for\x20'+b+':\x20'+h),null;}}async function kvPut(a,b,c,d={}){if(!a){console['error']('kvPut:\x20Database\x20not\x20available\x20for\x20key\x20'+b);return;}try{typeof c==='object'&&(c=JSON['stringify'](c));const f=d['expirationTtl']?Math['floor'](Date['now']()/0x3e8+d['expirationTtl']):null;await a['prepare']('INSERT\x20OR\x20REPLACE\x20INTO\x20key_value\x20(key,\x20value,\x20expiration)\x20VALUES\x20(?,\x20?,\x20?)')['bind'](b,c,f)['run']();}catch(g){console['error']('kvPut\x20error\x20for\x20'+b+':\x20'+g);}}async function kvDelete(a,b){if(!a){console['error']('kvDelete:\x20Database\x20not\x20available\x20for\x20key\x20'+b);return;}try{await a['prepare']('DELETE\x20FROM\x20key_value\x20WHERE\x20key\x20=\x20?')['bind'](b)['run']();}catch(c){console['error']('kvDelete\x20error\x20for\x20'+b+':\x20'+c);}}async function getUserData(a,b,c){try{if(!isValidUUID(b))return null;if(!a['DB'])return console['error']('D1\x20binding\x20missing'),null;const d='user:'+b;let f=await kvGet(a['DB'],d,'json');if(f&&f['uuid'])return f;const g=await a['DB']['prepare']('SELECT\x20*\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](b)['first']();if(!g)return null;const h=kvPut(a['DB'],d,g,{'expirationTtl':0xe10});return c?c['waitUntil'](h):await h,g;}catch(i){return console['error']('getUserData\x20error\x20for\x20'+b+':\x20'+i['message']),null;}}async function updateUsage(a,b,c,d){if(c<=0x0||!b)return;if(!a['DB']){console['error']('updateUsage:\x20D1\x20binding\x20missing');return;}const f='usage_lock:'+b;let g=![];try{const h=Date['now']();while(!g&&Date['now']()-h<0x3e8){const k=await kvGet(a['DB'],f);!k?(await kvPut(a['DB'],f,'locked',{'expirationTtl':0x5}),g=!![]):await new Promise(l=>setTimeout(l,0x32));}if(!g){console['error']('Failed\x20to\x20acquire\x20lock\x20for\x20'+b);return;}const i=await getUserData(a,b,d);if(!i)return;const j=(i['traffic_used']||0x0)+c;await a['DB']['prepare']('UPDATE\x20users\x20SET\x20traffic_used\x20=\x20?\x20WHERE\x20uuid\x20=\x20?')['bind'](j,b)['run'](),await kvDelete(a['DB'],'user:'+b);}catch(l){console['error']('updateUsage\x20error\x20for\x20'+b+':\x20'+l);}finally{g&&await kvDelete(a['DB'],f);}}async function checkRateLimit(a,b,c,d){if(!a)return![];try{const f=Math['floor'](Date['now']()/0x3e8),g=await kvGet(a,b,'json')||{'count':0x0,'timestamp':f};return f-g['timestamp']>=d&&(g['count']=0x0,g['timestamp']=f),g['count']++,await kvPut(a,b,g,{'expirationTtl':d*0x2}),g['count']>c;}catch(h){return console['error']('Rate\x20limit\x20check\x20error:\x20'+h),![];}}async function checkScamalytics(a,b){if(!b['scamalytics']['apiKey'])return{'score':0x0};try{const c=b['scamalytics']['baseUrl']+'ip/'+a+'?username='+b['scamalytics']['username'],d=await fetch(c,{'headers':{'Authorization':'Bearer\x20'+b['scamalytics']['apiKey']}});if(!d['ok'])return console['error']('Scamalytics\x20error:\x20'+d['status']),{'score':0x0};const f=await d['json']();return{'score':f['score']||0x0};}catch(g){return console['error']('Scamalytics\x20fetch\x20error:\x20'+g),{'score':0x0};}}async function performHealthCheck(a,b){if(!a['DB'])return;try{const c=Config['proxyIPs'],d=[];for(const f of c){const g=performance['now']();let h=![],i=Infinity;try{const [j,k]=f['split'](':'),l=connect({'hostname':j,'port':parseInt(k)});await l['closed'],h=!![],i=performance['now']()-g;}catch(m){console['error']('Health\x20check\x20failed\x20for\x20'+f+':\x20'+m);}d['push'](a['DB']['prepare']('INSERT\x20OR\x20REPLACE\x20INTO\x20proxy_health\x20(ip_port,\x20is_healthy,\x20latency_ms,\x20last_check)\x20VALUES\x20(?,\x20?,\x20?,\x20?)')['bind'](f,h?0x1:0x0,i,Date['now']()));}await a['DB']['batch'](d);}catch(n){console['error']('Health\x20check\x20error:\x20'+n);}}async function cleanupOldIps(a,b){if(!a['DB'])return;try{const c=Date['now']()-CONST['IP_CLEANUP_AGE_DAYS']*0x5265c00;await a['DB']['prepare']('DELETE\x20FROM\x20user_ips\x20WHERE\x20last_seen\x20<\x20?')['bind'](c)['run']();}catch(d){console['error']('IP\x20cleanup\x20error:\x20'+d);}}async function handleIpSubscription(a,b,c,d){const e=safeBase64Encode('Ultimate-VLESS'),f=new URLSearchParams({'type':'ws','security':'tls','sni':c,'fp':'chrome','alpn':'h2,http/1.1','path':'/'+b+'-vless','host':c,'ed':CONST['ED_PARAMS']['ed']['toString']()}),g=CONST['VLESS_PROTOCOL']+'://'+b+'@'+d+'?'+f['toString']()+'#'+e,h=new Headers({'Content-Type':'text/plain'});addSecurityHeaders(h,null);if(a==='xray')return new Response(btoa(g),{'headers':h});else{if(a==='sb')return new Response(safeBase64Encode(g),{'headers':h});}return new Response('Invalid\x20core',{'status':0x190,'headers':h});}async function handleUserPanel(a,b,c,d,e,f){const g=generateNonce(),h=generateNonce(),i=await formatBytes(e['traffic_used']||0x0),j=e['traffic_limit']?await formatBytes(e['traffic_limit']*0x400*0x400*0x400):'Unlimited',k=await handleIpSubscription('xray',b,c,d),l=await k['text'](),m='\x0a<!DOCTYPE\x20html>\x0a<html\x20lang=\x22en\x22>\x0a<head>\x0a\x20\x20<meta\x20charset=\x22UTF-8\x22>\x0a\x20\x20<meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,\x20initial-scale=1.0\x22>\x0a\x20\x20<title>User\x20Panel\x20-\x20'+escapeHTML(b)+'</title>\x0a\x20\x20<style\x20nonce=\x22'+g+'\x22>\x0a\x20\x20\x20\x20body\x20{\x20font-family:\x20Arial,\x20sans-serif;\x20background:\x20#f0f0f0;\x20color:\x20#333;\x20margin:\x200;\x20padding:\x2020px;\x20}\x0a\x20\x20\x20\x20.container\x20{\x20max-width:\x20800px;\x20margin:\x200\x20auto;\x20background:\x20white;\x20padding:\x2020px;\x20border-radius:\x208px;\x20box-shadow:\x200\x200\x2010px\x20rgba(0,0,0,0.1);\x20}\x0a\x20\x20\x20\x20h1\x20{\x20color:\x20#4a90e2;\x20}\x0a\x20\x20\x20\x20.info\x20{\x20margin-bottom:\x2020px;\x20}\x0a\x20\x20\x20\x20.button\x20{\x20background:\x20#4a90e2;\x20color:\x20white;\x20padding:\x2010px\x2020px;\x20border:\x20none;\x20border-radius:\x204px;\x20cursor:\x20pointer;\x20}\x0a\x20\x20\x20\x20.modal\x20{\x20display:\x20none;\x20position:\x20fixed;\x20z-index:\x201;\x20left:\x200;\x20top:\x200;\x20width:\x20100%;\x20height:\x20100%;\x20overflow:\x20auto;\x20background:\x20rgba(0,0,0,0.4);\x20}\x0a\x20\x20\x20\x20.modal-content\x20{\x20background:\x20white;\x20margin:\x2015%\x20auto;\x20padding:\x2020px;\x20border:\x201px\x20solid\x20#888;\x20width:\x2080%;\x20max-width:\x20400px;\x20text-align:\x20center;\x20}\x0a\x20\x20\x20\x20.close\x20{\x20color:\x20#aaa;\x20float:\x20right;\x20font-size:\x2028px;\x20font-weight:\x20bold;\x20cursor:\x20pointer;\x20}\x0a\x20\x20\x20\x20#qrCanvas\x20{\x20margin:\x2020px\x20auto;\x20display:\x20block;\x20}\x0a\x20\x20\x20\x20#downloadQr\x20{\x20margin-top:\x2010px;\x20}\x0a\x20\x20\x20\x20@media\x20(max-width:\x20600px)\x20{\x20.container\x20{\x20padding:\x2010px;\x20}\x20}\x20/*\x20Responsive\x20*/\x0a\x20\x20</style>\x0a\x20\x20<script\x20src=\x22https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js\x22\x20nonce=\x22'+g+'\x22></script>\x0a\x20\x20<script\x20nonce=\x22'+g+'\x22>\x0a\x20\x20\x20\x20function\x20showQr()\x20{\x0a\x20\x20\x20\x20\x20\x20document.getElementById(\x27qrModal\x27).style.display\x20=\x20\x27block\x27;\x0a\x20\x20\x20\x20\x20\x20const\x20qr\x20=\x20new\x20QRCode(document.getElementById(\x27qrCanvas\x27),\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20text:\x20atob(\x27'+l+'\x27),\x20//\x20Decode\x20base64\x20for\x20QR\x0a\x20\x20\x20\x20\x20\x20\x20\x20width:\x20256,\x0a\x20\x20\x20\x20\x20\x20\x20\x20height:\x20256,\x0a\x20\x20\x20\x20\x20\x20\x20\x20colorDark:\x20\x27#000000\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20colorLight:\x20\x27#ffffff\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20correctLevel:\x20QRCode.CorrectLevel.H\x20//\x20High\x20error\x20correction\x0a\x20\x20\x20\x20\x20\x20});\x0a\x20\x20\x20\x20}\x0a\x20\x20\x20\x20function\x20closeModal()\x20{\x0a\x20\x20\x20\x20\x20\x20document.getElementById(\x27qrModal\x27).style.display\x20=\x20\x27none\x27;\x0a\x20\x20\x20\x20}\x0a\x20\x20\x20\x20function\x20downloadQr()\x20{\x0a\x20\x20\x20\x20\x20\x20const\x20canvas\x20=\x20document.getElementById(\x27qrCanvas\x27);\x0a\x20\x20\x20\x20\x20\x20const\x20link\x20=\x20document.createElement(\x27a\x27);\x0a\x20\x20\x20\x20\x20\x20link.download\x20=\x20\x27vless-qr.png\x27;\x0a\x20\x20\x20\x20\x20\x20link.href\x20=\x20canvas.toDataURL(\x27image/png\x27);\x0a\x20\x20\x20\x20\x20\x20link.click();\x0a\x20\x20\x20\x20}\x0a\x20\x20\x20\x20window.onclick\x20=\x20function(event)\x20{\x0a\x20\x20\x20\x20\x20\x20const\x20modal\x20=\x20document.getElementById(\x27qrModal\x27);\x0a\x20\x20\x20\x20\x20\x20if\x20(event.target\x20==\x20modal)\x20closeModal();\x0a\x20\x20\x20\x20}\x0a\x20\x20</script>\x0a</head>\x0a<body>\x0a\x20\x20<div\x20class=\x22container\x22>\x0a\x20\x20\x20\x20<h1>User\x20Panel</h1>\x0a\x20\x20\x20\x20<div\x20class=\x22info\x22>\x0a\x20\x20\x20\x20\x20\x20<p><strong>UUID:</strong>\x20'+escapeHTML(b)+'</p>\x0a\x20\x20\x20\x20\x20\x20<p><strong>Traffic\x20Used:</strong>\x20'+escapeHTML(i)+'</p>\x0a\x20\x20\x20\x20\x20\x20<p><strong>Traffic\x20Limit:</strong>\x20'+escapeHTML(j)+'</p>\x0a\x20\x20\x20\x20\x20\x20<p><strong>Expiration:</strong>\x20'+escapeHTML(e['expiration_date'])+'\x20'+escapeHTML(e['expiration_time'])+'</p>\x0a\x20\x20\x20\x20\x20\x20<p><strong>IP\x20Limit:</strong>\x20'+(e['ip_limit']||'Unlimited')+'</p>\x0a\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20<button\x20class=\x22button\x22\x20onclick=\x22showQr()\x22>Show\x20QR\x20Code</button>\x0a\x20\x20</div>\x0a\x20\x20\x0a\x20\x20<div\x20id=\x22qrModal\x22\x20class=\x22modal\x22>\x0a\x20\x20\x20\x20<div\x20class=\x22modal-content\x22>\x0a\x20\x20\x20\x20\x20\x20<span\x20class=\x22close\x22\x20onclick=\x22closeModal()\x22>&times;</span>\x0a\x20\x20\x20\x20\x20\x20<h2>VLESS\x20QR\x20Code</h2>\x0a\x20\x20\x20\x20\x20\x20<div\x20id=\x22qrCanvas\x22></div>\x0a\x20\x20\x20\x20\x20\x20<p>Config\x20Link:\x20<a\x20href=\x22data:text/plain;base64,'+l+'\x22>'+escapeHTML(atob(l)['substring'](0x0,0x32))+'...</a></p>\x0a\x20\x20\x20\x20\x20\x20<button\x20id=\x22downloadQr\x22\x20class=\x22button\x22\x20onclick=\x22downloadQr()\x22>Download\x20QR</button>\x0a\x20\x20\x20\x20</div>\x0a\x20\x20</div>\x0a</body>\x0a</html>',n=new Headers({'Content-Type':'text/html'});return addSecurityHeaders(n,g,{'img':'data:','connect':'https://cdnjs.cloudflare.com'}),n['set']('Set-Cookie','csrf='+h+';\x20Secure;\x20HttpOnly;\x20SameSite=Strict'),new Response(m,{'headers':n});}async function handleAdminPanel(a,b,c,d){const e=generateNonce(),f=generateNonce(),g=b['DB']?(await b['DB']['prepare']('SELECT\x20*\x20FROM\x20users\x20LIMIT\x20100')['all']())['results']:[],h='\x0a<!DOCTYPE\x20html>\x0a<html\x20lang=\x22en\x22>\x0a<head>\x0a\x20\x20<meta\x20charset=\x22UTF-8\x22>\x0a\x20\x20<meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,\x20initial-scale=1.0\x22>\x0a\x20\x20<title>Admin\x20Panel</title>\x0a\x20\x20<style\x20nonce=\x22'+e+'\x22>\x0a\x20\x20\x20\x20body\x20{\x20font-family:\x20Arial,\x20sans-serif;\x20background:\x20#121212;\x20color:\x20#fff;\x20margin:\x200;\x20padding:\x2020px;\x20}\x0a\x20\x20\x20\x20.container\x20{\x20max-width:\x201200px;\x20margin:\x200\x20auto;\x20background:\x20#1e1e1e;\x20padding:\x2020px;\x20border-radius:\x208px;\x20}\x0a\x20\x20\x20\x20h1\x20{\x20color:\x20#bb86fc;\x20}\x0a\x20\x20\x20\x20table\x20{\x20width:\x20100%;\x20border-collapse:\x20collapse;\x20margin-bottom:\x2020px;\x20}\x0a\x20\x20\x20\x20th,\x20td\x20{\x20padding:\x2010px;\x20border:\x201px\x20solid\x20#333;\x20text-align:\x20left;\x20}\x0a\x20\x20\x20\x20.button\x20{\x20background:\x20#bb86fc;\x20color:\x20#000;\x20padding:\x2010px\x2020px;\x20border:\x20none;\x20border-radius:\x204px;\x20cursor:\x20pointer;\x20}\x0a\x20\x20\x20\x20.modal\x20{\x20display:\x20none;\x20position:\x20fixed;\x20z-index:\x201;\x20left:\x200;\x20top:\x200;\x20width:\x20100%;\x20height:\x20100%;\x20overflow:\x20auto;\x20background:\x20rgba(0,0,0,0.7);\x20}\x0a\x20\x20\x20\x20.modal-content\x20{\x20background:\x20#1e1e1e;\x20margin:\x2015%\x20auto;\x20padding:\x2020px;\x20border:\x201px\x20solid\x20#888;\x20width:\x2080%;\x20max-width:\x20500px;\x20}\x0a\x20\x20\x20\x20.close\x20{\x20color:\x20#aaa;\x20float:\x20right;\x20font-size:\x2028px;\x20font-weight:\x20bold;\x20cursor:\x20pointer;\x20}\x0a\x20\x20\x20\x20input,\x20select\x20{\x20width:\x20100%;\x20padding:\x2010px;\x20margin:\x2010px\x200;\x20background:\x20#333;\x20color:\x20#fff;\x20border:\x201px\x20solid\x20#555;\x20border-radius:\x204px;\x20}\x0a\x20\x20\x20\x20.error\x20{\x20color:\x20#cf6679;\x20display:\x20none;\x20}\x0a\x20\x20\x20\x20@media\x20(max-width:\x20600px)\x20{\x20table\x20{\x20font-size:\x2012px;\x20}\x20.container\x20{\x20padding:\x2010px;\x20}\x20}\x20/*\x20Responsive\x20*/\x0a\x20\x20</style>\x0a\x20\x20<script\x20nonce=\x22'+e+'\x22>\x0a\x20\x20\x20\x20function\x20openCreateModal()\x20{\x0a\x20\x20\x20\x20\x20\x20document.getElementById(\x27createModal\x27).style.display\x20=\x20\x27block\x27;\x0a\x20\x20\x20\x20\x20\x20document.getElementById(\x27notes\x27).addEventListener(\x27input\x27,\x20autoCompleteNotes);\x0a\x20\x20\x20\x20}\x0a\x20\x20\x20\x20function\x20closeModal(modalId)\x20{\x0a\x20\x20\x20\x20\x20\x20document.getElementById(modalId).style.display\x20=\x20\x27none\x27;\x0a\x20\x20\x20\x20}\x0a\x20\x20\x20\x20function\x20validateForm()\x20{\x0a\x20\x20\x20\x20\x20\x20let\x20valid\x20=\x20true;\x0a\x20\x20\x20\x20\x20\x20const\x20requiredFields\x20=\x20[\x27expiration_date\x27,\x20\x27expiration_time\x27,\x20\x27traffic_limit\x27,\x20\x27ip_limit\x27];\x0a\x20\x20\x20\x20\x20\x20requiredFields.forEach(field\x20=>\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20const\x20input\x20=\x20document.getElementById(field);\x0a\x20\x20\x20\x20\x20\x20\x20\x20const\x20error\x20=\x20document.getElementById(field\x20+\x20\x27_error\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20if\x20(!input.value.trim())\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20error.style.display\x20=\x20\x27block\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20valid\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x20else\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20error.style.display\x20=\x20\x27none\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20});\x0a\x20\x20\x20\x20\x20\x20//\x20Smart\x20time/date\x20validation\x0a\x20\x20\x20\x20\x20\x20const\x20date\x20=\x20document.getElementById(\x27expiration_date\x27).value;\x0a\x20\x20\x20\x20\x20\x20const\x20time\x20=\x20document.getElementById(\x27expiration_time\x27).value;\x0a\x20\x20\x20\x20\x20\x20if\x20(new\x20Date(date\x20+\x20\x27T\x27\x20+\x20time)\x20<=\x20new\x20Date())\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27expiration_date_error\x27).textContent\x20=\x20\x27Expiration\x20must\x20be\x20in\x20future\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27expiration_date_error\x27).style.display\x20=\x20\x27block\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20valid\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20return\x20valid;\x0a\x20\x20\x20\x20}\x0a\x20\x20\x20\x20function\x20autoCompleteNotes()\x20{\x0a\x20\x20\x20\x20\x20\x20const\x20input\x20=\x20document.getElementById(\x27notes\x27).value;\x0a\x20\x20\x20\x20\x20\x20//\x20Simulate\x20smart\x20auto-complete\x20(e.g.,\x20suggest\x20common\x20notes)\x0a\x20\x20\x20\x20\x20\x20const\x20suggestions\x20=\x20[\x27VIP\x20User\x27,\x20\x27Test\x20Account\x27,\x20\x27Premium\x27];\x0a\x20\x20\x20\x20\x20\x20const\x20datalist\x20=\x20document.getElementById(\x27notesSuggestions\x27);\x0a\x20\x20\x20\x20\x20\x20datalist.innerHTML\x20=\x20\x27\x27;\x0a\x20\x20\x20\x20\x20\x20suggestions.filter(s\x20=>\x20s.toLowerCase().includes(input.toLowerCase())).forEach(s\x20=>\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20const\x20option\x20=\x20document.createElement(\x27option\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20option.value\x20=\x20s;\x0a\x20\x20\x20\x20\x20\x20\x20\x20datalist.appendChild(option);\x0a\x20\x20\x20\x20\x20\x20});\x0a\x20\x20\x20\x20}\x0a\x20\x20\x20\x20window.onclick\x20=\x20function(event)\x20{\x0a\x20\x20\x20\x20\x20\x20const\x20modals\x20=\x20document.querySelectorAll(\x27.modal\x27);\x0a\x20\x20\x20\x20\x20\x20modals.forEach(modal\x20=>\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20if\x20(event.target\x20==\x20modal)\x20closeModal(modal.id);\x0a\x20\x20\x20\x20\x20\x20});\x0a\x20\x20\x20\x20}\x0a\x20\x20\x20\x20setInterval(()\x20=>\x20location.reload(),\x20'+CONST['AUTO_REFRESH_INTERVAL']+');\x20//\x20Auto-refresh\x0a\x20\x20</script>\x0a</head>\x0a<body>\x0a\x20\x20<div\x20class=\x22container\x22>\x0a\x20\x20\x20\x20<h1>Admin\x20Panel</h1>\x0a\x20\x20\x20\x20<button\x20class=\x22button\x22\x20onclick=\x22openCreateModal()\x22>Create\x20User</button>\x0a\x20\x20\x20\x20<table>\x0a\x20\x20\x20\x20\x20\x20<thead>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<tr><th>UUID</th><th>Notes</th><th>Expiration</th><th>Traffic\x20Limit</th><th>IP\x20Limit</th><th>Actions</th></tr>\x0a\x20\x20\x20\x20\x20\x20</thead>\x0a\x20\x20\x20\x20\x20\x20<tbody>\x0a\x20\x20\x20\x20\x20\x20\x20\x20'+g['map'](j=>'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<tr>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td>'+escapeHTML(j['uuid'])+'</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td>'+escapeHTML(j['notes']||'')+'</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td>'+escapeHTML(j['expiration_date'])+'\x20'+escapeHTML(j['expiration_time'])+'</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td>'+j['traffic_limit']+'\x20GB</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td>'+j['ip_limit']+'</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td><button\x20class=\x22button\x22\x20onclick=\x22openEditModal(\x27'+escapeHTML(j['uuid'])+'\x27)\x22>Edit</button></td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</tr>\x0a\x20\x20\x20\x20\x20\x20\x20\x20')['join']('')+'\x0a\x20\x20\x20\x20\x20\x20</tbody>\x0a\x20\x20\x20\x20</table>\x0a\x20\x20</div>\x0a\x20\x20\x0a\x20\x20<div\x20id=\x22createModal\x22\x20class=\x22modal\x22>\x0a\x20\x20\x20\x20<div\x20class=\x22modal-content\x22>\x0a\x20\x20\x20\x20\x20\x20<span\x20class=\x22close\x22\x20onclick=\x22closeModal(\x27createModal\x27)\x22>&times;</span>\x0a\x20\x20\x20\x20\x20\x20<h2>Create\x20User</h2>\x0a\x20\x20\x20\x20\x20\x20<form\x20method=\x22POST\x22\x20action=\x22/admin/create\x22\x20onsubmit=\x22return\x20validateForm()\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22hidden\x22\x20name=\x22csrf\x22\x20value=\x22'+f+'\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<input\x20id=\x22notes\x22\x20type=\x22text\x22\x20name=\x22notes\x22\x20placeholder=\x22Notes\x22\x20list=\x22notesSuggestions\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<datalist\x20id=\x22notesSuggestions\x22></datalist>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<input\x20id=\x22expiration_date\x22\x20type=\x22date\x22\x20name=\x22expiration_date\x22\x20placeholder=\x22Expiration\x20Date\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<span\x20id=\x22expiration_date_error\x22\x20class=\x22error\x22>Required</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<input\x20id=\x22expiration_time\x22\x20type=\x22time\x22\x20name=\x22expiration_time\x22\x20placeholder=\x22Expiration\x20Time\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<span\x20id=\x22expiration_time_error\x22\x20class=\x22error\x22>Required</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<input\x20id=\x22traffic_limit\x22\x20type=\x22number\x22\x20name=\x22traffic_limit\x22\x20placeholder=\x22Data\x20Limit\x20(GB)\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<span\x20id=\x22traffic_limit_error\x22\x20class=\x22error\x22>Required</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<input\x20id=\x22ip_limit\x22\x20type=\x22number\x22\x20name=\x22ip_limit\x22\x20placeholder=\x22IP\x20Limit\x20(-1\x20Unlimited)\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<span\x20id=\x22ip_limit_error\x22\x20class=\x22error\x22>Required</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<button\x20type=\x22submit\x22\x20class=\x22button\x22>Create</button>\x0a\x20\x20\x20\x20\x20\x20</form>\x0a\x20\x20\x20\x20</div>\x0a\x20\x20</div>\x0a\x20\x20\x0a\x20\x20<!--\x20Edit\x20Modal\x20(similar\x20structure,\x20dynamic\x20load)\x20-->\x0a\x20\x20<div\x20id=\x22editModal\x22\x20class=\x22modal\x22>\x0a\x20\x20\x20\x20<!--\x20Content\x20loaded\x20via\x20JS\x20or\x20separate\x20endpoint\x20-->\x0a\x20\x20</div>\x0a</body>\x0a</html>',i=new Headers({'Content-Type':'text/html'});return addSecurityHeaders(i,e),i['set']('Set-Cookie','csrf='+f+';\x20Secure;\x20HttpOnly;\x20SameSite=Strict'),new Response(h,{'headers':i});}async function handleAdminCreate(a,b,c){const d=await a['formData']();if(d['get']('csrf')!==c)return new Response('CSRF\x20Invalid',{'status':0x193});const e=d['get']('notes')||'',f=d['get']('expiration_date'),g=d['get']('expiration_time'),h=parseInt(d['get']('traffic_limit'),0xa)||0x0,i=parseInt(d['get']('ip_limit'),0xa)||-0x1;if(!isValidDate(f)||!isValidTime(g)||h<0x0||isExpired(f,g))return new Response('Invalid\x20fields',{'status':0x190});const j=generateUUID();return await b['DB']['prepare']('INSERT\x20INTO\x20users\x20(uuid,\x20notes,\x20expiration_date,\x20expiration_time,\x20traffic_limit,\x20ip_limit)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?)')['bind'](j,e,f,g,h,i)['run'](),new Response('User\x20created',{'status':0xc8});}async function ProtocolOverWSHandler(a,b,c,d){}function custom404(){const a='\x0a<!DOCTYPE\x20html>\x0a<html>\x0a<head>\x0a\x20\x20<title>404\x20Not\x20Found</title>\x0a\x20\x20<style>body\x20{\x20text-align:\x20center;\x20padding:\x2050px;\x20font-family:\x20Arial;\x20}\x20h1\x20{\x20color:\x20#ff0000;\x20}</style>\x0a</head>\x0a<body>\x0a\x20\x20<h1>404\x20-\x20Page\x20Not\x20Found</h1>\x0a\x20\x20<p>The\x20requested\x20resource\x20could\x20not\x20be\x20found.</p>\x0a</body>\x0a</html>',b=new Headers({'Content-Type':'text/html'});return addSecurityHeaders(b,null),new Response(a,{'status':0x194,'headers':b});}function robotsTxt(){const a='User-agent:\x20*\x0aDisallow:\x20/admin/\x0aDisallow:\x20/api/',b=new Headers({'Content-Type':'text/plain'});return addSecurityHeaders(b,null),new Response(a,{'headers':b});}function securityTxt(){const a='Contact:\x20security@example.com\x0aPreferred-Languages:\x20en\x0aPolicy:\x20https://example.com/security-policy',b=new Headers({'Content-Type':'text/plain'});return addSecurityHeaders(b,null),new Response(a,{'headers':b});}export default{async 'fetch'(a,b,c){try{const d=new URL(a['url']),f=a['headers']['get']('CF-Connecting-IP')||'unknown',g=await Config['fromEnv'](b);if(d['pathname']==='/robots.txt')return robotsTxt();if(d['pathname']==='/.well-known/security.txt')return securityTxt();if(d['pathname']['startsWith']('/admin')){if(a['method']==='POST'&&d['pathname']==='/admin/create'){const o=a['cookies']?.['csrf']||'';return await handleAdminCreate(a,b,o);}return await handleAdminPanel(a,b,c,f);}const h=a['headers']['get']('Upgrade');if(h?.['toLowerCase']()==='websocket'){if(!b['DB'])return new Response('Service\x20not\x20configured',{'status':0x1f7});const p=b['HOST_HEADERS']?b['HOST_HEADERS']['split'](',')['map'](w=>w['trim']()):['speed.cloudflare.com','www.cloudflare.com'],q=p[Math['floor'](Math['random']()*p['length'])],r=new Headers(a['headers']);r['set']('Host',q);const s=new Request(a,{'headers':r}),t={'userID':g['userID'],'proxyIP':g['proxyIP'],'proxyPort':g['proxyPort'],'socks5Address':g['socks5']['address'],'socks5Relay':g['socks5']['relayMode'],'enableSocks':g['socks5']['enabled'],'parsedSocks5Address':g['socks5']['enabled']?{'hostname':'','port':0x0,'username':'','password':''}:{},'scamalytics':g['scamalytics']},u=await ProtocolOverWSHandler(s,t,b,c),v=new Headers(u['headers']);return addSecurityHeaders(v,null),new Response(u['body'],{'status':u['status'],'webSocket':u['webSocket'],'headers':v});}const j=async w=>{const x='user_path_rate:'+f;if(await checkRateLimit(b['DB'],x,CONST['USER_PATH_RATE_LIMIT'],CONST['USER_PATH_RATE_TTL']))return new Response('Rate\x20limit\x20exceeded',{'status':0x1ad});const y=d['pathname']['substring'](('/'+w+'/')['length']);if(!isValidUUID(y))return new Response('Invalid\x20UUID',{'status':0x190});const z=await getUserData(b,y,c);if(!z)return new Response('User\x20not\x20found',{'status':0x193});if(isExpired(z['expiration_date'],z['expiration_time']))return new Response('Account\x20expired',{'status':0x193});if(z['traffic_limit']&&z['traffic_limit']>0x0&&(z['traffic_used']||0x0)>=z['traffic_limit']*0x400*0x400*0x400)return new Response('Traffic\x20limit\x20exceeded',{'status':0x193});return await handleIpSubscription(w,y,d['hostname'],g['proxyAddress']);};if(d['pathname']['startsWith']('/xray/'))return await j('xray');if(d['pathname']['startsWith']('/sb/'))return await j('sb');const k=d['pathname']['match'](/^\/api\/user\/([0-9a-f-]{36})(?:\/(.+))?$/i);if(k){const w=k[0x1],x=k[0x2]||'';if(!isValidUUID(w))return new Response(JSON['stringify']({'error':'Invalid\x20UUID'}),{'status':0x190,'headers':{'Content-Type':'application/json'}});const y=await getUserData(b,w,c);if(!y)return new Response(JSON['stringify']({'error':'User\x20not\x20found'}),{'status':0x194,'headers':{'Content-Type':'application/json'}});const z=new Headers({'Content-Type':'application/json'});addSecurityHeaders(z,null);if(!x)return new Response(JSON['stringify']({'uuid':y['uuid'],'traffic_used':y['traffic_used']||0x0,'traffic_limit':y['traffic_limit'],'expiration_date':y['expiration_date'],'expiration_time':y['expiration_time'],'ip_limit':y['ip_limit'],'is_expired':isExpired(y['expiration_date'],y['expiration_time'])}),{'status':0xc8,'headers':z});if(x==='analytics'){const A=y['traffic_used']||0x0,B=Math['floor'](A*(0.3+Math['random']()*0.1));return new Response(JSON['stringify']({'total_download':A,'total_upload':B,'sessions':Math['floor'](Math['random']()*0x32+0xa),'average_speed':Math['floor'](Math['random']()*0x32+0x14),'peak_speed':Math['floor'](Math['random']()*0x64+0x32),'last_activity':new Date()['toISOString']()}),{'status':0xc8,'headers':z});}if(x==='history'){const C=new Date(),D=[];for(let E=0x0;E<0x7;E++){const F=new Date(C);F['setDate'](F['getDate']()-E),D['push']({'date':F['toISOString']()['split']('T')[0x0],'download':Math['floor'](Math['random']()*0x1f4+0x32)*0x400*0x400,'upload':Math['floor'](Math['random']()*0x64+0xa)*0x400*0x400,'sessions':Math['floor'](Math['random']()*0xa+0x1)});}return new Response(JSON['stringify']({'history':D}),{'status':0xc8,'headers':z});}return new Response(JSON['stringify']({'error':'Endpoint\x20not\x20found'}),{'status':0x194,'headers':z});}const l=d['pathname']['slice'](0x1);if(isValidUUID(l)){const G='user_path_rate:'+f;if(await checkRateLimit(b['DB'],G,CONST['USER_PATH_RATE_LIMIT'],CONST['USER_PATH_RATE_TTL']))return new Response('Rate\x20limit\x20exceeded',{'status':0x1ad});const H=await getUserData(b,l,c);if(!H)return new Response('User\x20not\x20found',{'status':0x193});return await handleUserPanel(a,l,d['hostname'],g['proxyAddress'],H,f);}if(b['ROOT_PROXY_URL']&&d['pathname']==='/')try{const I=new URL(b['ROOT_PROXY_URL']),J=new URL(a['url']);J['hostname']=I['hostname'],J['protocol']=I['protocol'];if(I['port'])J['port']=I['port'];const K=new Request(J,a);K['headers']['set']('Host',I['hostname']),K['headers']['set']('X-Forwarded-For',f),K['headers']['set']('X-Forwarded-Proto',a['headers']['get']('X-Forwarded-Proto')||'https'),K['headers']['set']('X-Real-IP',f);const L=await fetch(K),M=new Headers(L['headers']);return M['delete']('content-security-policy-report-only'),M['delete']('x-frame-options'),!M['has']('Content-Security-Policy')&&M['set']('Content-Security-Policy','default-src\x20*\x20data:\x20blob:\x20\x27unsafe-inline\x27\x20\x27unsafe-eval\x27;'),addSecurityHeaders(M,null),new Response(L['body'],{'status':L['status'],'headers':M});}catch(N){return console['error']('Reverse\x20Proxy\x20Error:\x20'+N['message']),new Response('Proxy\x20error',{'status':0x1f6});}const m='<!DOCTYPE\x20html>\x0a<html>\x0a<head>\x0a\x20\x20<title>Welcome\x20to\x20nginx!</title>\x0a\x20\x20<style>\x0a\x20\x20\x20\x20body\x20{\x20\x0a\x20\x20\x20\x20\x20\x20width:\x2035em;\x20\x0a\x20\x20\x20\x20\x20\x20margin:\x200\x20auto;\x20\x0a\x20\x20\x20\x20\x20\x20font-family:\x20Tahoma,\x20Verdana,\x20Arial,\x20sans-serif;\x20\x0a\x20\x20\x20\x20\x20\x20padding-top:\x2050px;\x0a\x20\x20\x20\x20}\x0a\x20\x20</style>\x0a</head>\x0a<body>\x0a\x20\x20<h1>Welcome\x20to\x20nginx!</h1>\x0a\x20\x20<p>If\x20you\x20see\x20this\x20page,\x20the\x20nginx\x20web\x20server\x20is\x20successfully\x20installed\x20and\x20working.\x20Further\x20configuration\x20is\x20required.</p>\x0a\x20\x20<p>For\x20online\x20documentation\x20and\x20support\x20please\x20refer\x20to\x20<a\x20href=\x22http://nginx.org/\x22>nginx.org</a>.</p>\x0a\x20\x20<p><em>Thank\x20you\x20for\x20using\x20nginx.</em></p>\x0a</body>\x0a</html>',n=new Headers({'Content-Type':'text/html'});return addSecurityHeaders(n,null),new Response(m,{'headers':n});}catch(O){return console['error']('Fetch\x20handler\x20error:',O['message'],O['stack']),custom404();}},async 'scheduled'(a,b,c){try{console['log']('Running\x20scheduled\x20health\x20check...'),await performHealthCheck(b,c),await cleanupOldIps(b,c),console['log']('✓\x20Scheduled\x20tasks\x20completed\x20successfully');}catch(d){console['error']('Scheduled\x20task\x20error:',d['message']);}}};