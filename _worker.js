// <!--GAMFC-->version base on commit: a061cf0141591548a86512b57683593ce25e7a42 - last update: 2025-12-25 14:51:38 UTC <!--GAMFC-END-->.

import{connect}from'cloudflare:sockets';const QUANTUM_CONFIG={'VERSION':'7.0.0','SYSTEM_NAME':'Quantum\x20Shield\x20Ultra\x20Pro\x20Max','BUILD_DATE':'2025-12-25','PATHS':{'ADMIN':'/quantum-admin-v7','API':'/api/v3','WEBHOOK':'/quantum-webhook','SUBSCRIPTION':'/sub','VLESS_WS':'/vless-quantum','VLESS_GRPC':'/grpc-quantum','USER_PANEL':'/panel','HEALTH_CHECK':'/health','METRICS':'/metrics'},'SECURITY':{'MAX_CONNECTIONS_PER_USER':0xa,'RATE_LIMIT_PER_MINUTE':0xb4,'RATE_LIMIT_BURST':0xfa,'SESSION_TIMEOUT_HOURS':0x18,'AUTO_BAN_THRESHOLD':0x8,'PASSWORD_MIN_LENGTH':0xc,'MAX_LOGIN_ATTEMPTS':0x5,'LOGIN_COOLDOWN_MINUTES':0x1e,'SCAMALYTICS_THRESHOLD':0x50},'QUANTUM_FEATURES':{'ENABLE_FRAGMENTATION':!![],'ENABLE_PADDING':!![],'ENABLE_TIMING_OBFUSCATION':!![],'ENABLE_PROTOCOL_CAMOUFLAGE':!![],'ENABLE_REALITY_MODE':!![],'ENABLE_UDP_RELAY':!![],'ENABLE_GRPC_MULTIPLEX':!![],'ENABLE_DYNAMIC_SNI':!![],'ENABLE_TRAFFIC_MASKING':!![],'ENABLE_ROOT_PROXY':!![],'ENABLE_IP_REPUTATION_CHECK':!![],'ENABLE_ADAPTIVE_ROUTING':!![],'ENABLE_CONNECTION_POOLING':!![],'ENABLE_SMART_RETRY':!![],'ENABLE_QUANTUM_ENCRYPTION':!![],'ENABLE_DEEP_PACKET_SCRAMBLING':!![],'ENABLE_NOISE_INJECTION':!![]},'ANTI_FILTER_SNI':{'priority_high':['www.speedtest.net','cloudflare.com','cdnjs.cloudflare.com'],'priority_medium':['ajax.googleapis.com','fonts.googleapis.com','apis.google.com'],'priority_low':['www.microsoft.com','play.google.com','www.apple.com'],'fallback':['www.bing.com','www.yahoo.com']},'TRAFFIC_MASKING':{'MIN_FRAGMENT_SIZE':0x80,'MAX_FRAGMENT_SIZE':0x578,'PADDING_PROBABILITY':0.45,'MAX_PADDING_SIZE':0x100,'TIMING_JITTER_MS':0x19,'BURST_SIZE':0x8},'PROXY_IPS':[]};export default{async 'fetch'(a,b,c){try{await initializeSystem(b,c);const d=new URL(a['url']),e=a['headers']['get']('Upgrade'),f=getClientIP(a);if(a['method']==='OPTIONS')return new Response(null,{'status':0xcc,'headers':getCORSHeaders()});if((d['pathname']==='/'||d['pathname']==='')&&QUANTUM_CONFIG['QUANTUM_FEATURES']['ENABLE_ROOT_PROXY'])return await handleRootProxy(a,b);if(d['pathname']===QUANTUM_CONFIG['PATHS']['HEALTH_CHECK'])return await handleHealthCheck(b);const g=await checkAdvancedRateLimit(f,b);if(!g['allowed'])return await logSecurityEvent(b,'rate_limit_exceeded',null,f),jsonResponse({'error':'Too\x20many\x20requests','retryAfter':g['retryAfter']},0x1ad);if(await isIPBanned(f,b))return await logSecurityEvent(b,'banned_access_attempt',null,f),serveFakeWebsite();if(e==='websocket'&&d['pathname']===QUANTUM_CONFIG['PATHS']['VLESS_WS'])return await handleQuantumVLESS(a,b,c,'websocket',f);if(a['headers']['get']('content-type')?.['includes']('application/grpc')&&d['pathname']===QUANTUM_CONFIG['PATHS']['VLESS_GRPC'])return await handleQuantumVLESS(a,b,c,'grpc',f);if(d['pathname']===QUANTUM_CONFIG['PATHS']['WEBHOOK']&&a['method']==='POST')return await handleTelegramWebhook(a,b);if(d['pathname']['startsWith'](QUANTUM_CONFIG['PATHS']['API']))return await handleAPIRequest(a,b,f);if(d['pathname']==='/admin-login'&&a['method']==='POST')return await handleAdminLogin(a,b,f);const h=b['ADMIN_PATH_PREFIX']||QUANTUM_CONFIG['PATHS']['ADMIN'];if(d['pathname']===h)return serveAdminPanel();if(d['pathname']['startsWith'](QUANTUM_CONFIG['PATHS']['SUBSCRIPTION']+'/'))return await handleSubscription(a,b);if(d['pathname']['startsWith'](QUANTUM_CONFIG['PATHS']['USER_PANEL']))return serveUserPanel();return serveFakeWebsite();}catch(i){return console['error']('‚ùå\x20Worker\x20Critical\x20Error:',i['message'],i['stack']),await safeLogError(b,i,'fetch_handler'),jsonResponse({'error':'Service\x20temporarily\x20unavailable','code':'INTERNAL_ERROR'},0x1f7);}},async 'scheduled'(a,b,c){console['log']('üïê\x20Running\x20scheduled\x20tasks...');const d=[performAutoBackup(b),cleanExpiredUsers(b),rotateQuantumKeys(b),checkSystemHealth(b),cleanOldLogs(b),updateNodeStatistics(b),updateProxyIPList(b)];c['waitUntil'](Promise['allSettled'](d)['then'](e=>{e['forEach']((f,g)=>{f['status']==='rejected'&&console['error']('‚ùå\x20Task\x20'+g+'\x20failed:',f['reason']);});}));}};async function initializeSystem(a,b){try{await Promise['all']([ensureDatabaseInitialized(a),loadProxyIPs(a)]);}catch(c){console['error']('‚ö†Ô∏è\x20System\x20initialization\x20warning:',c);}}async function ensureDatabaseInitialized(a){try{if(!a['QUANTUM_DB'])return;const b={'users':'CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20users\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20id\x20INTEGER\x20PRIMARY\x20KEY\x20AUTOINCREMENT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20uuid\x20TEXT\x20UNIQUE\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20\x20\x20username\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20traffic_limit\x20INTEGER\x20DEFAULT\x2053687091200,\x0a\x20\x20\x20\x20\x20\x20\x20\x20traffic_used\x20INTEGER\x20DEFAULT\x200,\x0a\x20\x20\x20\x20\x20\x20\x20\x20expiry_date\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20status\x20TEXT\x20DEFAULT\x20\x27active\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20max_connections\x20INTEGER\x20DEFAULT\x203,\x0a\x20\x20\x20\x20\x20\x20\x20\x20created_at\x20TEXT\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20\x20\x20\x20\x20)','connections':'CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20connections\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20id\x20INTEGER\x20PRIMARY\x20KEY\x20AUTOINCREMENT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20user_uuid\x20TEXT\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20\x20\x20client_ip\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20connected_at\x20TEXT\x20DEFAULT\x20CURRENT_TIMESTAMP,\x0a\x20\x20\x20\x20\x20\x20\x20\x20disconnected_at\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20bytes_sent\x20INTEGER\x20DEFAULT\x200,\x0a\x20\x20\x20\x20\x20\x20\x20\x20bytes_received\x20INTEGER\x20DEFAULT\x200,\x0a\x20\x20\x20\x20\x20\x20\x20\x20protocol\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20status\x20TEXT\x20DEFAULT\x20\x27active\x27\x0a\x20\x20\x20\x20\x20\x20)','logs':'CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20logs\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20id\x20INTEGER\x20PRIMARY\x20KEY\x20AUTOINCREMENT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20level\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20message\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20details\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20ip_address\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20created_at\x20TEXT\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20\x20\x20\x20\x20)'};for(const [c,d]of Object['entries'](b)){try{await a['QUANTUM_DB']['prepare']('SELECT\x201\x20FROM\x20'+c+'\x20LIMIT\x201')['first']();}catch{await a['QUANTUM_DB']['prepare'](d)['run'](),console['log']('‚úÖ\x20Created\x20table:\x20'+c);}}}catch(e){console['error']('‚ùå\x20Database\x20initialization\x20error:',e);}}async function loadProxyIPs(a){try{const b=await a['QUANTUM_KV']?.['get']('proxy_ips','json');if(b&&Array['isArray'](b)&&b['length']>0x0){QUANTUM_CONFIG['PROXY_IPS']=b;return;}const c=a['PROXYIP']||'';if(!c)return;const d=c['split'](/[,;\s]+/)['map'](e=>e['trim']())['filter'](e=>e&&isValidIP(e));if(d['length']===0x0)return;QUANTUM_CONFIG['PROXY_IPS']=d,console['log']('‚úÖ\x20Loaded\x20'+d['length']+'\x20proxy\x20IPs'),a['QUANTUM_KV']&&await a['QUANTUM_KV']['put']('proxy_ips',JSON['stringify'](d),{'expirationTtl':0xe10});}catch(e){console['error']('‚ùå\x20Load\x20proxy\x20IPs\x20error:',e),QUANTUM_CONFIG['PROXY_IPS']=[];}}function isValidIP(a){const b=/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,c=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::)$/;return b['test'](a)||c['test'](a);}function getClientIP(a){return a['headers']['get']('CF-Connecting-IP')||a['headers']['get']('X-Forwarded-For')?.['split'](',')[0x0]?.['trim']()||a['headers']['get']('X-Real-IP')||'unknown';}async function checkAdvancedRateLimit(a,b){try{if(!b['QUANTUM_KV'])return{'allowed':!![]};const c='rate_limit:'+a,d=Date['now'](),e=0xea60,f=await b['QUANTUM_KV']['get'](c,'json')||{'tokens':QUANTUM_CONFIG['SECURITY']['RATE_LIMIT_PER_MINUTE'],'lastRefill':d},g=d-f['lastRefill'],h=Math['floor'](g/e*QUANTUM_CONFIG['SECURITY']['RATE_LIMIT_PER_MINUTE']);f['tokens']=Math['min'](QUANTUM_CONFIG['SECURITY']['RATE_LIMIT_BURST'],f['tokens']+h),f['lastRefill']=d;if(f['tokens']<0x1){const i=Math['ceil']((0x1-f['tokens'])*e/QUANTUM_CONFIG['SECURITY']['RATE_LIMIT_PER_MINUTE']/0x3e8);return{'allowed':![],'current':0x0,'retryAfter':i};}return f['tokens']-=0x1,await b['QUANTUM_KV']['put'](c,JSON['stringify'](f),{'expirationTtl':0x12c}),{'allowed':!![],'current':QUANTUM_CONFIG['SECURITY']['RATE_LIMIT_PER_MINUTE']-Math['floor'](f['tokens'])};}catch(j){return console['error']('Rate\x20limit\x20check\x20error:',j),{'allowed':!![]};}}async function isIPBanned(a,b){try{if(!b['QUANTUM_KV'])return![];const c=await b['QUANTUM_KV']['get']('banned_ip:'+a);return c!==null;}catch(d){return![];}}async function logSecurityEvent(a,b,c,d,e){try{if(!a['QUANTUM_DB'])return;await a['QUANTUM_DB']['prepare']('\x0a\x20\x20\x20\x20\x20\x20INSERT\x20INTO\x20logs\x20(level,\x20message,\x20details,\x20ip_address,\x20created_at)\x0a\x20\x20\x20\x20\x20\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20datetime(\x27now\x27))\x0a\x20\x20\x20\x20')['bind']('security',b,e||'',d)['run']();}catch(f){console['error']('Log\x20security\x20event\x20error:',f);}}async function safeLogError(a,b,c){try{if(!a['QUANTUM_DB'])return;await a['QUANTUM_DB']['prepare']('\x0a\x20\x20\x20\x20\x20\x20INSERT\x20INTO\x20logs\x20(level,\x20message,\x20details,\x20created_at)\x0a\x20\x20\x20\x20\x20\x20VALUES\x20(?,\x20?,\x20?,\x20datetime(\x27now\x27))\x0a\x20\x20\x20\x20')['bind']('error',c,b['message']+'\x0a'+b['stack'])['run']();}catch(d){console['error']('Failed\x20to\x20log\x20error:',d);}}async function handleRootProxy(a,b){try{const c=b['ROOT_PROXY_DOMAIN']||'www.speedtest.net',d='https://'+c+new URL(a['url'])['pathname']+new URL(a['url'])['search'],e=new Request(d,{'method':a['method'],'headers':a['headers'],'body':a['body']}),f=await fetch(e),g=new Response(f['body'],f);return g['headers']['delete']('Content-Security-Policy'),g['headers']['delete']('X-Frame-Options'),g;}catch(h){return console['error']('Root\x20proxy\x20error:',h),serveFakeWebsite();}}function serveFakeWebsite(){const a='<!DOCTYPE\x20html>\x0a<html\x20lang=\x22en\x22>\x0a<head>\x0a\x20\x20<meta\x20charset=\x22UTF-8\x22>\x0a\x20\x20<meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,\x20initial-scale=1.0\x22>\x0a\x20\x20<title>Network\x20Services</title>\x0a\x20\x20<style>\x0a\x20\x20\x20\x20*\x20{\x20margin:\x200;\x20padding:\x200;\x20box-sizing:\x20border-box;\x20}\x0a\x20\x20\x20\x20body\x20{\x0a\x20\x20\x20\x20\x20\x20font-family:\x20-apple-system,\x20BlinkMacSystemFont,\x20\x27Segoe\x20UI\x27,\x20Roboto,\x20sans-serif;\x0a\x20\x20\x20\x20\x20\x20background:\x20linear-gradient(135deg,\x20#667eea\x200%,\x20#764ba2\x20100%);\x0a\x20\x20\x20\x20\x20\x20min-height:\x20100vh;\x0a\x20\x20\x20\x20\x20\x20display:\x20flex;\x0a\x20\x20\x20\x20\x20\x20align-items:\x20center;\x0a\x20\x20\x20\x20\x20\x20justify-content:\x20center;\x0a\x20\x20\x20\x20\x20\x20color:\x20white;\x0a\x20\x20\x20\x20\x20\x20text-align:\x20center;\x0a\x20\x20\x20\x20\x20\x20padding:\x2020px;\x0a\x20\x20\x20\x20}\x0a\x20\x20\x20\x20.container\x20{\x0a\x20\x20\x20\x20\x20\x20max-width:\x20600px;\x0a\x20\x20\x20\x20\x20\x20background:\x20rgba(255,\x20255,\x20255,\x200.1);\x0a\x20\x20\x20\x20\x20\x20backdrop-filter:\x20blur(10px);\x0a\x20\x20\x20\x20\x20\x20padding:\x2060px\x2040px;\x0a\x20\x20\x20\x20\x20\x20border-radius:\x2020px;\x0a\x20\x20\x20\x20\x20\x20box-shadow:\x200\x2020px\x2060px\x20rgba(0,\x200,\x200,\x200.3);\x0a\x20\x20\x20\x20}\x0a\x20\x20\x20\x20h1\x20{\x20font-size:\x203rem;\x20margin-bottom:\x2020px;\x20}\x0a\x20\x20\x20\x20p\x20{\x20font-size:\x201.2rem;\x20opacity:\x200.9;\x20line-height:\x201.6;\x20}\x0a\x20\x20\x20\x20.status\x20{\x20margin-top:\x2030px;\x20padding:\x2020px;\x20background:\x20rgba(255,\x20255,\x20255,\x200.2);\x20border-radius:\x2010px;\x20}\x0a\x20\x20</style>\x0a</head>\x0a<body>\x0a\x20\x20<div\x20class=\x22container\x22>\x0a\x20\x20\x20\x20<h1>üåê\x20Network\x20Services</h1>\x0a\x20\x20\x20\x20<p>Professional\x20network\x20infrastructure\x20management\x20and\x20monitoring\x20solutions.</p>\x0a\x20\x20\x20\x20<div\x20class=\x22status\x22>‚úÖ\x20All\x20systems\x20operational</div>\x0a\x20\x20</div>\x0a</body>\x0a</html>';return new Response(a,{'headers':{'Content-Type':'text/html;\x20charset=utf-8',...getSecurityHeaders()}});}async function handleQuantumVLESS(a,b,c,d,e){try{console['log']('üîå\x20New\x20'+d+'\x20connection\x20from\x20'+e);const f=a['headers']['get']('Upgrade');if(!f||f!=='websocket')return new Response('Expected\x20websocket',{'status':0x1aa});const g=new WebSocketPair(),[h,i]=Object['values'](g);return i['accept'](),handleVLESSConnection(i,b,c,e)['catch'](j=>{console['error']('VLESS\x20connection\x20error:',j),i['close'](0x3f3,'Connection\x20error');}),new Response(null,{'status':0x65,'webSocket':h});}catch(j){return console['error']('Quantum\x20VLESS\x20error:',j),new Response('Connection\x20failed',{'status':0x1f4});}}async function handleVLESSConnection(a,b,c,d){let e=null,f=null;try{const g=await new Promise((l,m)=>{const n=setTimeout(()=>m(new Error('Handshake\x20timeout')),0x2710);a['addEventListener']('message',o=>{clearTimeout(n),l(o['data']);},{'once':!![]}),a['addEventListener']('close',()=>{clearTimeout(n),m(new Error('Client\x20closed'));},{'once':!![]});}),h=parseVLESSHeader(g);if(!h)throw new Error('Invalid\x20VLESS\x20header');f=h['uuid'];const i=await validateUserAndCheckLimits(f,d,b);if(!i)throw new Error('Invalid\x20user\x20or\x20quota\x20exceeded');console['log']('‚úÖ\x20User\x20'+f+'\x20authenticated');const j=selectOptimalProxyIP(QUANTUM_CONFIG['PROXY_IPS']);e=await connectToRemote(h['address'],h['port'],j,b);if(!e)throw new Error('Failed\x20to\x20connect\x20to\x20target');console['log']('üéØ\x20Connected\x20to\x20'+h['address']+':'+h['port']);const k=await logNewConnection(b,f,d,'vless');await pipeConnectionsWithObfuscation(a,e,b,f,k);}catch(l){console['error']('VLESS\x20connection\x20handler\x20error:',l);if(e)safeClose(e);if(a['readyState']===WebSocket['OPEN'])a['close'](0x3f3,l['message']);}}function parseVLESSHeader(a){try{const b=new DataView(a),c=b['getUint8'](0x0);if(c!==0x0)return null;const d=new Uint8Array(a,0x1,0x10),e=Array['from'](d)['map'](m=>m['toString'](0x10)['padStart'](0x2,'0'))['join'](''),f=e['slice'](0x0,0x8)+'-'+e['slice'](0x8,0xc)+'-'+e['slice'](0xc,0x10)+'-'+e['slice'](0x10,0x14)+'-'+e['slice'](0x14,0x20);let g=0x11;const h=b['getUint8'](g);g+=0x1+h;const i=b['getUint8'](g);g+=0x1;const j=b['getUint16'](g);g+=0x2;const k=b['getUint8'](g);g+=0x1;let l='';if(k===0x1)l=Array['from'](new Uint8Array(a,g,0x4))['join']('.'),g+=0x4;else{if(k===0x2){const m=b['getUint8'](g);g+=0x1,l=new TextDecoder()['decode'](new Uint8Array(a,g,m)),g+=m;}else{if(k===0x3){const n=new Uint8Array(a,g,0x10);l=Array['from'](n)['reduce']((o,p,q)=>{if(q%0x2===0x0)o['push']('');return o[o['length']-0x1]+=p['toString'](0x10)['padStart'](0x2,'0'),o;},[])['join'](':'),g+=0x10;}}}return{'version':c,'uuid':f,'command':i,'port':j,'address':l,'addressType':k,'dataOffset':g};}catch(o){return console['error']('Parse\x20VLESS\x20header\x20error:',o),null;}}async function validateUserAndCheckLimits(a,b,c){try{if(!c['QUANTUM_DB'])return{'uuid':a,'status':'active'};const d=await c['QUANTUM_DB']['prepare']('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20*\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?\x20AND\x20status\x20=\x20\x27active\x27\x0a\x20\x20\x20\x20')['bind'](a)['first']();if(!d)return null;if(d['expiry_date']){const f=new Date(d['expiry_date']);if(f<new Date())return null;}if(d['traffic_used']>=d['traffic_limit'])return null;const e=await c['QUANTUM_DB']['prepare']('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20COUNT(*)\x20as\x20count\x20FROM\x20connections\x20WHERE\x20user_uuid\x20=\x20?\x20AND\x20status\x20=\x20\x27active\x27\x0a\x20\x20\x20\x20')['bind'](a)['first']();if(e&&e['count']>=d['max_connections'])return null;return d;}catch(g){return console['error']('Validate\x20user\x20error:',g),{'uuid':a,'status':'active'};}}function selectOptimalProxyIP(a){if(!a||a['length']===0x0)return null;return a[Math['floor'](Math['random']()*a['length'])];}async function connectToRemote(a,b,c,d){try{const e={'hostname':a,'port':b};if(c)e['proxyServer']=c;return connect(e);}catch(f){return console['error']('Connect\x20to\x20remote\x20error:',f),null;}}async function logNewConnection(a,b,c,d){try{if(!a['QUANTUM_DB'])return null;const e=await a['QUANTUM_DB']['prepare']('\x0a\x20\x20\x20\x20\x20\x20INSERT\x20INTO\x20connections\x20(user_uuid,\x20client_ip,\x20protocol,\x20status,\x20connected_at)\x0a\x20\x20\x20\x20\x20\x20VALUES\x20(?,\x20?,\x20?,\x20\x27active\x27,\x20datetime(\x27now\x27))\x0a\x20\x20\x20\x20')['bind'](b,c,d)['run']();return e['meta']?.['last_row_id']||null;}catch(f){return console['error']('Log\x20connection\x20error:',f),null;}}async function pipeConnectionsWithObfuscation(a,b,c,d,e){let f=0x0,g=0x0,h=!![];const i=setTimeout(()=>{console['log']('‚è±Ô∏è\x20Connection\x20timeout'),j();},0x493e0),j=async()=>{if(!h)return;h=![],clearTimeout(i),safeClose(a),safeClose(b),await updateConnectionStats(c,d,e,f,g),console['log']('üìä\x20Connection\x20closed.\x20Received:\x20'+f+',\x20Sent:\x20'+g);};try{a['addEventListener']('message',async k=>{if(!h)return;try{let l=k['data'];QUANTUM_CONFIG['QUANTUM_FEATURES']['ENABLE_TRAFFIC_MASKING']&&(l=await applyQuantumObfuscation(l));if(b['writable']){const m=b['writable']['getWriter']();await m['write'](l),m['releaseLock'](),g+=l['byteLength']||l['length'];}}catch(n){console['error']('WebSocket\x20message\x20error:',n),j();}}),((async()=>{try{const k=b['readable']['getReader']();while(h){const {done:l,value:m}=await k['read']();if(l)break;if(m){let n=m;QUANTUM_CONFIG['QUANTUM_FEATURES']['ENABLE_TRAFFIC_MASKING']&&(n=await removeQuantumObfuscation(m)),a['readyState']===WebSocket['OPEN']&&(a['send'](n),f+=n['byteLength']||n['length']);}}k['releaseLock']();}catch(o){console['error']('Remote\x20socket\x20read\x20error:',o);}finally{j();}})()),a['addEventListener']('close',()=>j()),a['addEventListener']('error',k=>j());}catch(k){console['error']('Pipe\x20connections\x20error:',k),j();}}async function applyQuantumObfuscation(a){try{if(QUANTUM_CONFIG['QUANTUM_FEATURES']['ENABLE_PADDING']&&Math['random']()<QUANTUM_CONFIG['TRAFFIC_MASKING']['PADDING_PROBABILITY']){const b=Math['floor'](Math['random']()*QUANTUM_CONFIG['TRAFFIC_MASKING']['MAX_PADDING_SIZE']),c=new Uint8Array(b);crypto['getRandomValues'](c);const d=new Uint8Array(a['byteLength']+b+0x4);return d['set'](new Uint8Array(a),0x0),d['set'](c,a['byteLength']),new DataView(d['buffer'])['setUint32'](d['length']-0x4,a['byteLength']),d;}return a;}catch(e){return a;}}async function removeQuantumObfuscation(a){try{if(a['byteLength']>0x4){const b=new DataView(a['buffer']),c=b['getUint32'](a['byteLength']-0x4);if(c<a['byteLength'])return a['slice'](0x0,c);}return a;}catch(d){return a;}}async function updateConnectionStats(a,b,c,d,e){try{if(!a['QUANTUM_DB'])return;c&&await a['QUANTUM_DB']['prepare']('\x0a\x20\x20\x20\x20\x20\x20\x20\x20UPDATE\x20connections\x20SET\x20bytes_received\x20=\x20?,\x20bytes_sent\x20=\x20?,\x20disconnected_at\x20=\x20datetime(\x27now\x27),\x20status\x20=\x20\x27closed\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x20id\x20=\x20?\x0a\x20\x20\x20\x20\x20\x20')['bind'](d,e,c)['run'](),await a['QUANTUM_DB']['prepare']('\x0a\x20\x20\x20\x20\x20\x20UPDATE\x20users\x20SET\x20traffic_used\x20=\x20traffic_used\x20+\x20?,\x20updated_at\x20=\x20datetime(\x27now\x27)\x20WHERE\x20uuid\x20=\x20?\x0a\x20\x20\x20\x20')['bind'](d+e,b)['run']();}catch(f){console['error']('Update\x20connection\x20stats\x20error:',f);}}function safeClose(a){try{if(a){if(a['close'])a['close']();else{if(a['writable'])a['writable']['abort']();}}}catch(b){console['error']('Safe\x20close\x20error:',b);}}async function handleAPIRequest(a,b,c){const d=new URL(a['url']),e=d['pathname']['replace'](QUANTUM_CONFIG['PATHS']['API'],''),f=a['headers']['get']('Authorization');if(!f||!f['startsWith']('Bearer\x20'))return jsonResponse({'error':'Unauthorized'},0x191);const g=f['slice'](0x7),h=b['API_TOKEN'];if(!h||g!==h)return jsonResponse({'error':'Invalid\x20token'},0x191);try{if(e==='/users'&&a['method']==='GET')return await handleGetUsers(b);if(e==='/users'&&a['method']==='POST')return await handleCreateUser(a,b);if(e['startsWith']('/users/')&&a['method']==='GET'){const i=e['split']('/')[0x2];return await handleGetUser(i,b);}if(e==='/stats'&&a['method']==='GET')return await handleGetStats(b);return jsonResponse({'error':'Not\x20found'},0x194);}catch(j){return console['error']('API\x20request\x20error:',j),jsonResponse({'error':'Internal\x20server\x20error'},0x1f4);}}async function handleGetUsers(a){try{if(!a['QUANTUM_DB'])return jsonResponse({'error':'Database\x20not\x20available'},0x1f7);const b=await a['QUANTUM_DB']['prepare']('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20uuid,\x20username,\x20traffic_limit,\x20traffic_used,\x20expiry_date,\x20status,\x20created_at\x0a\x20\x20\x20\x20\x20\x20FROM\x20users\x20ORDER\x20BY\x20created_at\x20DESC\x0a\x20\x20\x20\x20')['all']();return jsonResponse({'success':!![],'data':b['results']||[]});}catch(c){return jsonResponse({'error':'Failed\x20to\x20fetch\x20users'},0x1f4);}}async function handleCreateUser(a,b){try{if(!b['QUANTUM_DB'])return jsonResponse({'error':'Database\x20not\x20available'},0x1f7);const c=await a['json'](),{username:d,traffic_limit:e,expiry_days:f,max_connections:g}=c,h=crypto['randomUUID']();let i=null;if(f){const j=new Date();j['setDate'](j['getDate']()+f),i=j['toISOString']();}return await b['QUANTUM_DB']['prepare']('\x0a\x20\x20\x20\x20\x20\x20INSERT\x20INTO\x20users\x20(uuid,\x20username,\x20traffic_limit,\x20expiry_date,\x20max_connections,\x20status)\x0a\x20\x20\x20\x20\x20\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20\x27active\x27)\x0a\x20\x20\x20\x20')['bind'](h,d||'User',e||0xc80000000,i,g||0x3)['run'](),jsonResponse({'success':!![],'data':{'uuid':h,'username':d,'traffic_limit':e,'expiry_date':i,'subscription_link':''+new URL(a['url'])['origin']+QUANTUM_CONFIG['PATHS']['SUBSCRIPTION']+'/'+h}});}catch(k){return jsonResponse({'error':'Failed\x20to\x20create\x20user'},0x1f4);}}async function handleGetUser(a,b){try{if(!b['QUANTUM_DB'])return jsonResponse({'error':'Database\x20not\x20available'},0x1f7);const c=await b['QUANTUM_DB']['prepare']('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20uuid,\x20username,\x20traffic_limit,\x20traffic_used,\x20expiry_date,\x20status,\x20max_connections,\x20created_at\x0a\x20\x20\x20\x20\x20\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?\x0a\x20\x20\x20\x20')['bind'](a)['first']();if(!c)return jsonResponse({'error':'User\x20not\x20found'},0x194);return jsonResponse({'success':!![],'data':c});}catch(d){return jsonResponse({'error':'Failed\x20to\x20fetch\x20user'},0x1f4);}}async function handleGetStats(a){try{if(!a['QUANTUM_DB'])return jsonResponse({'error':'Database\x20not\x20available'},0x1f7);const b=await a['QUANTUM_DB']['prepare']('SELECT\x20COUNT(*)\x20as\x20count\x20FROM\x20users')['first'](),c=await a['QUANTUM_DB']['prepare']('SELECT\x20COUNT(*)\x20as\x20count\x20FROM\x20users\x20WHERE\x20status\x20=\x20\x27active\x27')['first'](),d=await a['QUANTUM_DB']['prepare']('SELECT\x20COUNT(*)\x20as\x20count\x20FROM\x20connections\x20WHERE\x20status\x20=\x20\x27active\x27')['first'](),e=await a['QUANTUM_DB']['prepare']('SELECT\x20SUM(traffic_used)\x20as\x20total\x20FROM\x20users')['first']();return jsonResponse({'success':!![],'data':{'total_users':b?.['count']||0x0,'active_users':c?.['count']||0x0,'active_connections':d?.['count']||0x0,'total_traffic':e?.['total']||0x0,'version':QUANTUM_CONFIG['VERSION']}});}catch(f){return jsonResponse({'error':'Failed\x20to\x20fetch\x20stats'},0x1f4);}}async function handleTelegramWebhook(a,b){try{const c=await a['json']();return console['log']('üì±\x20Telegram\x20webhook:',c),jsonResponse({'ok':!![]});}catch(d){return jsonResponse({'error':'Webhook\x20processing\x20failed'},0x1f4);}}async function handleAdminLogin(a,b,c){try{const d=await a['json'](),{password:e,totp:f}=d,g=await getLoginAttempts(c,b);if(g>=QUANTUM_CONFIG['SECURITY']['MAX_LOGIN_ATTEMPTS'])return jsonResponse({'success':![],'error':'Too\x20many\x20login\x20attempts'},0x1ad);const h=b['ADMIN_PASSWORD']||'admin123';if(e!==h)return await incrementLoginAttempts(c,b),jsonResponse({'success':![],'error':'Invalid\x20credentials'},0x191);const i=crypto['randomUUID']();return b['QUANTUM_KV']&&await b['QUANTUM_KV']['put']('session:'+i,c,{'expirationTtl':QUANTUM_CONFIG['SECURITY']['SESSION_TIMEOUT_HOURS']*0xe10}),await resetLoginAttempts(c,b),await logSecurityEvent(b,'successful_admin_login',null,c,'Admin\x20logged\x20in'),jsonResponse({'success':!![],'token':i,'message':'Login\x20successful'});}catch(j){return jsonResponse({'success':![],'error':'Login\x20failed'},0x1f4);}}async function getLoginAttempts(a,b){try{if(!b['QUANTUM_KV'])return 0x0;const c=await b['QUANTUM_KV']['get']('login_attempts:'+a);return parseInt(c)||0x0;}catch(d){return 0x0;}}async function incrementLoginAttempts(a,b){try{if(!b['QUANTUM_KV'])return;const c=await getLoginAttempts(a,b);await b['QUANTUM_KV']['put']('login_attempts:'+a,(c+0x1)['toString'](),{'expirationTtl':QUANTUM_CONFIG['SECURITY']['LOGIN_COOLDOWN_MINUTES']*0x3c});}catch(d){console['error']('Increment\x20login\x20attempts\x20error:',d);}}async function resetLoginAttempts(a,b){try{if(!b['QUANTUM_KV'])return;await b['QUANTUM_KV']['delete']('login_attempts:'+a);}catch(c){console['error']('Reset\x20login\x20attempts\x20error:',c);}}async function handleSubscription(a,b){try{const c=new URL(a['url']),d=c['pathname']['split']('/')['pop']();if(!d)return new Response('Invalid\x20subscription\x20link',{'status':0x190});const e=await getUserByUUID(d,b);if(!e)return new Response('User\x20not\x20found',{'status':0x194});const f=generateSubscriptionContent(e,a);return new Response(f,{'headers':{'Content-Type':'text/plain;\x20charset=utf-8','Content-Disposition':'attachment;\x20filename=\x22quantum_subscription_'+d+'.txt\x22','Profile-Update-Interval':'24','Subscription-Userinfo':'upload='+e['traffic_used']+';\x20download='+e['traffic_used']+';\x20total='+e['traffic_limit']+';\x20expire='+(e['expiry_date']?new Date(e['expiry_date'])['getTime']()/0x3e8:0x0)}});}catch(g){return new Response('Subscription\x20generation\x20failed',{'status':0x1f4});}}async function getUserByUUID(a,b){try{if(!b['QUANTUM_DB'])return{'uuid':a,'status':'active'};return await b['QUANTUM_DB']['prepare']('SELECT\x20*\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](a)['first']();}catch(c){return null;}}function generateSubscriptionContent(a,b){const c=new URL(b['url'])['host'],d=a['uuid'],e=[],f='vless://'+d+'@'+c+':443?encryption=none&security=tls&type=ws&host='+c+'&path='+encodeURIComponent(QUANTUM_CONFIG['PATHS']['VLESS_WS'])+'&sni='+c+'#Quantum_WS_'+c;e['push'](f);const g='vless://'+d+'@'+c+':443?encryption=none&security=tls&type=grpc&serviceName='+QUANTUM_CONFIG['PATHS']['VLESS_GRPC']['slice'](0x1)+'&sni='+c+'#Quantum_gRPC_'+c;e['push'](g);const h=[...QUANTUM_CONFIG['ANTI_FILTER_SNI']['priority_high'],...QUANTUM_CONFIG['ANTI_FILTER_SNI']['priority_medium']];return h['slice'](0x0,0x5)['forEach'](i=>{const j='vless://'+d+'@'+c+':443?encryption=none&security=tls&type=ws&host='+c+'&path='+encodeURIComponent(QUANTUM_CONFIG['PATHS']['VLESS_WS'])+'&sni='+i+'#Quantum_'+i['replace'](/\./g,'_');e['push'](j);}),btoa(e['join']('\x0a'));}function serveAdminPanel(){const a='<!DOCTYPE\x20html>\x0a<html\x20dir=\x22rtl\x22\x20lang=\x22fa\x22>\x0a<head>\x0a\x20\x20<meta\x20charset=\x22UTF-8\x22>\x0a\x20\x20<meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,\x20initial-scale=1.0\x22>\x0a\x20\x20<title>Quantum\x20Shield\x20V7\x20-\x20Admin\x20Panel</title>\x0a\x20\x20<style>\x0a\x20\x20\x20\x20*\x20{\x20margin:\x200;\x20padding:\x200;\x20box-sizing:\x20border-box;\x20}\x0a\x20\x20\x20\x20body\x20{\x20\x0a\x20\x20\x20\x20\x20\x20font-family:\x20\x27Segoe\x20UI\x27,\x20Tahoma,\x20Geneva,\x20Verdana,\x20sans-serif;\x0a\x20\x20\x20\x20\x20\x20background:\x20linear-gradient(135deg,\x20#1e3c72\x200%,\x20#2a5298\x20100%);\x0a\x20\x20\x20\x20\x20\x20min-height:\x20100vh;\x0a\x20\x20\x20\x20\x20\x20display:\x20flex;\x0a\x20\x20\x20\x20\x20\x20align-items:\x20center;\x0a\x20\x20\x20\x20\x20\x20justify-content:\x20center;\x0a\x20\x20\x20\x20\x20\x20color:\x20white;\x0a\x20\x20\x20\x20\x20\x20padding:\x2020px;\x0a\x20\x20\x20\x20}\x0a\x20\x20\x20\x20.login-container\x20{\x0a\x20\x20\x20\x20\x20\x20background:\x20rgba(255,\x20255,\x20255,\x200.1);\x0a\x20\x20\x20\x20\x20\x20backdrop-filter:\x20blur(15px);\x0a\x20\x20\x20\x20\x20\x20padding:\x2060px\x2050px;\x0a\x20\x20\x20\x20\x20\x20border-radius:\x2025px;\x0a\x20\x20\x20\x20\x20\x20box-shadow:\x200\x2020px\x2060px\x20rgba(0,\x200,\x200,\x200.4);\x0a\x20\x20\x20\x20\x20\x20text-align:\x20center;\x0a\x20\x20\x20\x20\x20\x20max-width:\x20450px;\x0a\x20\x20\x20\x20\x20\x20width:\x20100%;\x0a\x20\x20\x20\x20}\x0a\x20\x20\x20\x20h1\x20{\x20margin-bottom:\x2015px;\x20font-size:\x202.5rem;\x20text-shadow:\x202px\x202px\x204px\x20rgba(0,0,0,0.3);\x20}\x0a\x20\x20\x20\x20.version\x20{\x20font-size:\x200.9rem;\x20opacity:\x200.8;\x20margin-bottom:\x2040px;\x20}\x0a\x20\x20\x20\x20input\x20{\x0a\x20\x20\x20\x20\x20\x20width:\x20100%;\x0a\x20\x20\x20\x20\x20\x20padding:\x2018px;\x0a\x20\x20\x20\x20\x20\x20margin:\x2015px\x200;\x0a\x20\x20\x20\x20\x20\x20border:\x202px\x20solid\x20rgba(255,\x20255,\x20255,\x200.3);\x0a\x20\x20\x20\x20\x20\x20background:\x20rgba(255,\x20255,\x20255,\x200.15);\x0a\x20\x20\x20\x20\x20\x20color:\x20white;\x0a\x20\x20\x20\x20\x20\x20border-radius:\x2012px;\x0a\x20\x20\x20\x20\x20\x20font-size:\x201rem;\x0a\x20\x20\x20\x20}\x0a\x20\x20\x20\x20input:focus\x20{\x20outline:\x20none;\x20border-color:\x20rgba(255,\x20255,\x20255,\x200.6);\x20background:\x20rgba(255,\x20255,\x20255,\x200.2);\x20}\x0a\x20\x20\x20\x20input::placeholder\x20{\x20color:\x20rgba(255,\x20255,\x20255,\x200.6);\x20}\x0a\x20\x20\x20\x20button\x20{\x0a\x20\x20\x20\x20\x20\x20width:\x20100%;\x0a\x20\x20\x20\x20\x20\x20padding:\x2018px;\x0a\x20\x20\x20\x20\x20\x20margin-top:\x2025px;\x0a\x20\x20\x20\x20\x20\x20background:\x20linear-gradient(135deg,\x20#667eea\x200%,\x20#764ba2\x20100%);\x0a\x20\x20\x20\x20\x20\x20border:\x20none;\x0a\x20\x20\x20\x20\x20\x20color:\x20white;\x0a\x20\x20\x20\x20\x20\x20border-radius:\x2012px;\x0a\x20\x20\x20\x20\x20\x20font-size:\x201.2rem;\x0a\x20\x20\x20\x20\x20\x20font-weight:\x20bold;\x0a\x20\x20\x20\x20\x20\x20cursor:\x20pointer;\x0a\x20\x20\x20\x20\x20\x20box-shadow:\x200\x204px\x2015px\x20rgba(102,\x20126,\x20234,\x200.4);\x0a\x20\x20\x20\x20}\x0a\x20\x20\x20\x20button:hover\x20{\x20transform:\x20translateY(-2px);\x20box-shadow:\x200\x206px\x2020px\x20rgba(102,\x20126,\x20234,\x200.6);\x20}\x0a\x20\x20\x20\x20.error\x20{\x20color:\x20#ff6b6b;\x20margin-top:\x2020px;\x20padding:\x2015px;\x20background:\x20rgba(255,\x20107,\x20107,\x200.2);\x20border-radius:\x2010px;\x20}\x0a\x20\x20</style>\x0a</head>\x0a<body>\x0a\x20\x20<div\x20class=\x22login-container\x22>\x0a\x20\x20\x20\x20<h1>üõ°Ô∏è\x20Quantum\x20Shield</h1>\x0a\x20\x20\x20\x20<div\x20class=\x22version\x22>Version\x207.0\x20-\x20Ultimate\x20Edition</div>\x0a\x20\x20\x20\x20<form\x20id=\x22loginForm\x22>\x0a\x20\x20\x20\x20\x20\x20<input\x20type=\x22password\x22\x20id=\x22password\x22\x20placeholder=\x22⁄©ŸÑŸÖŸá\x20ÿπÿ®Ÿàÿ±\x20ÿßÿØŸÖ€åŸÜ\x22\x20required>\x0a\x20\x20\x20\x20\x20\x20<input\x20type=\x22text\x22\x20id=\x22totp\x22\x20placeholder=\x22⁄©ÿØ\x20TOTP\x20(ÿßÿÆÿ™€åÿßÿ±€å)\x22>\x0a\x20\x20\x20\x20\x20\x20<button\x20type=\x22submit\x22>üîê\x20Ÿàÿ±ŸàÿØ\x20ÿ®Ÿá\x20ŸæŸÜŸÑ</button>\x0a\x20\x20\x20\x20</form>\x0a\x20\x20\x20\x20<div\x20id=\x22error\x22\x20class=\x22error\x22\x20style=\x22display:\x20none;\x22></div>\x0a\x20\x20</div>\x0a\x20\x20<script>\x0a\x20\x20\x20\x20document.getElementById(\x27loginForm\x27).addEventListener(\x27submit\x27,\x20async\x20(e)\x20=>\x20{\x0a\x20\x20\x20\x20\x20\x20e.preventDefault();\x0a\x20\x20\x20\x20\x20\x20const\x20password\x20=\x20document.getElementById(\x27password\x27).value;\x0a\x20\x20\x20\x20\x20\x20const\x20totp\x20=\x20document.getElementById(\x27totp\x27).value;\x0a\x20\x20\x20\x20\x20\x20const\x20errorDiv\x20=\x20document.getElementById(\x27error\x27);\x0a\x20\x20\x20\x20\x20\x20const\x20button\x20=\x20e.target.querySelector(\x27button\x27);\x0a\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20button.disabled\x20=\x20true;\x0a\x20\x20\x20\x20\x20\x20button.textContent\x20=\x20\x27‚è≥\x20ÿØÿ±\x20ÿ≠ÿßŸÑ\x20Ÿàÿ±ŸàÿØ...\x27;\x0a\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20try\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20const\x20response\x20=\x20await\x20fetch(\x27/admin-login\x27,\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20method:\x20\x27POST\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20headers:\x20{\x20\x27Content-Type\x27:\x20\x27application/json\x27\x20},\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20body:\x20JSON.stringify({\x20password,\x20totp\x20})\x0a\x20\x20\x20\x20\x20\x20\x20\x20});\x0a\x20\x20\x20\x20\x20\x20\x20\x20const\x20data\x20=\x20await\x20response.json();\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20if\x20(data.success)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20localStorage.setItem(\x27admin_token\x27,\x20data.token);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20errorDiv.style.display\x20=\x20\x27none\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20button.textContent\x20=\x20\x27‚úÖ\x20Ÿàÿ±ŸàÿØ\x20ŸÖŸàŸÅŸÇ!\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20setTimeout(()\x20=>\x20alert(\x27ÿ®Ÿá\x20ŸæŸÜŸÑ\x20ŸÖÿØ€åÿ±€åÿ™\x20ÿÆŸàÿ¥\x20ÿ¢ŸÖÿØ€åÿØ!\x27),\x201000);\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x20else\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20errorDiv.textContent\x20=\x20data.error\x20||\x20\x27ÿÆÿ∑ÿß\x20ÿØÿ±\x20Ÿàÿ±ŸàÿØ\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20errorDiv.style.display\x20=\x20\x27block\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20button.disabled\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20button.textContent\x20=\x20\x27üîê\x20Ÿàÿ±ŸàÿØ\x20ÿ®Ÿá\x20ŸæŸÜŸÑ\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20}\x20catch\x20(error)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20errorDiv.textContent\x20=\x20\x27ÿÆÿ∑ÿß€å\x20ÿßÿ™ÿµÿßŸÑ\x20ÿ®Ÿá\x20ÿ≥ÿ±Ÿàÿ±\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20errorDiv.style.display\x20=\x20\x27block\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20button.disabled\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20button.textContent\x20=\x20\x27üîê\x20Ÿàÿ±ŸàÿØ\x20ÿ®Ÿá\x20ŸæŸÜŸÑ\x27;\x0a\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20});\x0a\x20\x20</script>\x0a</body>\x0a</html>';return new Response(a,{'headers':{'Content-Type':'text/html;\x20charset=utf-8',...getSecurityHeaders()}});}function serveUserPanel(){const a='<!DOCTYPE\x20html>\x0a<html\x20lang=\x22fa\x22\x20dir=\x22rtl\x22>\x0a<head>\x0a\x20\x20<meta\x20charset=\x22UTF-8\x22>\x0a\x20\x20<meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,\x20initial-scale=1.0\x22>\x0a\x20\x20<title>Quantum\x20User\x20Panel</title>\x0a\x20\x20<style>\x0a\x20\x20\x20\x20*\x20{\x20margin:\x200;\x20padding:\x200;\x20box-sizing:\x20border-box;\x20}\x0a\x20\x20\x20\x20body\x20{\x20font-family:\x20\x27Segoe\x20UI\x27,\x20Tahoma,\x20Geneva,\x20Verdana,\x20sans-serif;\x20background:\x20linear-gradient(135deg,\x20#667eea\x200%,\x20#764ba2\x20100%);\x20min-height:\x20100vh;\x20padding:\x2030px\x2020px;\x20}\x0a\x20\x20\x20\x20.container\x20{\x20max-width:\x20900px;\x20margin:\x200\x20auto;\x20background:\x20white;\x20border-radius:\x2025px;\x20padding:\x2050px;\x20box-shadow:\x200\x2025px\x2070px\x20rgba(0,0,0,0.3);\x20}\x0a\x20\x20\x20\x20h1\x20{\x20color:\x20#2d3748;\x20margin-bottom:\x2040px;\x20text-align:\x20center;\x20font-size:\x202.5rem;\x20}\x0a\x20\x20\x20\x20.stat-card\x20{\x20background:\x20linear-gradient(135deg,\x20#667eea\x200%,\x20#764ba2\x20100%);\x20color:\x20white;\x20padding:\x2030px;\x20border-radius:\x2020px;\x20margin-bottom:\x2025px;\x20box-shadow:\x200\x2010px\x2030px\x20rgba(102,\x20126,\x20234,\x200.3);\x20}\x0a\x20\x20\x20\x20.stat-title\x20{\x20font-size:\x201rem;\x20opacity:\x200.9;\x20margin-bottom:\x2010px;\x20text-transform:\x20uppercase;\x20}\x0a\x20\x20\x20\x20.stat-value\x20{\x20font-size:\x202.5rem;\x20font-weight:\x20bold;\x20}\x0a\x20\x20\x20\x20button\x20{\x20width:\x20100%;\x20padding:\x2018px;\x20background:\x20linear-gradient(135deg,\x20#667eea\x200%,\x20#764ba2\x20100%);\x20border:\x20none;\x20color:\x20white;\x20border-radius:\x2012px;\x20font-size:\x201.1rem;\x20font-weight:\x20bold;\x20cursor:\x20pointer;\x20margin-top:\x2015px;\x20}\x0a\x20\x20\x20\x20button:hover\x20{\x20transform:\x20translateY(-2px);\x20}\x0a\x20\x20</style>\x0a</head>\x0a<body>\x0a\x20\x20<div\x20class=\x22container\x22>\x0a\x20\x20\x20\x20<h1>üéØ\x20ŸæŸÜŸÑ\x20⁄©ÿßÿ±ÿ®ÿ±€å\x20Quantum</h1>\x0a\x20\x20\x20\x20<div\x20class=\x22stat-card\x22><div\x20class=\x22stat-title\x22>üìä\x20ÿ≠ÿ¨ŸÖ\x20ÿßÿ≥ÿ™ŸÅÿßÿØŸá\x20ÿ¥ÿØŸá</div><div\x20class=\x22stat-value\x22\x20id=\x22usedTraffic\x22>0\x20GB</div></div>\x0a\x20\x20\x20\x20<div\x20class=\x22stat-card\x22><div\x20class=\x22stat-title\x22>üíæ\x20ÿ≠ÿ¨ŸÖ\x20⁄©ŸÑ</div><div\x20class=\x22stat-value\x22\x20id=\x22totalQuota\x22>50\x20GB</div></div>\x0a\x20\x20\x20\x20<div\x20class=\x22stat-card\x22><div\x20class=\x22stat-title\x22>‚è∞\x20ÿ±Ÿàÿ≤Ÿáÿß€å\x20ÿ®ÿßŸÇ€åŸÖÿßŸÜÿØŸá</div><div\x20class=\x22stat-value\x22\x20id=\x22daysRemaining\x22>30\x20ÿ±Ÿàÿ≤</div></div>\x0a\x20\x20\x20\x20<button\x20onclick=\x22copySubLink()\x22>üìã\x20⁄©Ÿæ€å\x20ŸÑ€åŸÜ⁄©\x20ÿßÿ¥ÿ™ÿ±ÿß⁄©</button>\x0a\x20\x20\x20\x20<button\x20onclick=\x22refreshData()\x22>üîÑ\x20ÿ®ÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å\x20ÿßÿ∑ŸÑÿßÿπÿßÿ™</button>\x0a\x20\x20</div>\x0a\x20\x20<script>\x0a\x20\x20\x20\x20const\x20urlParams\x20=\x20new\x20URLSearchParams(window.location.search);\x0a\x20\x20\x20\x20const\x20uuid\x20=\x20urlParams.get(\x27uuid\x27);\x0a\x20\x20\x20\x20if\x20(!uuid)\x20alert(\x27UUID\x20ŸÖÿπÿ™ÿ®ÿ±\x20ŸÜ€åÿ≥ÿ™\x27);\x0a\x20\x20\x20\x20\x0a\x20\x20\x20\x20async\x20function\x20refreshData()\x20{\x0a\x20\x20\x20\x20\x20\x20document.getElementById(\x27usedTraffic\x27).textContent\x20=\x20\x2715.3\x20GB\x27;\x0a\x20\x20\x20\x20\x20\x20document.getElementById(\x27totalQuota\x27).textContent\x20=\x20\x2750\x20GB\x27;\x0a\x20\x20\x20\x20\x20\x20document.getElementById(\x27daysRemaining\x27).textContent\x20=\x20\x2722\x20ÿ±Ÿàÿ≤\x27;\x0a\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x0a\x20\x20\x20\x20function\x20copySubLink()\x20{\x0a\x20\x20\x20\x20\x20\x20const\x20subLink\x20=\x20window.location.origin\x20+\x20\x27/sub/\x27\x20+\x20uuid;\x0a\x20\x20\x20\x20\x20\x20navigator.clipboard.writeText(subLink).then(()\x20=>\x20alert(\x27‚úÖ\x20ŸÑ€åŸÜ⁄©\x20ÿßÿ¥ÿ™ÿ±ÿß⁄©\x20⁄©Ÿæ€å\x20ÿ¥ÿØ!\x27));\x0a\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x0a\x20\x20\x20\x20refreshData();\x0a\x20\x20\x20\x20setInterval(refreshData,\x2030000);\x0a\x20\x20</script>\x0a</body>\x0a</html>';return new Response(a,{'headers':{'Content-Type':'text/html;\x20charset=utf-8',...getSecurityHeaders()}});}async function handleHealthCheck(a){try{const b={'status':'healthy','version':QUANTUM_CONFIG['VERSION'],'timestamp':new Date()['toISOString'](),'checks':{}};if(a['QUANTUM_DB'])try{await a['QUANTUM_DB']['prepare']('SELECT\x201')['first'](),b['checks']['database']='ok';}catch{b['checks']['database']='error',b['status']='degraded';}if(a['QUANTUM_KV'])try{await a['QUANTUM_KV']['get']('health_check'),b['checks']['kv']='ok';}catch{b['checks']['kv']='error',b['status']='degraded';}return jsonResponse(b);}catch(c){return jsonResponse({'status':'unhealthy','error':c['message']},0x1f7);}}async function performAutoBackup(a){try{if(!a['QUANTUM_DB']||!a['QUANTUM_KV'])return;const b=await a['QUANTUM_DB']['prepare']('SELECT\x20*\x20FROM\x20users')['all']();await a['QUANTUM_KV']['put']('backup:users',JSON['stringify'](b['results']),{'expirationTtl':0x93a80}),console['log']('‚úÖ\x20Backup\x20completed:\x20'+(b['results']?.['length']||0x0)+'\x20users');}catch(c){console['error']('‚ùå\x20Auto\x20backup\x20error:',c);}}async function cleanExpiredUsers(a){try{if(!a['QUANTUM_DB'])return;const b=await a['QUANTUM_DB']['prepare']('\x0a\x20\x20\x20\x20\x20\x20UPDATE\x20users\x20SET\x20status\x20=\x20\x27expired\x27\x20WHERE\x20expiry_date\x20<\x20datetime(\x27now\x27)\x20AND\x20status\x20=\x20\x27active\x27\x0a\x20\x20\x20\x20')['run']();console['log']('‚úÖ\x20Expired\x20'+(b['meta']?.['changes']||0x0)+'\x20users');}catch(c){console['error']('‚ùå\x20Clean\x20expired\x20users\x20error:',c);}}async function rotateQuantumKeys(a){try{if(!a['QUANTUM_KV'])return;const b={'encryption_key':crypto['randomUUID'](),'obfuscation_seed':Math['floor'](Math['random']()*0xf4240),'timestamp':Date['now']()};await a['QUANTUM_KV']['put']('quantum_keys',JSON['stringify'](b),{'expirationTtl':0x15180}),console['log']('‚úÖ\x20Quantum\x20keys\x20rotated');}catch(c){console['error']('‚ùå\x20Rotate\x20keys\x20error:',c);}}async function checkSystemHealth(a){try{const b={'timestamp':new Date()['toISOString'](),'status':'healthy'};if(a['QUANTUM_DB'])try{await a['QUANTUM_DB']['prepare']('SELECT\x201')['first'](),b['database']='ok';}catch{b['database']='error',b['status']='unhealthy';}if(a['QUANTUM_KV'])try{await a['QUANTUM_KV']['get']('health_check'),b['kv']='ok';}catch{b['kv']='error',b['status']='degraded';}console['log']('‚úÖ\x20System\x20health:\x20'+b['status']);}catch(c){console['error']('‚ùå\x20Health\x20check\x20error:',c);}}async function cleanOldLogs(a){try{if(!a['QUANTUM_DB'])return;const b=await a['QUANTUM_DB']['prepare']('DELETE\x20FROM\x20logs\x20WHERE\x20created_at\x20<\x20datetime(\x27now\x27,\x20\x27-30\x20days\x27)')['run']();console['log']('‚úÖ\x20Deleted\x20'+(b['meta']?.['changes']||0x0)+'\x20old\x20logs');}catch(c){console['error']('‚ùå\x20Clean\x20logs\x20error:',c);}}async function updateNodeStatistics(a){try{if(!a['QUANTUM_DB'])return;const b=new Date()['toISOString']()['split']('T')[0x0],c=await a['QUANTUM_DB']['prepare']('\x0a\x20\x20\x20\x20\x20\x20SELECT\x20COUNT(*)\x20as\x20total_connections,\x20SUM(bytes_sent\x20+\x20bytes_received)\x20as\x20total_traffic\x0a\x20\x20\x20\x20\x20\x20FROM\x20connections\x20WHERE\x20DATE(connected_at)\x20=\x20?\x0a\x20\x20\x20\x20')['bind'](b)['first']();console['log']('‚úÖ\x20Node\x20stats:\x20'+(c?.['total_connections']||0x0)+'\x20connections');}catch(d){console['error']('‚ùå\x20Update\x20node\x20stats\x20error:',d);}}async function updateProxyIPList(a){try{await loadProxyIPs(a),console['log']('‚úÖ\x20Proxy\x20IPs\x20updated:\x20'+QUANTUM_CONFIG['PROXY_IPS']['length']+'\x20available');}catch(b){console['error']('‚ùå\x20Update\x20proxy\x20IPs\x20error:',b);}}function getSecurityHeaders(){return{'X-Content-Type-Options':'nosniff','X-Frame-Options':'DENY','X-XSS-Protection':'1;\x20mode=block','Referrer-Policy':'strict-origin-when-cross-origin','Strict-Transport-Security':'max-age=31536000;\x20includeSubDomains;\x20preload'};}function getCORSHeaders(){return{'Access-Control-Allow-Origin':'*','Access-Control-Allow-Methods':'GET,\x20POST,\x20PUT,\x20DELETE,\x20OPTIONS','Access-Control-Allow-Headers':'Content-Type,\x20Authorization,\x20X-Requested-With','Access-Control-Max-Age':'86400'};}function jsonResponse(a,b=0xc8){return new Response(JSON['stringify'](a,null,0x2),{'status':b,'headers':{'Content-Type':'application/json;\x20charset=utf-8',...getSecurityHeaders(),...getCORSHeaders()}});}