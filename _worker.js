// <!--GAMFC-->version base on commit: 64b7a8b1f67c269a4f865ebc992435ce027c4d8d - last update: 2025-12-22 21:27:15 UTC <!--GAMFC-END-->.

async function getUserData(a,b,c){if(!isValidUUID(b))return console['warn']('Invalid\x20UUID\x20format:\x20'+b),null;if(!a['DB'])return console['error']('D1\x20binding\x20missing.\x20Cannot\x20retrieve\x20user\x20data.'),null;const d='user:'+b;let f=null;try{f=await d1KvGet(a['DB'],d,'json');if(f&&f['uuid'])return f;}catch(i){console['error'](i['message']);}const g=await a['DB']['prepare']('SELECT\x20*\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](b)['first']();if(!g)return f&&c['waitUntil'](d1KvDelete(a['DB'],d)),null;const h=d1KvPut(a['DB'],d,g,{'expirationTtl':CONST['DB_CACHE_TTL']});return c?c['waitUntil'](h['catch'](j=>console['error'](j['message']))):await h['catch'](j=>console['error'](j['message'])),g;}async function updateUsage(a,b,c,d){if(c<=0x0||!b)return;if(!a['DB']){console['error']('D1\x20binding\x20missing.\x20Cannot\x20update\x20user\x20usage.');return;}const f='usage_lock:'+b;let g=![];const h=0x5;try{const j=0x5;for(let n=0x0;n<j;n++){const o=await d1KvGet(a['DB'],f);if(!o){await d1KvPut(a['DB'],f,'locked',{'expirationTtl':h}),g=!![];break;}else await new Promise(p=>setTimeout(p,0x64*(n+0x1)));}if(!g){console['warn']('Failed\x20to\x20acquire\x20lock\x20for\x20'+b+'\x20after\x20attempts.\x20Skipping\x20usage\x20update.');return;}const k=Math['round'](c),l=a['DB']['prepare']('UPDATE\x20users\x20SET\x20traffic_used\x20=\x20traffic_used\x20+\x20?\x20WHERE\x20uuid\x20=\x20?')['bind'](k,b)['run'](),m=d1KvDelete(a['DB'],'user:'+b);d?d['waitUntil'](Promise['all']([l,m])['catch'](p=>console['error'](p))):await Promise['all']([l,m])['catch'](p=>console['error'](p));}catch(p){console['error'](p['message'],p['stack']);}finally{if(g)try{d['waitUntil'](d1KvDelete(a['DB'],f)['catch'](q=>console['error'](q['message'])));}catch(q){console['error'](q['message']);}}}async function resolveProxyIP(a){const b=/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/,c=/^\[?([0-9a-fA-F:.]+)\]?$/;if(b['test'](a)||c['test'](a))return a;const d=[{'url':'https://cloudflare-dns.com/dns-query?name='+encodeURIComponent(a)+'&type=A','parse':f=>f['Answer']?.['find'](g=>g['type']===0x1)?.['data']},{'url':'https://dns.google/resolve?name='+encodeURIComponent(a)+'&type=A','parse':f=>f['Answer']?.['find'](g=>g['type']===0x1)?.['data']},{'url':'https://dns.quad9.net/dns-query?name='+encodeURIComponent(a)+'&type=A','parse':f=>f['Answer']?.['find'](g=>g['type']===0x1)?.['data']}];for(const f of d){try{const g=new AbortController(),h=setTimeout(()=>g['abort'](),0xbb8),i=await fetch(f['url'],{'headers':{'accept':'application/dns-json'},'signal':g['signal']});clearTimeout(h);if(i['ok']){const j=await i['json'](),k=f['parse'](j);if(k&&b['test'](k))return k;}}catch(l){}}return console['warn']('Failed\x20to\x20resolve\x20IP\x20for\x20'+a+'\x20after\x20trying\x20all\x20DNS\x20providers.\x20Using\x20original\x20hostname\x20as\x20fallback.'),a;}async function getGeo(a,b=null){if(b&&(b['city']||b['country']||b['asOrganization']))return{'city':b['city']||'','country':b['country']||'','isp':b['asOrganization']||''};const c=[{'url':'https://ip-api.com/json/'+a+'?fields=status,message,city,country,isp','parse':async d=>{const f=await d['json']();if(f['status']==='fail')throw new Error(f['message']||'API\x20Error');return{'city':f['city']||'','country':f['country']||'','isp':f['isp']||''};}},{'url':'https://ipapi.co/'+a+'/json/','parse':async d=>{const f=await d['json']();if(f['error'])throw new Error(f['reason']||'API\x20Error');return{'city':f['city']||'','country':f['country_name']||'','isp':f['org']||''};}},{'url':'https://ipwho.is/'+a,'parse':async d=>{const f=await d['json']();if(!f['success'])throw new Error('API\x20Error');return{'city':f['city']||'','country':f['country']||'','isp':f['connection']?.['isp']||''};}},{'url':'https://ipinfo.io/'+a+'/json','parse':async d=>{const f=await d['json']();if(f['bogon'])throw new Error('Bogon\x20IP');return{'city':f['city']||'','country':f['country']||'','isp':f['org']||''};}},{'url':'https://freeipapi.com/api/json/'+a,'parse':async d=>{const f=await d['json']();if(f['message'])throw new Error(f['message']);return{'city':f['cityName']||'','country':f['countryName']||'','isp':''};}}];for(const d of c){try{const f=new AbortController(),g=setTimeout(()=>f['abort'](),0xbb8),h=await fetch(d['url'],{'signal':f['signal'],'headers':{'Accept':'application/json'}});clearTimeout(g);if(h['ok']){const i=await d['parse'](h);if(i&&(i['city']||i['country']||i['isp']))return i;}}catch(j){}}return console['warn']('Failed\x20to\x20get\x20geo-location\x20for\x20IP\x20'+a+'\x20after\x20trying\x20all\x20providers.'),{'city':'Unknown','country':'Global','isp':'Unknown'};}function generateRandomPath(a=0xc){const b='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';let c='';for(let d=0x0;d<a;d++){c+=b['charAt'](Math['floor'](Math['random']()*b['length']));}return'/'+c;}const CORE_PRESETS={'xray':{'tls':{'path':()=>generateRandomPath(0xc),'security':'tls','fp':'chrome','alpn':'http/1.1','extra':{'ed':'2560'}},'tcp':{'path':()=>generateRandomPath(0xc),'security':'none','fp':'chrome','extra':{'ed':'2560'}}},'sb':{'tls':{'path':()=>generateRandomPath(0x12),'security':'tls','fp':'firefox','alpn':'h3','extra':CONST['ED_PARAMS']},'tcp':{'path':()=>generateRandomPath(0x12),'security':'none','fp':'firefox','extra':CONST['ED_PARAMS']}}};function makeName(a,b){return a+'-'+b['toUpperCase']();}function randomizeCase(a){if(!a)return a;let b='';for(let c=0x0;c<a['length'];c++){b+=Math['random']()<0.5?a[c]['toUpperCase']():a[c]['toLowerCase']();}return b;}function createVlessLink({userID:a,address:b,port:c,host:d,path:e,security:f,sni:g,fp:h,alpn:i,extra:extra={},name:j}){const l=new URLSearchParams({'encryption':'none','type':'ws','host':d,'path':e});f&&l['set']('security',f);if(g)l['set']('sni',g);if(h)l['set']('fp',h);if(i)l['set']('alpn',i);for(const [m,n]of Object['entries'](extra)){l['set'](m,n);}return'vless://'+a+'@'+b+':'+c+'?'+l['toString']()+'#'+encodeURIComponent(j);}function buildLink({core:a,proto:b,userID:c,hostName:d,address:e,port:f,tag:g}){const h=CORE_PRESETS[a]?.[b];if(!h)return console['error']('Invalid\x20core\x20or\x20protocol\x20preset\x20requested:\x20core='+a+',\x20proto='+b+'.\x20Falling\x20back\x20to\x20default\x20TLS\x20config.'),createVlessLink({'userID':c,'address':e,'port':f,'host':d,'path':generateRandomPath(0xc),'security':'tls','sni':d,'fp':'chrome','alpn':'http/1.1','name':makeName(g,'DEFAULT_TLS')});const i=h['security']==='tls'?randomizeCase(d):undefined;return createVlessLink({'userID':c,'address':e,'port':f,'host':d,'path':h['path'](),'security':h['security'],'sni':i,'fp':h['fp'],'alpn':h['alpn'],'extra':h['extra'],'name':makeName(g,b)});}const pick=a=>a[Math['floor'](Math['random']()*a['length'])];async function handleIpSubscription(a,b,c,d){const f=[c,'www.visa.com','www.wto.org','creativecommons.org','www.speedtest.net','sky.rethinkdns.com','cdnjs.com','zula.ir','go.inmobi.com','mail.tm','temp-mail.org','ipaddress.my','mdbmax.com','check-host.net','kodambroker.com','iplocation.io','whatismyip.org','www.linkedin.com','exir.io','arzex.io','ok-ex.io','arzdigital.com','pouyanit.com','auth.grok.com','grok.com','maxmind.com','whatsmyip.com','iplocation.net','ipchicken.com','showmyip.com','router-network.com','whatismyipaddress.com','www.apple.com','www.microsoft.com','www.amazon.com','www.cloudflare.com','www.google.com','github.com','gitlab.com','wikipedia.org','developer.mozilla.org','www.nginx.com','www.apache.org','telegram.org','bale.ai','ir.linkedin.com','divar.ir','snapp.ir','jiring.ir','shaparak.ir','pishgaman.net','asriran.com','varzesh3.com','isna.ir','farsnews.ir','mehrnews.com','tasnimnews.com']['sort'](()=>0.5-Math['random']()),g=[0x1bb,0x20fb,0x805,0x823,0x827,0x830,0x114e,0x114f,0x1150,0x1151,0x1152,0x1153,0x1154,0x1155,0x1156,0x1157],h=[0x50,0x1f90,0x22b0,0x804,0x822,0x826,0x82f,0x1f40,0x1f48,0x1f49,0x1f4a,0x1f4b,0x1f4c,0x1f4d,0x1f4e,0x1f4f];let i=[];const j=c['endsWith']('.pages.dev');f['slice'](0x0,0xf)['forEach']((n,o)=>{i['push'](buildLink({'core':a,'proto':'tls','userID':b,'hostName':c,'address':n,'port':pick(g),'tag':'D'+(o+0x1)+'-TLS-1'}),buildLink({'core':a,'proto':'tls','userID':b,'hostName':c,'address':n,'port':pick(g),'tag':'D'+(o+0x1)+'-TLS-2'})),!j&&i['push'](buildLink({'core':a,'proto':'tcp','userID':b,'hostName':c,'address':n,'port':pick(h),'tag':'D'+(o+0x1)+'-TCP-1'}),buildLink({'core':a,'proto':'tcp','userID':b,'hostName':c,'address':n,'port':pick(h),'tag':'D'+(o+0x1)+'-TCP-2'}));});let k=[];if(d['DB'])try{const {results:n}=await d['DB']['prepare']('SELECT\x20ip_port,\x20latency_ms\x20FROM\x20proxy_health\x20WHERE\x20is_healthy\x20=\x201\x20ORDER\x20BY\x20latency_ms\x20ASC\x20LIMIT\x2020')['all']();k=n['map'](o=>o['ip_port']['split'](':')[0x0]);}catch(o){console['error'](o['message']);}if(k['length']===0x0)try{const p=await fetch('https://raw.githubusercontent.com/NiREvil/vless/refs/heads/main/Cloudflare-IPs.json');if(p['ok']){const q=await p['json']();k=[...q['ipv4']||[],...q['ipv6']||[]]['slice'](0x0,0x1e)['map'](s=>s['ip']);}else console['warn']('Failed\x20to\x20fetch\x20Cloudflare\x20IPs:\x20HTTP\x20Status\x20'+p['status']);}catch(s){console['error'](s['message'],s['stack']);}k['slice'](0x0,0x14)['forEach']((t,u)=>{const v=t['includes'](':')?'['+t+']':t;i['push'](buildLink({'core':a,'proto':'tls','userID':b,'hostName':c,'address':v,'port':pick(g),'tag':'IP'+(u+0x1)+'-TLS-1'}),buildLink({'core':a,'proto':'tls','userID':b,'hostName':c,'address':v,'port':pick(g),'tag':'IP'+(u+0x1)+'-TLS-2'})),!j&&i['push'](buildLink({'core':a,'proto':'tcp','userID':b,'hostName':c,'address':v,'port':pick(h),'tag':'IP'+(u+0x1)+'-TCP-1'}),buildLink({'core':a,'proto':'tcp','userID':b,'hostName':c,'address':v,'port':pick(h),'tag':'IP'+(u+0x1)+'-TCP-2'}));});const l=Array['from'](new Set(i))['sort'](()=>0.5-Math['random']()),m=new Headers({'Content-Type':'text/plain;charset=utf-8','Profile-Update-Interval':'6','Cache-Control':'no-cache,\x20no-store,\x20must-revalidate','Pragma':'no-cache','Expires':'0'});return addSecurityHeaders(m,null,{}),new Response(safeBase64Encode(l['join']('\x0a')),{'headers':m});}