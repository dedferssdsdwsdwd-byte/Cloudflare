// <!--GAMFC-->version base on commit: 7514c14236c9437cd93629afb7f8ae0f99118752 - last update: 2025-12-22 01:15:58 UTC <!--GAMFC-END-->.

import{connect}from'cloudflare:sockets';function safeCloseWebSocket(a){try{a&&(a['readyState']===0x1||a['readyState']===0x0)&&a['close']();}catch(b){console['error']('Error\x20closing\x20WebSocket:',b);}}function isValidUUID(a){const b=/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;return b['test'](a);}function stringifyUUID(a){const b=[...a],c=d=>(d<0x10?'0':'')+d['toString'](0x10);return b['slice'](0x0,0x4)['map'](c)['join']('')+'-'+b['slice'](0x4,0x6)['map'](c)['join']('')+'-'+b['slice'](0x6,0x8)['map'](c)['join']('')+'-'+b['slice'](0x8,0xa)['map'](c)['join']('')+'-'+b['slice'](0xa)['map'](c)['join']('');}function base64ToArrayBuffer(a){if(!a)return{'earlyData':null,'error':null};try{a=a['replace'](/-/g,'+')['replace'](/_/g,'/');const b=atob(a),c=Uint8Array['from'](b,d=>d['charCodeAt'](0x0));return{'earlyData':c['buffer'],'error':null};}catch(d){return{'earlyData':null,'error':d};}}function generateNonce(){let a='';const b='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';for(let c=0x0;c<0x10;c++){a+=b['charAt'](Math['floor'](Math['random']()*b['length']));}return a;}const CONST={'VERSION':'3.2.0','HEALTH_CHECK_TIMEOUT':0x7d0,'DEFAULT_UUID':'d342d11e-d424-4583-b36e-524ab1f0afa4'},Config={'fromEnv'(a){return{'uuid':a['UUID']||CONST['DEFAULT_UUID'],'adminKey':a['ADMIN_KEY']||'admin','adminPath':a['ADMIN_PATH']||'admin','proxyIPs':(a['PROXYIP']||'')['split'](',')['filter'](Boolean)['map'](b=>b['trim']()),'enableLandingProxy':a['ENABLE_LANDING_PROXY']==='true','landingPageUrl':a['LANDING_PAGE_URL']||'https://www.google.com'};}},Database={async 'init'(a){if(!a['DB']){console['warn']('⚠️\x20D1\x20Database\x20(env.DB)\x20is\x20missing.\x20Skipping\x20DB\x20operations.');return;}const b=['CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20users\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20uuid\x20TEXT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20notes\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20traffic_limit\x20INTEGER,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20traffic_used\x20INTEGER\x20DEFAULT\x200,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20active\x20INTEGER\x20DEFAULT\x201,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20expiration_date\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20expiration_time\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20created_at\x20DATETIME\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)','CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20proxy_health\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20address\x20TEXT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20latency\x20INTEGER,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20is_healthy\x20INTEGER\x20DEFAULT\x201,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20last_check\x20DATETIME\x20DEFAULT\x20CURRENT_TIMESTAMP\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)'];try{const c=b['map'](f=>a['DB']['prepare'](f));await a['DB']['batch'](c);const d=await a['DB']['prepare']('SELECT\x20count(*)\x20as\x20count\x20FROM\x20users')['first']();if(d&&d['count']===0x0){const f=Config['fromEnv'](a);await a['DB']['prepare']('INSERT\x20INTO\x20users\x20(uuid,\x20notes,\x20traffic_limit)\x20VALUES\x20(?,\x20?,\x20?)')['bind'](f['uuid'],'Admin\x20User',0x0)['run'](),console['log']('Database\x20seeded\x20with\x20default\x20user.');}}catch(g){console['warn']('Database\x20initialization\x20warning\x20(non-fatal):',g['message']);}},async 'getUser'(a,b){if(!a['DB']){const c=Config['fromEnv'](a);if(b===c['uuid'])return{'uuid':c['uuid'],'notes':'Env\x20Superuser','traffic_limit':0x0,'traffic_used':0x0,'active':0x1};return null;}try{return await a['DB']['prepare']('SELECT\x20*\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](b)['first']();}catch(d){console['error']('DB\x20getUser\x20error:',d);const f=Config['fromEnv'](a);if(b===f['uuid'])return{'uuid':f['uuid'],'notes':'Fallback\x20User','active':0x1};return null;}},async 'getAllUsers'(a){if(!a['DB'])return[];try{const b=await a['DB']['prepare']('SELECT\x20*\x20FROM\x20users\x20ORDER\x20BY\x20created_at\x20DESC')['all']();return b['results']||[];}catch(c){return console['error']('DB\x20getAllUsers\x20error:',c),[];}},async 'updateUserTraffic'(a,b,c){if(!a['DB'])return;try{await a['DB']['prepare']('UPDATE\x20users\x20SET\x20traffic_used\x20=\x20traffic_used\x20+\x20?\x20WHERE\x20uuid\x20=\x20?')['bind'](c,b)['run']();}catch(d){}},async 'saveProxyHealth'(a,b,c,d){if(!a['DB'])return;try{await a['DB']['prepare']('INSERT\x20OR\x20REPLACE\x20INTO\x20proxy_health\x20(address,\x20latency,\x20is_healthy,\x20last_check)\x20VALUES\x20(?,\x20?,\x20?,\x20CURRENT_TIMESTAMP)')['bind'](b,c,d?0x1:0x0)['run']();}catch(f){console['error']('DB\x20saveProxyHealth\x20error:',f);}}};async function handleUDPOutbound(a,b,c){let d=![];const e=new TransformStream({'transform'(g,h){for(let i=0x0;i<g['byteLength'];){const j=g['slice'](i,i+0x2),k=new DataView(j)['getUint16'](0x0),l=new Uint8Array(g['slice'](i+0x2,i+0x2+k));i=i+0x2+k,h['enqueue'](l);}}});e['readable']['pipeTo'](new WritableStream({async 'write'(g){const h=await fetch('https://1.1.1.1/dns-query',{'method':'POST','headers':{'content-type':'application/dns-message'},'body':g}),i=await h['arrayBuffer'](),j=i['byteLength'],k=new Uint8Array([j>>0x8&0xff,j&0xff]);a['readyState']===0x1&&(d?a['send'](await new Blob([k,i])['arrayBuffer']()):(a['send'](await new Blob([b,k,i])['arrayBuffer']()),d=!![]));}}))['catch'](g=>{c('DNS\x20UDP\x20Pipe\x20Error:',g);});const f=e['writable']['getWriter']();return{'write':g=>f['write'](g)};}async function handleTCPOutbound(a,b,c,d,e,f,g,h,i,j){const k=connect({'hostname':b,'port':c});a['value']=k;const l=k['writable']['getWriter']();return await l['write'](d),l['releaseLock'](),k['readable']['pipeTo'](new WritableStream({async 'write'(m,n){i&&h['DB']&&j&&j['waitUntil'](Database['updateUserTraffic'](h,i,m['byteLength'])),e['readyState']===0x1&&(f?(e['send'](await new Blob([f,m])['arrayBuffer']()),f=null):e['send'](m));},'close'(){safeCloseWebSocket(e);},'abort'(m){console['error']('Remote\x20TCP\x20Aborted:',m),safeCloseWebSocket(e);}}))['catch'](m=>{console['error']('Remote\x20TCP\x20Pipe\x20Error:',m),safeCloseWebSocket(e);}),k;}async function parseVlessHeader(a){if(a['byteLength']<0x18)return{'hasError':!![],'message':'Invalid\x20data\x20length'};const b=new DataView(a),c=b['getUint8'](0x0),d=stringifyUUID(new Uint8Array(a['slice'](0x1,0x11))),e=b['getUint8'](0x11),f=b['getUint8'](0x12+e),g=f===0x2,h=0x13+e,i=b['getUint16'](h),j=h+0x2,k=b['getUint8'](j);let l=0x0,m=j+0x1,n='';if(k===0x1)l=0x4,n=new Uint8Array(a['slice'](m,m+l))['join']('.');else{if(k===0x2)l=b['getUint8'](m),m++,n=new TextDecoder()['decode'](a['slice'](m,m+l));else{if(k===0x3)l=0x10,n='['+Array['from'](new Uint16Array(a['slice'](m,m+l)))['map'](o=>o['toString'](0x10))['join'](':')+']';else return{'hasError':!![],'message':'Invalid\x20addressType:\x20'+k};}}if(!n)return{'hasError':!![],'message':'Address\x20is\x20empty'};return{'hasError':![],'addressRemote':n,'addressType':k,'portRemote':i,'rawDataIndex':m+l,'vlessVersion':new Uint8Array([c]),'isUDP':g,'uuid':d};}async function vlessOverWSHandler(a,b,c){const d=new WebSocketPair(),[e,f]=Object['values'](d);f['accept']();let g='',h='';const i=(q,r)=>console['log']('['+g+':'+h+']\x20'+q,r||''),j=a['headers']['get']('sec-websocket-protocol')||'',{earlyData:k,error:l}=base64ToArrayBuffer(j),m=new ReadableStream({'start'(q){f['addEventListener']('message',r=>{if(r['data'])q['enqueue'](r['data']);}),f['addEventListener']('close',()=>{safeCloseWebSocket(f),q['close']();}),f['addEventListener']('error',r=>{console['error']('WebSocket\x20Error:',r),q['error'](r);});if(l)q['error'](l);else k&&q['enqueue'](k);},'cancel'(q){safeCloseWebSocket(f);}});let n={'value':null},o=null,p=![];return m['pipeTo'](new WritableStream({async 'write'(q,r){if(p&&o)return o(q);if(n['value']){const B=n['value']['writable']['getWriter']();await B['write'](q),B['releaseLock']();return;}const {hasError:s,message:t,portRemote:u,addressRemote:v,rawDataIndex:w,vlessVersion:x,isUDP:y,uuid:z}=await parseVlessHeader(q);if(s){console['warn']('VLESS\x20Header\x20Error:',t),safeCloseWebSocket(f);return;}g=v,h=u+'--'+Math['random']()+'\x20'+(y?'udp':'tcp');const A=await Database['getUser'](b,z);if(!A){console['warn']('Unauthorized\x20Access\x20Attempt:\x20'+z),safeCloseWebSocket(f);return;}if(y){if(u===0x35){p=!![];const C=await handleUDPOutbound(f,new Uint8Array([x[0x0],0x0]),i);o=C['write'],o(q['slice'](w));return;}else{console['warn']('UDP\x20blocked:\x20Only\x20DNS\x20(53)\x20allowed'),safeCloseWebSocket(f);return;}}await handleTCPOutbound(n,v,u,q['slice'](w),f,new Uint8Array([x[0x0],0x0]),i,b,z,c);},'abort'(q){safeCloseWebSocket(f);}}))['catch'](q=>{console['error']('Readable\x20WebSocket\x20Pipe\x20Error:',q),safeCloseWebSocket(f);}),new Response(null,{'status':0x65,'webSocket':e});}const ASSETS={'CSS':':root\x20{\x20--bg:\x20#0f172a;\x20--card:\x20#1e293b;\x20--text:\x20#f8fafc;\x20--primary:\x20#3b82f6;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20body\x20{\x20font-family:\x20sans-serif;\x20background:\x20var(--bg);\x20color:\x20var(--text);\x20padding:\x2020px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.card\x20{\x20background:\x20var(--card);\x20padding:\x202rem;\x20border-radius:\x2012px;\x20box-shadow:\x200\x204px\x206px\x20rgba(0,0,0,0.1);\x20max-width:\x20600px;\x20margin:\x200\x20auto;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.btn\x20{\x20background:\x20var(--primary);\x20color:\x20white;\x20padding:\x2010px\x2020px;\x20border-radius:\x208px;\x20text-decoration:\x20none;\x20display:\x20inline-block;\x20margin-top:\x2010px;\x20border:none;\x20cursor:pointer;}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20input,\x20button\x20{\x20width:\x20100%;\x20padding:\x2010px;\x20margin-bottom:\x2010px;\x20border-radius:\x205px;\x20border:\x201px\x20solid\x20#333;\x20background:\x20#334155;\x20color:\x20white;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20table\x20{\x20width:\x20100%;\x20border-collapse:\x20collapse;\x20margin-top:\x2020px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20th,\x20td\x20{\x20padding:\x2010px;\x20text-align:\x20left;\x20border-bottom:\x201px\x20solid\x20#333;\x20}'},Subscriptions={'toClash'(a,b){if(!a||!a['uuid'])return'#\x20Error:\x20User\x20data\x20invalid';return'port:\x207890\x0asocks-port:\x207891\x0aredir-port:\x207892\x0amixed-port:\x207893\x0amode:\x20rule\x0alog-level:\x20info\x0aallow-lan:\x20true\x0aexternal-controller:\x200.0.0.0:9090\x0aproxies:\x0a\x20\x20-\x20name:\x20'+b+'\x0a\x20\x20\x20\x20server:\x20'+b+'\x0a\x20\x20\x20\x20port:\x20443\x0a\x20\x20\x20\x20type:\x20vless\x0a\x20\x20\x20\x20uuid:\x20'+a['uuid']+'\x0a\x20\x20\x20\x20cipher:\x20auto\x0a\x20\x20\x20\x20tls:\x20true\x0a\x20\x20\x20\x20udp:\x20true\x0a\x20\x20\x20\x20skip-cert-verify:\x20true\x0a\x20\x20\x20\x20network:\x20ws\x0a\x20\x20\x20\x20ws-opts:\x0a\x20\x20\x20\x20\x20\x20path:\x20/\x0a\x20\x20\x20\x20\x20\x20headers:\x0a\x20\x20\x20\x20\x20\x20\x20\x20Host:\x20'+b+'\x0aproxy-groups:\x0a\x20\x20-\x20name:\x20PROXY\x0a\x20\x20\x20\x20type:\x20select\x0a\x20\x20\x20\x20proxies:\x0a\x20\x20\x20\x20\x20\x20-\x20'+b+'\x0a\x20\x20\x20\x20\x20\x20-\x20DIRECT\x0arules:\x0a\x20\x20-\x20MATCH,PROXY';},'toSingbox'(a,b){if(!a||!a['uuid'])return JSON['stringify']({'error':'User\x20data\x20invalid'});return JSON['stringify']({'log':{'level':'info','timestamp':!![]},'inbounds':[{'type':'tun','tag':'tun-in','inet4_address':'172.19.0.1/30','auto_route':!![],'strict_route':!![]}],'outbounds':[{'type':'vless','tag':'proxy','server':b,'server_port':0x1bb,'uuid':a['uuid'],'flow':'','tls':{'enabled':!![],'server_name':b,'insecure':!![]},'transport':{'type':'ws','path':'/','headers':{'Host':b}}},{'type':'direct','tag':'direct'},{'type':'block','tag':'block'}],'route':{'rules':[{'outbound':'direct','ip_cidr':['geoip:private']},{'outbound':'proxy','port':[0x50,0x1bb]}]}},null,0x2);}};export default{async 'fetch'(a,b,c){try{if(!b['UUID'])return new Response('\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<html><body\x20style=\x22background:#111;color:#eee;font-family:sans-serif;text-align:center;padding:50px;\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h1>Setup\x20Required</h1>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>Please\x20add\x20<code>UUID</code>\x20to\x20your\x20Cloudflare\x20Worker\x20\x22Environment\x20Variables\x22.</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</body></html>',{'status':0x1f7,'headers':{'Content-Type':'text/html'}});const d=Config['fromEnv'](b);await Database['init'](b);const f=new URL(a['url']);if(a['headers']['get']('Upgrade')==='websocket')return await vlessOverWSHandler(a,b,c);if(f['pathname']==='/robots.txt')return new Response('User-agent:\x20*\x0aDisallow:\x20/',{'status':0xc8});if(f['pathname']['startsWith']('/'+d['adminPath'])){if(a['method']==='POST'&&f['pathname']==='/'+d['adminPath']){const j=await a['formData']();if(j['get']('password')===d['adminKey'])return new Response(null,{'status':0x12e,'headers':{'Set-Cookie':'auth_token='+d['adminKey']+';\x20Path=/;\x20HttpOnly;\x20Secure;\x20SameSite=Strict;\x20Max-Age=86400','Location':'/'+d['adminPath']}});return new Response('Invalid\x20Password',{'status':0x191});}const g=a['headers']['get']('Cookie')||'';if(!g['includes']('auth_token='+d['adminKey']))return new Response('<!DOCTYPE\x20html><html><head><style>'+ASSETS['CSS']+'</style></head><body>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22card\x22\x20style=\x22text-align:center\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h2>Login</h2>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<form\x20method=\x22POST\x22><input\x20type=\x22password\x22\x20name=\x22password\x22\x20placeholder=\x22Key\x22\x20required><button\x20type=\x22submit\x22\x20class=\x22btn\x22>Enter</button></form>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div></body></html>',{'headers':{'Content-Type':'text/html'}});const h=f['searchParams']['get']('action');if(h){if(h==='get_users'){const k=await Database['getAllUsers'](b);return new Response(JSON['stringify'](k),{'headers':{'Content-Type':'application/json'}});}if(h==='get_stats'){const l=await Database['getAllUsers'](b),m=l['length'],n=l['reduce']((o,p)=>o+(p['traffic_used']||0x0),0x0);return new Response(JSON['stringify']({'total':m,'traffic':n}),{'headers':{'Content-Type':'application/json'}});}if(h==='create_user'&&a['method']==='POST'){const o=await a['json'](),p=crypto['randomUUID']();if(b['DB'])await b['DB']['prepare']('INSERT\x20INTO\x20users\x20(uuid,\x20notes,\x20traffic_limit)\x20VALUES\x20(?,\x20?,\x20?)')['bind'](p,o['note'],0x0)['run']();return new Response(JSON['stringify']({'success':!![]}),{'headers':{'Content-Type':'application/json'}});}if(h==='delete_user'&&a['method']==='POST'){const q=await a['json']();if(b['DB'])await b['DB']['prepare']('DELETE\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](q['uuid'])['run']();return new Response(JSON['stringify']({'success':!![]}),{'headers':{'Content-Type':'application/json'}});}}const i=generateNonce();return new Response('<!DOCTYPE\x20html><html><head><title>Admin</title><style\x20nonce=\x22'+i+'\x22>'+ASSETS['CSS']+'</style></head><body>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22card\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h2>Dashboard</h2>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20style=\x22display:flex;gap:10px;margin-bottom:20px\x22><button\x20onclick=\x22loadUsers()\x22\x20class=\x22btn\x22>Refresh</button><button\x20onclick=\x22createUser()\x22\x20class=\x22btn\x22\x20style=\x22background:#10b981\x22>New\x20User</button></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20id=\x22stats\x22>Loading...</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20id=\x22list\x22></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<script\x20nonce=\x22'+i+'\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20async\x20function\x20loadUsers()\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20res\x20=\x20await\x20fetch(\x27?action=get_users\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20users\x20=\x20await\x20res.json();\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20statsRes\x20=\x20await\x20fetch(\x27?action=get_stats\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20stats\x20=\x20await\x20statsRes.json();\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27stats\x27).innerText\x20=\x20\x27Users:\x20\x27\x20+\x20stats.total\x20+\x20\x27\x20|\x20Traffic:\x20\x27\x20+\x20(stats.traffic/1e9).toFixed(2)\x20+\x20\x27\x20GB\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27list\x27).innerHTML\x20=\x20\x27<table><tr><th>User</th><th>UUID</th><th>Traffic</th><th>Action</th></tr>\x27\x20+\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20users.map(u\x20=>\x20\x27<tr><td>\x27\x20+\x20(u.notes||\x27-\x27)\x20+\x20\x27</td><td\x20style=\x22font-family:monospace;font-size:12px\x22>\x27\x20+\x20u.uuid\x20+\x20\x27</td><td>\x27\x20+\x20(u.traffic_used/1e9).toFixed(2)\x20+\x20\x27\x20GB</td><td><button\x20onclick=\x22del(\x5c\x27npm\x27+u.uuid+\x27\x5c\x27)\x22\x20style=\x22background:#ef4444;padding:5px;width:auto\x22>Del</button></td></tr>\x27).join(\x27\x27)\x20+\x20\x27</table>\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20async\x20function\x20createUser()\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20note\x20=\x20prompt(\x22User\x20Note:\x22);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if(note)\x20{\x20await\x20fetch(\x27?action=create_user\x27,\x20{method:\x27POST\x27,\x20body:JSON.stringify({note})});\x20loadUsers();\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20async\x20function\x20del(uuid)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if(confirm(\x22Delete?\x22))\x20{\x20await\x20fetch(\x27?action=delete_user\x27,\x20{method:\x27POST\x27,\x20body:JSON.stringify({uuid:\x20uuid.substring(3)})});\x20loadUsers();\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20loadUsers();\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</script></body></html>',{'headers':{'Content-Type':'text/html'}});}if(f['pathname']['startsWith']('/sub/')){const r=f['pathname']['split']('/')[0x2];if(!r||!isValidUUID(r))return new Response('Invalid\x20UUID',{'status':0x190});const s=await Database['getUser'](b,r);if(!s)return new Response('User\x20Not\x20Found',{'status':0x194});if(b['DB']&&c)c['waitUntil'](b['DB']['prepare']('UPDATE\x20users\x20SET\x20active\x20=\x201\x20WHERE\x20uuid\x20=\x20?')['bind'](r)['run']());const t=f['searchParams']['get']('format'),u=f['hostname'];if(t==='clash')return new Response(Subscriptions['toClash'](s,u),{'headers':{'Content-Type':'text/yaml','Content-Disposition':'attachment;\x20filename=\x22'+u+'.yaml\x22'}});if(t==='singbox')return new Response(Subscriptions['toSingbox'](s,u),{'headers':{'Content-Type':'application/json','Content-Disposition':'attachment;\x20filename=\x22'+u+'.json\x22'}});return new Response('<!DOCTYPE\x20html><html><head><title>Subscription</title><style>'+ASSETS['CSS']+'</style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<script\x20src=\x22https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js\x22></script></head><body>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22card\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h2>Hi,\x20'+(s['notes']||'User')+'</h2>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p>Usage:\x20'+(s['traffic_used']/0x40000000)['toFixed'](0x2)+'\x20GB</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20id=\x22qrcode\x22\x20style=\x22background:white;padding:10px;margin:20px\x20auto;width:fit-content\x22></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20onclick=\x22copyClash()\x22\x20class=\x22btn\x22>Copy\x20Clash\x20Config</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20onclick=\x22copyLink()\x22\x20class=\x22btn\x22\x20style=\x22background:#8b5cf6\x22>Copy\x20VLESS\x20Link</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<script>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20host\x20=\x20\x22'+u+'\x22;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20uuid\x20=\x20\x22'+s['uuid']+'\x22;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20link\x20=\x20\x22vless://\x22\x20+\x20uuid\x20+\x20\x22@\x22\x20+\x20host\x20+\x20\x22:443?encryption=none&security=tls&type=ws&host=\x22\x20+\x20host\x20+\x20\x22&path=%2F#\x22\x20+\x20host;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20new\x20QRCode(document.getElementById(\x22qrcode\x22),\x20{\x20text:\x20link,\x20width:\x20200,\x20height:\x20200\x20});\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20function\x20copyLink()\x20{\x20navigator.clipboard.writeText(link);\x20alert(\x22Copied!\x22);\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20function\x20copyClash()\x20{\x20window.location.href\x20=\x20location.href\x20+\x20\x22?format=clash\x22;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</script></body></html>',{'headers':{'Content-Type':'text/html'}});}if(d['enableLandingProxy'])try{const v=new URL(d['landingPageUrl']),w=new Request(v['origin']+f['pathname']+f['search'],{'method':a['method'],'headers':a['headers'],'body':a['body'],'redirect':'follow'});w['headers']['set']('Host',v['hostname']),w['headers']['set']('Referer',v['origin']);const x=await fetch(w),y=new Headers(x['headers']);return['content-security-policy','x-frame-options','x-xss-protection']['forEach'](z=>y['delete'](z)),new Response(x['body'],{'status':x['status'],'headers':y});}catch(z){console['error']('Landing\x20proxy\x20failed',z);}return new Response('404\x20Not\x20Found',{'status':0x194});}catch(A){return new Response('Internal\x20Worker\x20Error:\x0a'+A['message']+'\x0a'+A['stack'],{'status':0x1f4});}},async 'scheduled'(a,b,c){try{await Database['init'](b),b['DB']&&await b['DB']['prepare']('UPDATE\x20users\x20SET\x20active\x20=\x200\x20WHERE\x20active\x20=\x201\x20AND\x20expiration_date\x20IS\x20NOT\x20NULL\x20AND\x20datetime(expiration_date\x20||\x20\x27\x20\x27\x20||\x20COALESCE(expiration_time,\x20\x2700:00:00\x27))\x20<\x20datetime(\x27now\x27)')['run']();}catch(d){console['error']('Scheduled\x20Task\x20Error:',d);}}};