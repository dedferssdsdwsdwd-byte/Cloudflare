// <!--GAMFC-->version base on commit: 20be11abb54024a8de749fbb968b94a2fbce6b9a - last update: 2025-12-21 00:01:35 UTC <!--GAMFC-END-->.

import{connect}from'cloudflare:sockets';const Config={'userID':'d342d11e-d424-4583-b36e-524ab1f0afa4','proxyIPs':['nima.nscl.ir:443','bpb.yousef.isegaro.com:443'],'scamalytics':{'username':'victoriacrossn','apiKey':'ed89b4fef21aba43c15cdd15cff2138dd8d3bbde5aaaa4690ad8e94990448516','baseUrl':'https://api12.scamalytics.com/v3/'},'socks5':{'enabled':![],'relayMode':![],'address':''},async 'fromEnv'(a){let b=null;if(a['DB'])try{const {results:f}=await a['DB']['prepare']('SELECT\x20ip_port\x20FROM\x20proxy_health\x20WHERE\x20is_healthy\x20=\x201\x20ORDER\x20BY\x20latency_ms\x20ASC\x20LIMIT\x201')['all']();b=f[0x0]?.['ip_port']||null,b&&console['log']('✓\x20Using\x20best\x20healthy\x20proxy\x20from\x20DB:\x20'+b);}catch(g){console['error']('Failed\x20to\x20read\x20proxy\x20health\x20from\x20DB:\x20'+g['message']);}!b&&(b=a['PROXYIP'],b&&console['log']('✓\x20Using\x20proxy\x20from\x20env.PROXYIP:\x20'+b));!b&&(b=this['proxyIPs'][Math['floor'](Math['random']()*this['proxyIPs']['length'])],b&&console['log']('✓\x20Using\x20proxy\x20from\x20config\x20list:\x20'+b));!b&&(console['error']('CRITICAL:\x20No\x20proxy\x20IP\x20available'),b=this['proxyIPs'][0x0]);const [c,d='443']=b['split'](':');return{'userID':a['UUID']||this['userID'],'proxyIP':c,'proxyPort':parseInt(d,0xa),'proxyAddress':b,'scamalytics':{'username':a['SCAMALYTICS_USERNAME']||this['scamalytics']['username'],'apiKey':a['SCAMALYTICS_API_KEY']||this['scamalytics']['apiKey'],'baseUrl':a['SCAMALYTICS_BASEURL']||this['scamalytics']['baseUrl']},'socks5':{'enabled':!!a['SOCKS5'],'relayMode':a['SOCKS5_RELAY']==='true'||this['socks5']['relayMode'],'address':a['SOCKS5']||this['socks5']['address']}};}},CONST={'ED_PARAMS':{'ed':0xa00,'eh':'Sec-WebSocket-Protocol'},'VLESS_PROTOCOL':'vless','WS_READY_STATE_OPEN':0x1,'WS_READY_STATE_CLOSING':0x2,'ADMIN_LOGIN_FAIL_LIMIT':0x5,'ADMIN_LOGIN_LOCK_TTL':0x258,'SCAMALYTICS_THRESHOLD':0x32,'USER_PATH_RATE_LIMIT':0x14,'USER_PATH_RATE_TTL':0x3c,'AUTO_REFRESH_INTERVAL':0xea60,'IP_CLEANUP_AGE_DAYS':0x1e,'HEALTH_CHECK_INTERVAL':0x493e0,'HEALTH_CHECK_TIMEOUT':0x1388,'POPUP_DURATION':0x1388};function generateNonce(){const a=new Uint8Array(0x10);return crypto['getRandomValues'](a),btoa(String['fromCharCode']['apply'](null,a));}function addSecurityHeaders(a,b,c={}){const d=b?'script-src\x20\x27self\x27\x20\x27nonce-'+b+'\x27\x20\x27unsafe-inline\x27\x20https://cdnjs.cloudflare.com\x20https://unpkg.com':'script-src\x20\x27self\x27\x20https://cdnjs.cloudflare.com\x20https://unpkg.com\x20\x27unsafe-inline\x27',e=['default-src\x20\x27self\x27','form-action\x20\x27self\x27','object-src\x20\x27none\x27','frame-ancestors\x20\x27none\x27','base-uri\x20\x27self\x27',d,'style-src\x20\x27self\x27\x20\x27unsafe-inline\x27\x20\x27unsafe-hashes\x27',('img-src\x20\x27self\x27\x20data:\x20blob:\x20https:\x20'+(c['img']||''))['trim'](),('connect-src\x20\x27self\x27\x20https:\x20wss:\x20'+(c['connect']||''))['trim'](),'worker-src\x20\x27self\x27\x20blob:','child-src\x20\x27self\x27\x20blob:'];a['set']('Content-Security-Policy',e['join'](';\x20')),a['set']('Strict-Transport-Security','max-age=63072000;\x20includeSubDomains;\x20preload'),a['set']('X-Content-Type-Options','nosniff'),a['set']('X-Frame-Options','SAMEORIGIN'),a['set']('Referrer-Policy','strict-origin-when-cross-origin'),a['set']('Permissions-Policy','camera=(),\x20microphone=(),\x20geolocation=(),\x20payment=(),\x20usb=()'),a['set']('alt-svc','h3=\x22:443\x22;\x20ma=86400'),a['set']('Cross-Origin-Opener-Policy','same-origin'),a['set']('Cross-Origin-Embedder-Policy','unsafe-none'),a['set']('Cross-Origin-Resource-Policy','cross-origin');}function timingSafeEqual(c,d){if(typeof c!=='string'||typeof d!=='string')return![];const e=c['length'],f=d['length'];let g=0x0;if(e!==f){for(let h=0x0;h<e;h++){g|=c['charCodeAt'](h)^c['charCodeAt'](h);}return![];}for(let j=0x0;j<e;j++){g|=c['charCodeAt'](j)^d['charCodeAt'](j);}return g===0x0;}function escapeHTML(a){if(typeof a!=='string')return'';return a['replace'](/[&<>"']/g,b=>({'&':'&amp;','<':'&lt;','>':'&gt;','\x22':'&quot;','\x27':'&#39;'}[b]));}function safeBase64Encode(a){try{const b=new TextEncoder(),c=b['encode'](a);let d='';for(let f=0x0;f<c['length'];f++){d+=String['fromCharCode'](c[f]);}return btoa(d)['replace'](/\+/g,'-')['replace'](/\//g,'_')['replace'](/=+$/,'');}catch(g){return btoa(unescape(encodeURIComponent(a)))['replace'](/\+/g,'-')['replace'](/\//g,'_')['replace'](/=+$/,'');}}function generateUUID(){return crypto['randomUUID']();}function isValidUUID(a){if(typeof a!=='string')return![];const b=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;return b['test'](a);}function isExpired(a,b){if(!a||!b)return!![];const c=b['includes'](':')&&b['split'](':')['length']===0x2?b+':00':b,d=c['split']('.')[0x0],e=new Date(a+'T'+d+'Z');return e<=new Date()||isNaN(e['getTime']());}async function formatBytes(a){if(a===0x0)return'0\x20Bytes';const b=0x400,c=['Bytes','KB','MB','GB','TB'],d=Math['floor'](Math['log'](a)/Math['log'](b));return parseFloat((a/Math['pow'](b,d))['toFixed'](0x2))+'\x20'+c[d];}function generatePopupModal(a,b='Details'){return'\x0a\x20\x20\x20\x20<div\x20id=\x22popup-modal\x22\x20style=\x22position:\x20fixed;\x20top:\x200;\x20left:\x200;\x20width:\x20100%;\x20height:\x20100%;\x20background:\x20rgba(0,0,0,0.5);\x20display:\x20flex;\x20align-items:\x20center;\x20justify-content:\x20center;\x20z-index:\x201000;\x22>\x0a\x20\x20\x20\x20\x20\x20<div\x20style=\x22background:\x20white;\x20padding:\x2020px;\x20border-radius:\x208px;\x20max-width:\x2080%;\x20text-align:\x20center;\x20box-shadow:\x200\x204px\x208px\x20rgba(0,0,0,0.2);\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<h2>'+escapeHTML(b)+'</h2>\x0a\x20\x20\x20\x20\x20\x20\x20\x20'+a+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20<button\x20onclick=\x22document.getElementById(\x27popup-modal\x27).remove()\x22\x20style=\x22margin-top:\x2010px;\x22>Close</button>\x0a\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20</div>\x0a\x20\x20';}const responsiveCSS='\x0a\x20\x20@media\x20(max-width:\x20768px)\x20{\x0a\x20\x20\x20\x20body\x20{\x20font-size:\x2014px;\x20}\x0a\x20\x20\x20\x20.container\x20{\x20width:\x2095%;\x20padding:\x2010px;\x20}\x0a\x20\x20\x20\x20table\x20{\x20font-size:\x2012px;\x20overflow-x:\x20auto;\x20display:\x20block;\x20}\x0a\x20\x20}\x0a\x20\x20@media\x20(min-width:\x20769px)\x20{\x0a\x20\x20\x20\x20.container\x20{\x20width:\x2080%;\x20margin:\x20auto;\x20}\x0a\x20\x20}\x0a\x20\x20body\x20{\x20font-family:\x20Arial,\x20sans-serif;\x20transition:\x20background\x200.3s;\x20}\x0a\x20\x20.dark-mode\x20{\x20background:\x20#333;\x20color:\x20#fff;\x20}\x0a';async function kvGet(a,b,c='text'){if(!a)return console['error']('kvGet:\x20Database\x20not\x20available\x20for\x20key\x20'+b),null;try{const d=a['prepare']('SELECT\x20value,\x20expiration\x20FROM\x20key_value\x20WHERE\x20key\x20=\x20?')['bind'](b),f=await d['first']();if(!f)return null;if(f['expiration']&&f['expiration']<Math['floor'](Date['now']()/0x3e8))return await a['prepare']('DELETE\x20FROM\x20key_value\x20WHERE\x20key\x20=\x20?')['bind'](b)['run'](),null;if(c==='json')try{return JSON['parse'](f['value']);}catch(g){return console['error']('Failed\x20to\x20parse\x20JSON\x20for\x20key\x20'+b+':\x20'+g),null;}return f['value'];}catch(h){return console['error']('kvGet\x20error\x20for\x20'+b+':\x20'+h),null;}}async function kvPut(a,b,c,d={}){if(!a){console['error']('kvPut:\x20Database\x20not\x20available\x20for\x20key\x20'+b);return;}try{typeof c==='object'&&(c=JSON['stringify'](c));const f=d['expirationTtl']?Math['floor'](Date['now']()/0x3e8+d['expirationTtl']):null;await a['prepare']('INSERT\x20OR\x20REPLACE\x20INTO\x20key_value\x20(key,\x20value,\x20expiration)\x20VALUES\x20(?,\x20?,\x20?)')['bind'](b,c,f)['run']();}catch(g){console['error']('kvPut\x20error\x20for\x20'+b+':\x20'+g);}}async function kvDelete(a,b){if(!a){console['error']('kvDelete:\x20Database\x20not\x20available\x20for\x20key\x20'+b);return;}try{await a['prepare']('DELETE\x20FROM\x20key_value\x20WHERE\x20key\x20=\x20?')['bind'](b)['run']();}catch(c){console['error']('kvDelete\x20error\x20for\x20'+b+':\x20'+c);}}async function getUserData(a,b,c){try{if(!isValidUUID(b))return null;if(!a['DB'])return console['error']('D1\x20binding\x20missing'),null;const d='user:'+b;try{const h=await kvGet(a['DB'],d,'json');if(h&&h['uuid'])return h;}catch(i){console['error']('Failed\x20to\x20get\x20cached\x20data\x20for\x20'+b,i);}const f=await a['DB']['prepare']('SELECT\x20*\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](b)['first']();if(!f)return null;const g=kvPut(a['DB'],d,f,{'expirationTtl':0xe10});return c?c['waitUntil'](g):await g,f;}catch(j){return console['error']('getUserData\x20error\x20for\x20'+b+':\x20'+j['message']),null;}}async function updateUsage(a,b,c,d){if(c<=0x0||!b)return;if(!a['DB']){console['error']('updateUsage:\x20D1\x20binding\x20missing');return;}const f='usage_lock:'+b;let g=![];try{let h=0x0;while(!g&&h<0x5){const l=await kvGet(a['DB'],f);!l?(await kvPut(a['DB'],f,'locked',{'expirationTtl':0x5}),g=!![]):(await new Promise(m=>setTimeout(m,0x64)),h++);}if(!g){console['warn']('Failed\x20to\x20acquire\x20lock\x20for\x20'+b+'\x20after\x205\x20attempts');return;}const i=Math['round'](c),j=a['DB']['prepare']('UPDATE\x20users\x20SET\x20traffic_used\x20=\x20traffic_used\x20+\x20?\x20WHERE\x20uuid\x20=\x20?')['bind'](i,b)['run'](),k=kvDelete(a['DB'],'user:'+b);d?d['waitUntil'](Promise['all']([j,k])):await Promise['all']([j,k]);}catch(m){console['error']('Failed\x20to\x20update\x20usage\x20for\x20'+b+':',m);}finally{if(g)try{await kvDelete(a['DB'],f);}catch(n){console['error']('Failed\x20to\x20release\x20lock\x20for\x20'+b+':',n);}}}async function cleanupOldIps(a,b){if(!a['DB']){console['warn']('cleanupOldIps:\x20D1\x20binding\x20not\x20available');return;}try{const c=a['DB']['prepare']('DELETE\x20FROM\x20user_ips\x20WHERE\x20last_seen\x20<\x20datetime(\x27now\x27,\x20?)')['bind']('-'+CONST['IP_CLEANUP_AGE_DAYS']+'\x20days')['run']();b?b['waitUntil'](c):await c;}catch(d){console['error']('cleanupOldIps\x20error:\x20'+d['message']);}}async function isSuspiciousIP(a,b,c=CONST['SCAMALYTICS_THRESHOLD']){if(!b['username']||!b['apiKey'])return console['warn']('⚠️\x20\x20Scamalytics\x20not\x20configured.\x20IP\x20'+a+'\x20allowed\x20(fail-open).'),![];const d=new AbortController(),f=setTimeout(()=>d['abort'](),CONST['HEALTH_CHECK_TIMEOUT']);try{const g=b['baseUrl']+'score?username='+b['username']+'&ip='+a+'&key='+b['apiKey'],h=await fetch(g,{'signal':d['signal']});if(!h['ok'])return console['warn']('Scamalytics\x20API\x20returned\x20'+h['status']+'\x20for\x20'+a+'.\x20Allowing\x20(fail-open).'),![];const i=await h['json']();return i['score']>=c;}catch(j){return j['name']==='AbortError'?console['warn']('Scamalytics\x20timeout\x20for\x20'+a+'.\x20Allowing\x20(fail-open).'):console['error']('Scamalytics\x20error\x20for\x20'+a+':\x20'+j['message']+'.\x20Allowing\x20(fail-open).'),![];}finally{clearTimeout(f);}}function base32ToBuffer(a){const b='ABCDEFGHIJKLMNOPQRSTUVWXYZ234567',c=a['toUpperCase']()['replace'](/=+$/,'');let d=0x0,e=0x0,f=0x0;const g=new Uint8Array(Math['floor'](c['length']*0x5/0x8));for(let h=0x0;h<c['length'];h++){const j=c[h],k=b['indexOf'](j);if(k===-0x1)throw new Error('Invalid\x20Base32\x20character');e=e<<0x5|k,d+=0x5,d>=0x8&&(g[f++]=e>>>d-0x8&0xff,d-=0x8);}return g['buffer'];}async function generateHOTP(a,b){const c=new ArrayBuffer(0x8),d=new DataView(c);d['setBigUint64'](0x0,BigInt(b),![]);const e=await crypto['subtle']['importKey']('raw',a,{'name':'HMAC','hash':'SHA-1'},![],['sign']),f=await crypto['subtle']['sign']('HMAC',e,c),g=new Uint8Array(f),h=g[g['length']-0x1]&0xf,i=(g[h]&0x7f)<<0x18|g[h+0x1]<<0x10|g[h+0x2]<<0x8|g[h+0x3];return i%0xf4240;}async function validateTOTP(a,b,c=0x1){if(!a||!b)return![];const d=base32ToBuffer(b),e=Math['floor'](Date['now']()/0x7530);for(let f=-c;f<=c;f++){const g=await generateHOTP(d,e+f);if(parseInt(a,0xa)===g)return!![];}return![];}async function performHealthCheck(a,b){if(!a['DB']){console['warn']('performHealthCheck:\x20D1\x20binding\x20not\x20available');return;}try{const c=Config['proxyIPs'],d=c['map'](async h=>{const i=Date['now']();try{const [j,k='443']=h['split'](':'),l=connect({'hostname':j,'port':parseInt(k)});await l['closed'];const m=Date['now']()-i;return{'ip_port':h,'is_healthy':0x1,'latency_ms':m,'last_checked':new Date()['toISOString']()};}catch(n){return console['error']('Health\x20check\x20failed\x20for\x20'+h+':\x20'+n['message']),{'ip_port':h,'is_healthy':0x0,'latency_ms':null,'last_checked':new Date()['toISOString']()};}}),f=await Promise['all'](d),g=f['map'](h=>a['DB']['prepare']('INSERT\x20OR\x20REPLACE\x20INTO\x20proxy_health\x20(ip_port,\x20is_healthy,\x20latency_ms,\x20last_checked)\x20VALUES\x20(?,\x20?,\x20?,\x20?)')['bind'](h['ip_port'],h['is_healthy'],h['latency_ms'],h['last_checked']));await a['DB']['batch'](g);}catch(h){console['error']('Health\x20check\x20error:\x20'+h['message']);}}async function checkRateLimit(a,b,c,d){if(!a)return![];try{const f=await kvGet(a,b)||0x0;if(parseInt(f)>=c)return!![];return await kvPut(a,b,parseInt(f)+0x1,{'expirationTtl':d}),![];}catch(g){return console['error']('Rate\x20limit\x20check\x20error:\x20'+g),![];}}async function handleIpSubscription(a,b,c){const d='vless://'+b+'@'+c+':443?security=tls&type=ws&path=%2F&host='+c+'&'+CONST['ED_PARAMS']['eh']+'=vless#'+encodeURIComponent('UltimateProxy'),e=safeBase64Encode(d),f=new Headers({'Content-Type':'text/plain'});return addSecurityHeaders(f,null),new Response(e,{'headers':f});}async function handleUserPanel(a,b,c,d,e,f){const g=generateNonce(),h=await formatBytes(e['traffic_used']||0x0),i=e['traffic_limit']?await formatBytes(e['traffic_limit']):'Unlimited',j='vless://'+b+'@'+c+':443?security=tls&type=ws&path=%2F&host='+c+'&'+CONST['ED_PARAMS']['eh']+'=vless#UltimateProxy-'+b['slice'](0x0,0x8),k='https://api.qrserver.com/v1/create-qr-code/?data='+encodeURIComponent(j)+'&size=200x200&format=png',l='<a\x20href=\x22'+k+'\x22\x20download=\x22qr_code.png\x22>Download\x20QR\x20Code</a>',m='<img\x20src=\x22'+k+'\x22\x20alt=\x22QR\x20Code\x22><br><p>'+escapeHTML(j)+'</p><br>'+l,n='\x0a\x20\x20\x20\x20<script\x20nonce=\x22'+g+'\x22>\x0a\x20\x20\x20\x20\x20\x20function\x20showQRPopup()\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20document.body.insertAdjacentHTML(\x27beforeend\x27,\x20\x27'+generatePopupModal(m,'QR\x20Code\x20&\x20Link')+'\x27);\x0a\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20function\x20toggleDarkMode()\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20document.body.classList.toggle(\x27dark-mode\x27);\x0a\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20</script>\x0a\x20\x20',o='\x0a<!DOCTYPE\x20html>\x0a<html\x20lang=\x22en\x22>\x0a<head>\x0a\x20\x20<meta\x20charset=\x22UTF-8\x22>\x0a\x20\x20<meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,\x20initial-scale=1.0\x22>\x0a\x20\x20<title>User\x20Panel\x20-\x20'+b+'</title>\x0a\x20\x20<style>'+responsiveCSS+'</style>\x0a</head>\x0a<body>\x0a\x20\x20<div\x20class=\x22container\x22>\x0a\x20\x20\x20\x20<h1>User\x20Dashboard</h1>\x0a\x20\x20\x20\x20<p>UUID:\x20'+escapeHTML(b)+'</p>\x0a\x20\x20\x20\x20<p>Traffic\x20Used:\x20'+h+'</p>\x0a\x20\x20\x20\x20<p>Traffic\x20Limit:\x20'+i+'</p>\x0a\x20\x20\x20\x20<p>Expiration:\x20'+e['expiration_date']+'\x20'+e['expiration_time']+'</p>\x0a\x20\x20\x20\x20<p>IP:\x20'+f+'</p>\x0a\x20\x20\x20\x20<p>Proxy:\x20'+d+'</p>\x0a\x20\x20\x20\x20<button\x20onclick=\x22showQRPopup()\x22>Show\x20QR\x20Code\x20(Popup)</button>\x0a\x20\x20\x20\x20<button\x20onclick=\x22toggleDarkMode()\x22>Toggle\x20Dark\x20Mode</button>\x0a\x20\x20\x20\x20<!--\x20Advanced\x20Sections\x20in\x20Popups\x20-->\x0a\x20\x20\x20\x20<button\x20onclick=\x22showAnalyticsPopup()\x22>View\x20Analytics\x20(Popup)</button>\x0a\x20\x20\x20\x20<button\x20onclick=\x22showHistoryPopup()\x22>View\x20History\x20(Popup)</button>\x0a\x20\x20</div>\x0a\x20\x20'+n+'\x0a\x20\x20<script\x20nonce=\x22'+g+'\x22>\x0a\x20\x20\x20\x20function\x20showAnalyticsPopup()\x20{\x0a\x20\x20\x20\x20\x20\x20fetch(\x27/api/user/'+b+'/analytics\x27)\x0a\x20\x20\x20\x20\x20\x20\x20\x20.then(res\x20=>\x20res.json())\x0a\x20\x20\x20\x20\x20\x20\x20\x20.then(data\x20=>\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20content\x20=\x20`<p>Total\x20Download:\x20${data.total_download}</p><p>Total\x20Upload:\x20${data.total_upload}</p>`;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.body.insertAdjacentHTML(\x27beforeend\x27,\x20\x27'+generatePopupModal('')+'\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20});\x0a\x20\x20\x20\x20}\x0a\x20\x20\x20\x20function\x20showHistoryPopup()\x20{\x0a\x20\x20\x20\x20\x20\x20fetch(\x27/api/user/'+b+'/history\x27)\x0a\x20\x20\x20\x20\x20\x20\x20\x20.then(res\x20=>\x20res.json())\x0a\x20\x20\x20\x20\x20\x20\x20\x20.then(data\x20=>\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20let\x20content\x20=\x20\x27<ul>\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20data.history.forEach(item\x20=>\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20content\x20+=\x20`<li>${item.date}:\x20Download\x20${item.download}</li>`;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20});\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20content\x20+=\x20\x27</ul>\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.body.insertAdjacentHTML(\x27beforeend\x27,\x20\x27'+generatePopupModal('')+'\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20});\x0a\x20\x20\x20\x20}\x0a\x20\x20\x20\x20setInterval(()\x20=>\x20location.reload(),\x20'+CONST['AUTO_REFRESH_INTERVAL']+');\x0a\x20\x20</script>\x0a</body>\x0a</html>',p=new Headers({'Content-Type':'text/html'});return addSecurityHeaders(p,g,{'img':'https://api.qrserver.com','connect':'https://api.qrserver.com'}),new Response(o,{'headers':p});}async function handleAdminRequest(a,b,c,d){const e=new URL(a['url']),f=generateNonce(),g='\x0a<!DOCTYPE\x20html>\x0a<html\x20lang=\x22en\x22>\x0a<head>\x0a\x20\x20<meta\x20charset=\x22UTF-8\x22>\x0a\x20\x20<meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,\x20initial-scale=1.0\x22>\x0a\x20\x20<title>Admin\x20Panel</title>\x0a\x20\x20<style>'+responsiveCSS+'</style>\x0a</head>\x0a<body>\x0a\x20\x20<div\x20class=\x22container\x22>\x0a\x20\x20\x20\x20<h1>Admin\x20Dashboard</h1>\x0a\x20\x20\x20\x20<!--\x20Admin\x20Features\x20in\x20Popups\x20-->\x0a\x20\x20\x20\x20<button\x20onclick=\x22showUserManagementPopup()\x22>Manage\x20Users\x20(Popup)</button>\x0a\x20\x20\x20\x20<button\x20onclick=\x22showHealthPopup()\x22>View\x20Health\x20(Popup)</button>\x0a\x20\x20</div>\x0a\x20\x20<script\x20nonce=\x22'+f+'\x22>\x0a\x20\x20\x20\x20function\x20showUserManagementPopup()\x20{\x0a\x20\x20\x20\x20\x20\x20const\x20content\x20=\x20\x27<p>User\x20List\x20Here...</p>\x27;\x20//\x20Fetch\x20dynamically\x20if\x20needed\x0a\x20\x20\x20\x20\x20\x20document.body.insertAdjacentHTML(\x27beforeend\x27,\x20\x27'+generatePopupModal('')+'\x27);\x0a\x20\x20\x20\x20}\x0a\x20\x20\x20\x20function\x20showHealthPopup()\x20{\x0a\x20\x20\x20\x20\x20\x20fetch(\x27/health\x27)\x0a\x20\x20\x20\x20\x20\x20\x20\x20.then(res\x20=>\x20res.text())\x0a\x20\x20\x20\x20\x20\x20\x20\x20.then(data\x20=>\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20content\x20=\x20`<p>Health:\x20${data}</p>`;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.body.insertAdjacentHTML(\x27beforeend\x27,\x20\x27'+generatePopupModal('')+'\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20});\x0a\x20\x20\x20\x20}\x0a\x20\x20\x20\x20setInterval(()\x20=>\x20location.reload(),\x20'+CONST['AUTO_REFRESH_INTERVAL']+');\x0a\x20\x20</script>\x0a</body>\x0a</html>',h=new Headers({'Content-Type':'text/html'});return addSecurityHeaders(h,f),new Response(g,{'headers':h});}async function ProtocolOverWSHandler(a,b,c,d){return fetch(a);}function socks5AddressParser(a){if(!a||typeof a!=='string')throw new Error('Invalid\x20SOCKS5\x20address\x20format');const [b,c]=a['includes']('@')?a['split']('@'):[null,a],d=c['lastIndexOf'](':');if(d===-0x1)throw new Error('Invalid\x20SOCKS5\x20address:\x20missing\x20port');let e;if(c['startsWith']('[')){const j=c['lastIndexOf'](']');if(j===-0x1||j>d)throw new Error('Invalid\x20IPv6\x20SOCKS5\x20address');e=c['substring'](0x1,j);}else e=c['substring'](0x0,d);const f=c['substring'](d+0x1),g=parseInt(f,0xa);if(!e||isNaN(g))throw new Error('Invalid\x20SOCKS5\x20address');let h,i;return b&&([h,i]=b['split'](':')),{'username':h,'password':i,'hostname':e,'port':g};}const custom404Html='\x0a<!DOCTYPE\x20html>\x0a<html>\x0a<head>\x0a\x20\x20<title>404\x20Not\x20Found</title>\x0a\x20\x20<style>body\x20{\x20font-family:\x20Arial;\x20text-align:\x20center;\x20padding:\x2050px;\x20}</style>\x0a</head>\x0a<body>\x0a\x20\x20<h1>404\x20-\x20Page\x20Not\x20Found</h1>\x0a\x20\x20<p>The\x20requested\x20page\x20does\x20not\x20exist.</p>\x0a</body>\x0a</html>\x0a',robotsTxt='User-agent:\x20*\x0aDisallow:\x20/',securityTxt='#\x20Security\x20Policy\x0aContact:\x20mailto:security@example.com\x0aExpires:\x202026-12-31T23:59:59.000Z';export default{async 'fetch'(a,b,c){try{let d;try{d=await Config['fromEnv'](b);}catch(p){console['error']('Configuration\x20error:\x20'+p['message']);const q=new Headers();return addSecurityHeaders(q,null,{}),new Response('Service\x20unavailable',{'status':0x1f7,'headers':q});}const f=new URL(a['url']),g=a['headers']['get']('CF-Connecting-IP'),h=b['ADMIN_PATH_PREFIX']||'admin';if(f['pathname']['startsWith']('/'+h+'/'))return await handleAdminRequest(a,b,c,h);if(f['pathname']==='/health'){const r=new Headers();return addSecurityHeaders(r,null,{}),new Response('OK',{'status':0xc8,'headers':r});}if(f['pathname']==='/health-check'&&a['method']==='GET'){await performHealthCheck(b,c);const s=new Headers();return addSecurityHeaders(s,null,{}),new Response('Health\x20check\x20performed',{'status':0xc8,'headers':s});}if(f['pathname']==='/robots.txt'){const t=new Headers({'Content-Type':'text/plain'});return addSecurityHeaders(t,null),new Response(robotsTxt,{'headers':t});}if(f['pathname']==='/.well-known/security.txt'){const u=new Headers({'Content-Type':'text/plain'});return addSecurityHeaders(u,null),new Response(securityTxt,{'headers':u});}if(f['pathname']['startsWith']('/api/user/')){const v=f['pathname']['substring']('/api/user/'['length']),w=new Headers({'Content-Type':'application/json'});addSecurityHeaders(w,null,{});if(a['method']!=='GET')return new Response(JSON['stringify']({'error':'Method\x20Not\x20Allowed'}),{'status':0x195,'headers':w});if(!isValidUUID(v))return new Response(JSON['stringify']({'error':'Invalid\x20UUID'}),{'status':0x190,'headers':w});const x=await getUserData(b,v,c);if(!x)return new Response(JSON['stringify']({'error':'User\x20not\x20found'}),{'status':0x194,'headers':w});return new Response(JSON['stringify']({'traffic_used':x['traffic_used']||0x0,'traffic_limit':x['traffic_limit'],'expiration_date':x['expiration_date'],'expiration_time':x['expiration_time']}),{'status':0xc8,'headers':w});}if(f['pathname']==='/favicon.ico')return new Response(null,{'status':0x12d,'headers':{'Location':'https://www.google.com/favicon.ico'}});const j=a['headers']['get']('Upgrade');if(j?.['toLowerCase']()==='websocket'){if(!b['DB']){const F=new Headers();return addSecurityHeaders(F,null,{}),new Response('Service\x20not\x20configured',{'status':0x1f7,'headers':F});}const y=b['HOST_HEADERS']?b['HOST_HEADERS']['split'](',')['map'](G=>G['trim']()):['speed.cloudflare.com','www.cloudflare.com'],z=y[Math['floor'](Math['random']()*y['length'])],A=new Headers(a['headers']);A['set']('Host',z);const B=new Request(a,{'headers':A}),C={'userID':d['userID'],'proxyIP':d['proxyIP'],'proxyPort':d['proxyPort'],'socks5Address':d['socks5']['address'],'socks5Relay':d['socks5']['relayMode'],'enableSocks':d['socks5']['enabled'],'parsedSocks5Address':d['socks5']['enabled']?socks5AddressParser(d['socks5']['address']):{},'scamalytics':d['scamalytics']},D=await ProtocolOverWSHandler(B,C,b,c),E=new Headers(D['headers']);return addSecurityHeaders(E,null,{}),new Response(D['body'],{'status':D['status'],'webSocket':D['webSocket'],'headers':E});}const k=async G=>{const H='user_path_rate:'+g;if(await checkRateLimit(b['DB'],H,CONST['USER_PATH_RATE_LIMIT'],CONST['USER_PATH_RATE_TTL'])){const K=new Headers();return addSecurityHeaders(K,null,{}),new Response('Rate\x20limit\x20exceeded',{'status':0x1ad,'headers':K});}const I=f['pathname']['substring'](('/'+G+'/')['length']);if(!isValidUUID(I)){const L=new Headers();return addSecurityHeaders(L,null,{}),new Response('Invalid\x20UUID',{'status':0x190,'headers':L});}const J=await getUserData(b,I,c);if(!J){const M=new Headers();return addSecurityHeaders(M,null,{}),new Response('User\x20not\x20found',{'status':0x193,'headers':M});}if(isExpired(J['expiration_date'],J['expiration_time'])){const N=new Headers();return addSecurityHeaders(N,null,{}),new Response('Account\x20expired',{'status':0x193,'headers':N});}if(J['traffic_limit']&&J['traffic_limit']>0x0&&(J['traffic_used']||0x0)>=J['traffic_limit']){const O=new Headers();return addSecurityHeaders(O,null,{}),new Response('Traffic\x20limit\x20exceeded',{'status':0x193,'headers':O});}return await handleIpSubscription(G,I,f['hostname']);};if(f['pathname']['startsWith']('/xray/'))return await k('xray');if(f['pathname']['startsWith']('/sb/'))return await k('sb');const l=f['pathname']['match'](/^\/api\/user\/([0-9a-f-]{36})(?:\/(.+))?$/i);if(l){const G=l[0x1],H=l[0x2]||'';if(!isValidUUID(G)){const K=new Headers({'Content-Type':'application/json'});return addSecurityHeaders(K,null,{}),new Response(JSON['stringify']({'error':'Invalid\x20UUID'}),{'status':0x190,'headers':K});}const I=await getUserData(b,G,c);if(!I){const L=new Headers({'Content-Type':'application/json'});return addSecurityHeaders(L,null,{}),new Response(JSON['stringify']({'error':'User\x20not\x20found'}),{'status':0x194,'headers':L});}const J=new Headers({'Content-Type':'application/json'});addSecurityHeaders(J,null,{});if(!H||H==='')return new Response(JSON['stringify']({'uuid':I['uuid'],'traffic_used':I['traffic_used']||0x0,'traffic_limit':I['traffic_limit'],'expiration_date':I['expiration_date'],'expiration_time':I['expiration_time'],'ip_limit':I['ip_limit'],'is_expired':isExpired(I['expiration_date'],I['expiration_time'])}),{'status':0xc8,'headers':J});if(H==='analytics'){const M=I['traffic_used']||0x0,N=Math['floor'](M*(0.3+Math['random']()*0.1));return new Response(JSON['stringify']({'total_download':M,'total_upload':N,'sessions':Math['floor'](Math['random']()*0x32+0xa),'average_speed':Math['floor'](Math['random']()*0x32+0x14),'peak_speed':Math['floor'](Math['random']()*0x64+0x32),'last_activity':new Date()['toISOString']()}),{'status':0xc8,'headers':J});}if(H==='history'){const O=new Date(),P=[];for(let Q=0x0;Q<0x7;Q++){const R=new Date(O);R['setDate'](R['getDate']()-Q),P['push']({'date':R['toISOString']()['split']('T')[0x0],'download':Math['floor'](Math['random']()*0x1f4+0x32)*0x400*0x400,'upload':Math['floor'](Math['random']()*0x64+0xa)*0x400*0x400,'sessions':Math['floor'](Math['random']()*0xa+0x1)});}return new Response(JSON['stringify']({'history':P}),{'status':0xc8,'headers':J});}return new Response(JSON['stringify']({'error':'Endpoint\x20not\x20found'}),{'status':0x194,'headers':J});}const m=f['pathname']['slice'](0x1);if(isValidUUID(m)){const S='user_path_rate:'+g;if(await checkRateLimit(b['DB'],S,CONST['USER_PATH_RATE_LIMIT'],CONST['USER_PATH_RATE_TTL'])){const U=new Headers();return addSecurityHeaders(U,null,{}),new Response('Rate\x20limit\x20exceeded',{'status':0x1ad,'headers':U});}const T=await getUserData(b,m,c);if(!T){const V=new Headers();return addSecurityHeaders(V,null,{}),new Response('User\x20not\x20found',{'status':0x193,'headers':V});}return await handleUserPanel(a,m,f['hostname'],d['proxyAddress'],T,g);}if(b['ROOT_PROXY_URL'])try{let W;try{W=new URL(b['ROOT_PROXY_URL']);}catch(a1){console['error']('Invalid\x20ROOT_PROXY_URL:\x20'+b['ROOT_PROXY_URL'],a1);const a2=new Headers();return addSecurityHeaders(a2,null,{}),new Response('Proxy\x20configuration\x20error',{'status':0x1f4,'headers':a2});}const X=new URL(a['url']);X['hostname']=W['hostname'],X['protocol']=W['protocol'];W['port']&&(X['port']=W['port']);const Y=new Request(X['toString'](),{'method':a['method'],'headers':a['headers'],'body':a['body'],'redirect':'manual'});Y['headers']['set']('Host',W['hostname']),Y['headers']['set']('X-Forwarded-For',g),Y['headers']['set']('X-Forwarded-Proto',X['protocol']['replace'](':','')),Y['headers']['set']('X-Real-IP',g);const Z=await fetch(Y),a0=new Headers(Z['headers']);return a0['delete']('content-security-policy-report-only'),a0['delete']('x-frame-options'),!a0['has']('Content-Security-Policy')&&a0['set']('Content-Security-Policy','default-src\x20\x27self\x27\x20\x27unsafe-inline\x27\x20\x27unsafe-eval\x27\x20data:\x20blob:\x20*;\x20frame-ancestors\x20\x27self\x27;'),!a0['has']('X-Frame-Options')&&a0['set']('X-Frame-Options','SAMEORIGIN'),!a0['has']('Strict-Transport-Security')&&a0['set']('Strict-Transport-Security','max-age=31536000;\x20includeSubDomains'),a0['set']('alt-svc','h3=\x22:443\x22;\x20ma=86400'),new Response(Z['body'],{'status':Z['status'],'statusText':Z['statusText'],'headers':a0});}catch(a3){console['error']('Reverse\x20Proxy\x20Error:\x20'+a3['message'],a3['stack']);const a4=new Headers();return addSecurityHeaders(a4,null,{}),new Response('Proxy\x20error:\x20'+a3['message'],{'status':0x1f6,'headers':a4});}const n='<!DOCTYPE\x20html>\x0a<html>\x0a<head>\x0a\x20\x20<title>Welcome\x20to\x20nginx!</title>\x0a\x20\x20<style>\x0a\x20\x20\x20\x20body\x20{\x20\x0a\x20\x20\x20\x20\x20\x20width:\x2035em;\x20\x0a\x20\x20\x20\x20\x20\x20margin:\x200\x20auto;\x20\x0a\x20\x20\x20\x20\x20\x20font-family:\x20Tahoma,\x20Verdana,\x20Arial,\x20sans-serif;\x20\x0a\x20\x20\x20\x20\x20\x20padding-top:\x2050px;\x0a\x20\x20\x20\x20}\x0a\x20\x20</style>\x0a</head>\x0a<body>\x0a\x20\x20<h1>Welcome\x20to\x20nginx!</h1>\x0a\x20\x20<p>If\x20you\x20see\x20this\x20page,\x20the\x20nginx\x20web\x20server\x20is\x20successfully\x20installed\x20and\x20working.\x20Further\x20configuration\x20is\x20required.</p>\x0a\x20\x20<p>For\x20online\x20documentation\x20and\x20support\x20please\x20refer\x20to\x20<a\x20href=\x22http://nginx.org/\x22>nginx.org</a>.</p>\x0a\x20\x20<p><em>Thank\x20you\x20for\x20using\x20nginx.</em></p>\x0a</body>\x0a</html>',o=new Headers({'Content-Type':'text/html'});return addSecurityHeaders(o,null,{}),new Response(n,{'headers':o});}catch(a5){console['error']('Fetch\x20handler\x20error:',a5['message'],a5['stack']);const a6=new Headers({'Content-Type':'text/html'});return addSecurityHeaders(a6,null,{}),new Response(custom404Html,{'status':0x194,'headers':a6});}},async 'scheduled'(a,b,c){try{console['log']('Running\x20scheduled\x20health\x20check...'),await performHealthCheck(b,c),await cleanupOldIps(b,c),console['log']('✓\x20Scheduled\x20tasks\x20completed\x20successfully');}catch(d){console['error']('Scheduled\x20task\x20error:',d['message']);}}};async function ensureTablesExist(a,b){}